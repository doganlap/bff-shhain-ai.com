generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Assessment {
  id        String     @id
  status    String     @default("Pending")
  result    String?
  controlId String
  riskId    String?
  createdAt DateTime   @default(now())
  updatedAt DateTime
  Control   Control    @relation(fields: [controlId], references: [id])
  Risk      Risk?      @relation(fields: [riskId], references: [id])
  Evidence  Evidence[]
}

model AuditLog {
  id        String   @id
  action    String
  resource  String
  details   Json?
  userId    String
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id])
}

model Control {
  id          String       @id
  controlId   String
  description String
  family      String?
  frameworkId String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  Assessment  Assessment[]
  Framework   Framework    @relation(fields: [frameworkId], references: [id])
}

model Evidence {
  id           String     @id
  name         String
  fileUrl      String
  fileType     String
  assessmentId String
  uploadedBy   String
  createdAt    DateTime   @default(now())
  Assessment   Assessment @relation(fields: [assessmentId], references: [id])
}

model Framework {
  id             String        @id
  name           String
  description    String?
  category       String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  organizationId String?
  Control        Control[]
  Organization   Organization? @relation(fields: [organizationId], references: [id])
}

model Organization {
  id        String      @id
  name      String
  tenantId  String      @unique
  createdAt DateTime    @default(now())
  updatedAt DateTime
  Framework Framework[]
  Risk      Risk[]
  User      User[]
}

model Risk {
  id             String       @id
  title          String
  description    String?
  category       String?
  status         String       @default("Identified")
  likelihood     Int
  impact         Int
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Assessment     Assessment[]
  Organization   Organization @relation(fields: [organizationId], references: [id])
}

model Session {
  id        String   @id
  sid       String   @unique
  data      String
  expiresAt DateTime
  userId    String?
  User      User?    @relation(fields: [userId], references: [id])
}

model User {
  id             String        @id
  email          String        @unique
  name           String?
  password       String
  role           Role          @default(USER)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  organizationId String?
  AuditLog       AuditLog[]
  Session        Session[]
  Organization   Organization? @relation(fields: [organizationId], references: [id])
}

model activity_logs {
  id         String   @id
  tenant_id  String
  user_id    String?
  activity   String
  module     String?
  details    Json?
  created_at DateTime @default(now())

  @@index([created_at])
  @@index([module])
  @@index([tenant_id])
  @@index([user_id])
}

model applicable_frameworks_matrix {
  id                   String    @id
  organization_id      String
  framework_id         String
  tenant_id            String
  is_applicable        Boolean   @default(false)
  is_mandatory         Boolean   @default(false)
  applicability_score  Float?
  applicability_reason String?
  matching_factors     Json?
  rule_ids             Json?
  total_controls       Int       @default(0)
  applicable_controls  Int       @default(0)
  mandatory_controls   Int       @default(0)
  optional_controls    Int       @default(0)
  priority_level       String?
  recommended_timeline String?
  compliance_deadline  DateTime?
  calculated_at        DateTime  @default(now())
  calculated_by        String?
  calculation_version  String?
  tenant_id_fk         String?
  created_at           DateTime  @default(now())
  updated_at           DateTime

  @@unique([organization_id, framework_id])
  @@index([framework_id])
  @@index([is_applicable])
  @@index([is_mandatory])
  @@index([organization_id])
  @@index([tenant_id])
}

model assessment_controls {
  id                    String           @id
  assessment_id         String
  control_id            String
  status                String           @default("not_started")
  implementation_status String?
  compliance_status     String?
  score                 Float?
  evidence_submitted    Boolean          @default(false)
  notes                 String?
  assigned_to           String?
  reviewed_by           String?
  reviewed_at           DateTime?
  tenant_id             String
  created_at            DateTime         @default(now())
  updated_at            DateTime
  control_scores        control_scores[]

  @@unique([assessment_id, control_id])
  @@index([assessment_id])
  @@index([control_id])
  @@index([tenant_id])
}

model assessment_evidence {
  id                   String    @id
  assessment_id        String
  control_id           String
  tenant_id            String
  evidence_type        String
  evidence_name        String
  evidence_description String?
  file_path            String?
  file_url             String?
  file_size            Int?
  file_type            String?
  storage_location     String?
  collected_date       DateTime?
  valid_from           DateTime?
  valid_until          DateTime?
  is_expired           Boolean   @default(false)
  validation_status    String    @default("pending")
  validation_score     Float?
  validation_notes     String?
  validated_by         String?
  validated_at         DateTime?
  meets_requirement    Boolean   @default(false)
  confidence_level     String?
  weight               Float     @default(1.0)
  uploaded_by          String?
  created_at           DateTime  @default(now())
  updated_at           DateTime

  @@index([assessment_id])
  @@index([control_id])
  @@index([tenant_id])
  @@index([validation_status])
}

model assessment_findings {
  id                   String    @id
  assessment_id        String
  control_id           String
  tenant_id            String
  finding_type         String
  severity             String
  title                String
  description          String?
  root_cause           String?
  contributing_factors Json?
  business_impact      String?
  technical_impact     String?
  risk_rating          String?
  likelihood           String?
  impact               String?
  risk_score           Float?
  recommendation       String?
  recommended_actions  Json?
  estimated_effort     String?
  estimated_cost       Float?
  status               String    @default("open")
  assigned_to          String?
  due_date             DateTime?
  resolved_date        DateTime?
  resolution_notes     String?
  created_by           String?
  created_at           DateTime  @default(now())
  updated_at           DateTime

  @@index([assessment_id])
  @@index([control_id])
  @@index([finding_type])
  @@index([severity])
  @@index([status])
  @@index([tenant_id])
}

model assessments {
  id                String    @id
  title             String
  title_ar          String?
  framework_id      String
  organization_id   String
  assessment_type   String?
  status            String    @default("draft")
  progress          Float     @default(0)
  score             Float?
  section_1_score   Float?
  section_2_score   Float?
  section_3_score   Float?
  section_4_score   Float?
  section_5_score   Float?
  section_6_score   Float?
  section_7_score   Float?
  section_8_score   Float?
  section_9_score   Float?
  section_10_score  Float?
  section_11_score  Float?
  section_12_score  Float?
  section_1_status  String    @default("not_started")
  section_2_status  String    @default("not_started")
  section_3_status  String    @default("not_started")
  section_4_status  String    @default("not_started")
  section_5_status  String    @default("not_started")
  section_6_status  String    @default("not_started")
  section_7_status  String    @default("not_started")
  section_8_status  String    @default("not_started")
  section_9_status  String    @default("not_started")
  section_10_status String    @default("not_started")
  section_11_status String    @default("not_started")
  section_12_status String    @default("not_started")
  start_date        DateTime?
  due_date          DateTime?
  completed_date    DateTime?
  assigned_to       String?
  tenant_id         String
  created_at        DateTime  @default(now())
  updated_at        DateTime

  @@index([framework_id])
  @@index([organization_id])
  @@index([status])
  @@index([tenant_id])
}

model audit_logs {
  id          String   @id
  tenant_id   String
  user_id     String?
  action      String
  resource    String
  resource_id String?
  details     Json?
  ip_address  String?
  user_agent  String?
  created_at  DateTime @default(now())

  @@index([action])
  @@index([created_at])
  @@index([tenant_id])
  @@index([user_id])
}

model control_applicability_logic {
  id                   String   @id
  control_id           String
  tenant_id            String?
  applicable_sectors   Json     @default("[]")
  excluded_sectors     Json     @default("[]")
  min_employee_count   Int?
  min_revenue_sar      Float?
  company_size_filter  Json     @default("[]")
  required_activities  Json     @default("[]")
  any_of_activities    Json     @default("[]")
  requires_online      Boolean  @default(false)
  requires_mobile      Boolean  @default(false)
  requires_cloud       Boolean  @default(false)
  requires_payment     Boolean  @default(false)
  requires_pii         Boolean  @default(false)
  min_data_records     Int?
  data_sensitivity_min String?
  custom_logic         Json?
  dependencies         Json?
  weight_multiplier    Float    @default(1.0)
  risk_multiplier      Float    @default(1.0)
  created_at           DateTime @default(now())
  updated_at           DateTime

  @@index([control_id])
  @@index([tenant_id])
}

model control_evidence_requirements {
  id                  String   @id
  control_id          String
  evidence_type       String
  evidence_name       String
  evidence_name_ar    String?
  description         String?
  description_ar      String?
  is_mandatory        Boolean  @default(false)
  weight_percentage   Float?
  validation_criteria Json?
  tenant_id           String?
  created_at          DateTime @default(now())
  updated_at          DateTime

  @@index([control_id])
  @@index([tenant_id])
}

model control_scores {
  id                     String               @id
  assessment_control_id  String               @unique
  assessment_id          String
  control_id             String
  tenant_id              String
  evidence_delivered     Boolean              @default(false)
  evidence_count         Int                  @default(0)
  evidence_quality_avg   Float?
  maturity_level         Int                  @default(0)
  percentage_score       Float                @default(0.0)
  max_achievable_level   Int?
  pass_status            String               @default("not_assessed")
  is_mandatory           Boolean              @default(false)
  minimum_required_score Float?
  gap_type               String?
  gap_severity           String?
  gap_description        String?
  recommendation         String?
  remediation_priority   String?
  estimated_effort       String?
  estimated_cost_sar     Float?
  scored_by              String?
  scored_at              DateTime?
  scoring_confidence     Float?
  scoring_rationale      String?
  validated              Boolean              @default(false)
  validated_by           String?
  validated_at           DateTime?
  validation_notes       String?
  created_at             DateTime             @default(now())
  updated_at             DateTime
  assessment_controlsId  String?
  assessment_controls    assessment_controls? @relation(fields: [assessment_controlsId], references: [id])

  @@index([assessment_id])
  @@index([control_id])
  @@index([evidence_delivered])
  @@index([maturity_level])
  @@index([pass_status])
  @@index([tenant_id])
}

model demo_requests {
  id           String    @id
  email        String
  full_name    String
  company_name String?
  sector       String?
  org_size     String?
  use_cases    String[]
  notes        String?
  status       String    @default("pending")
  tenant_id    String?
  user_id      String?
  created_at   DateTime  @default(now())
  reviewed_at  DateTime?
  reviewer_id  String?
  metadata     Json      @default("{}")
  users        users?    @relation(fields: [reviewer_id], references: [id])
  tenants      tenants?  @relation(fields: [tenant_id], references: [id])

  @@index([created_at])
  @@index([email])
  @@index([status])
}

model evidence_validation {
  id                   String    @id
  evidence_id          String
  tenant_id            String
  criteria_name        String
  criteria_description String?
  expected_value       String?
  actual_value         String?
  is_met               Boolean   @default(false)
  score                Float?
  weight               Float     @default(1.0)
  ai_validated         Boolean   @default(false)
  ai_confidence        Float?
  ai_reasoning         String?
  manual_override      Boolean   @default(false)
  override_reason      String?
  override_by          String?
  override_at          DateTime?
  validated_by         String?
  validated_at         DateTime?
  created_at           DateTime  @default(now())
  updated_at           DateTime

  @@index([evidence_id])
  @@index([tenant_id])
}

model follow_up_schedule {
  id                  String    @id
  assessment_id       String?
  remediation_plan_id String?
  remediation_task_id String?
  tenant_id           String
  follow_up_type      String
  title               String
  description         String?
  scheduled_date      DateTime
  completed_date      DateTime?
  is_completed        Boolean   @default(false)
  is_recurring        Boolean   @default(false)
  recurrence_pattern  String?
  next_occurrence     DateTime?
  responsible_person  String?
  participants        Json?
  notify_users        Json?
  status              String    @default("scheduled")
  outcome             String?
  findings            Json?
  action_items        Json?
  reminder_sent       Boolean   @default(false)
  reminder_date       DateTime?
  created_by          String?
  created_at          DateTime  @default(now())
  updated_at          DateTime

  @@index([assessment_id])
  @@index([remediation_plan_id])
  @@index([remediation_task_id])
  @@index([scheduled_date])
  @@index([status])
  @@index([tenant_id])
}

model framework_controls {
  id           String   @id
  framework_id String
  control_id   String
  sequence     Int?
  mandatory    Boolean  @default(true)
  tenant_id    String?
  created_at   DateTime @default(now())
  updated_at   DateTime

  @@unique([framework_id, control_id])
  @@index([framework_id])
  @@index([tenant_id])
}

model gap_analysis {
  id                       String   @id
  assessment_id            String
  framework_id             String
  tenant_id                String
  total_controls           Int      @default(0)
  compliant_controls       Int      @default(0)
  partial_controls         Int      @default(0)
  non_compliant_controls   Int      @default(0)
  not_applicable_controls  Int      @default(0)
  overall_compliance_score Float    @default(0.0)
  target_compliance_score  Float?
  gap_percentage           Float    @default(0.0)
  category_scores          Json?
  domain_scores            Json?
  risk_level_scores        Json?
  critical_gaps            Int      @default(0)
  high_priority_gaps       Int      @default(0)
  medium_priority_gaps     Int      @default(0)
  low_priority_gaps        Int      @default(0)
  improvement_trend        String?
  previous_score           Float?
  score_change             Float?
  estimated_closure_months Int?
  estimated_effort_days    Int?
  estimated_cost_sar       Float?
  executive_summary        String?
  key_findings             Json?
  recommendations          Json?
  analyzed_by              String?
  analyzed_at              DateTime @default(now())
  created_at               DateTime @default(now())
  updated_at               DateTime

  @@unique([assessment_id, framework_id])
  @@index([assessment_id])
  @@index([framework_id])
  @@index([tenant_id])
}

model grc_controls {
  id                         String          @id
  framework_id               String?
  control_id                 String
  title                      String
  title_ar                   String?
  description                String?
  description_ar             String?
  category                   String?
  subcategory                String?
  risk_level                 String?
  control_type               String?
  implementation_status      String          @default("not_implemented")
  maturity_level             Int             @default(0)
  evidence_required          Boolean         @default(false)
  testing_frequency          String?
  implementation_guidance    String?
  implementation_guidance_ar String?
  related_regulations        Json            @default("[]")
  tenant_id                  String?
  created_at                 DateTime        @default(now())
  updated_at                 DateTime        @updatedAt
  grc_frameworks             grc_frameworks? @relation(fields: [framework_id], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([control_id])
  @@index([framework_id])
  @@index([risk_level])
  @@index([tenant_id])
}

model grc_frameworks {
  id               String         @id
  name             String
  name_ar          String?
  description      String?
  description_ar   String?
  version          String?
  effective_date   DateTime?
  authority        String?
  authority_ar     String?
  scope            String?
  jurisdiction     String?
  mandatory        Boolean        @default(false)
  industry_sector  String?
  compliance_level String?
  total_controls   Int            @default(0)
  tenant_id        String?
  created_at       DateTime       @default(now())
  updated_at       DateTime       @updatedAt
  grc_controls     grc_controls[]

  @@index([jurisdiction])
  @@index([tenant_id])
}

model licenses {
  id          String   @id
  tenant_id   String
  license_key String   @unique
  plan_type   String
  seats       Int      @default(1)
  status      String   @default("active")
  issued_date DateTime @default(now())
  expiry_date DateTime
  features    Json     @default("{}")
  created_at  DateTime @default(now())
  updated_at  DateTime

  @@index([status])
  @@index([tenant_id])
}

model notifications {
  id                String    @id
  tenant_id         String
  notification_type String
  title             String
  title_ar          String?
  message           String
  message_ar        String?
  user_id           String
  user_email        String?
  user_name         String?
  priority          String    @default("normal")
  channels          Json?
  status            String    @default("pending")
  read_at           DateTime?
  sent_at           DateTime?
  delivered_at      DateTime?
  organization_id   String?
  assessment_id     String?
  task_id           String?
  control_id        String?
  action_url        String?
  action_label      String?
  action_label_ar   String?
  requires_action   Boolean   @default(false)
  action_taken      Boolean   @default(false)
  action_taken_at   DateTime?
  metadata          Json?
  retry_count       Int       @default(0)
  last_error        String?
  created_at        DateTime  @default(now())
  updated_at        DateTime
  expires_at        DateTime?

  @@index([created_at])
  @@index([notification_type])
  @@index([priority])
  @@index([read_at])
  @@index([status])
  @@index([tenant_id])
  @@index([user_id])
}

model organization_profile_factors {
  id                      String    @id
  organization_id         String    @unique
  tenant_id               String
  sector                  String
  sub_sector              String?
  legal_type              String
  company_size            String
  employee_count          Int?
  annual_revenue_sar      Float?
  total_assets_sar        Float?
  market_cap_sar          Float?
  business_activities     Json      @default("[]")
  service_types           Json      @default("[]")
  product_categories      Json      @default("[]")
  operates_regions        Json      @default("[]")
  has_international       Boolean   @default(false)
  target_markets          Json      @default("[]")
  data_sensitivity_level  String?
  customer_data_records   Int?
  stores_pii              Boolean   @default(false)
  processes_payments      Boolean   @default(false)
  has_online_platform     Boolean   @default(false)
  has_mobile_app          Boolean   @default(false)
  uses_cloud_services     Boolean   @default(false)
  existing_certifications Json      @default("[]")
  previous_audits         Json      @default("[]")
  compliance_maturity     String?
  risk_appetite           String?
  critical_infrastructure Boolean   @default(false)
  handles_govt_data       Boolean   @default(false)
  applicable_frameworks   Json?
  last_calculated         DateTime?
  created_at              DateTime  @default(now())
  updated_at              DateTime

  @@index([company_size])
  @@index([organization_id])
  @@index([sector])
  @@index([tenant_id])
}

model organization_profiles {
  id                             String         @id
  organization_id                String         @unique
  tenant_id                      String
  employee_count                 Int?
  annual_revenue_sar             Float?
  market_cap_sar                 Float?
  organizational_structure       String?
  number_of_branches             Int?
  international_presence         Boolean        @default(false)
  countries_operating_in         Json?
  primary_business_activities    Json?
  secondary_activities           Json?
  business_model                 String?
  customer_segments              Json?
  legal_entity_type              String?
  commercial_registration        String?
  license_type                   String?
  licensing_authority            String?
  regulated_activities           Json?
  data_classification_level      String?
  processes_pii                  Boolean        @default(false)
  pii_volume                     String?
  processes_financial_data       Boolean        @default(false)
  processes_health_data          Boolean        @default(false)
  data_residency_requirements    Json?
  cross_border_data_transfer     Boolean        @default(false)
  has_online_services            Boolean        @default(false)
  has_mobile_app                 Boolean        @default(false)
  has_api_integrations           Boolean        @default(false)
  cloud_usage                    String?
  cloud_providers                Json?
  hosts_critical_infrastructure  Boolean        @default(false)
  processes_payments             Boolean        @default(false)
  payment_volume_daily           Int?
  payment_methods                Json?
  accepts_international_payments Boolean        @default(false)
  currency_operations            Json?
  current_security_maturity      String?
  existing_certifications        Json?
  security_team_size             Int?
  dedicated_compliance_officer   Boolean        @default(false)
  incident_response_plan         Boolean        @default(false)
  last_security_audit_date       DateTime?
  risk_appetite                  String?
  cyber_insurance                Boolean        @default(false)
  previous_incidents             Int            @default(0)
  high_risk_activities           Json?
  number_of_vendors              Int?
  critical_vendors               Int?
  outsourced_services            Json?
  third_party_risk_mgmt          Boolean        @default(false)
  total_customers                Int?
  active_users_monthly           Int?
  customer_types                 Json?
  high_net_worth_clients         Boolean        @default(false)
  government_contracts           Boolean        @default(false)
  mandatory_frameworks           Json?
  recommended_frameworks         Json?
  voluntary_frameworks           Json?
  ai_analysis_completed          Boolean        @default(false)
  ai_analysis_date               DateTime?
  ai_confidence_score            Float?
  ai_recommendations             Json?
  profile_completeness           Float          @default(0.0)
  last_reviewed_date             DateTime?
  reviewed_by                    String?
  created_at                     DateTime       @default(now())
  updated_at                     DateTime
  organizationsId                String?
  organizations                  organizations? @relation(fields: [organizationsId], references: [id])

  @@index([data_classification_level])
  @@index([employee_count])
  @@index([organization_id])
  @@index([tenant_id])
}

model organizations {
  id                    String                  @id
  name                  String
  name_ar               String?
  registration_number   String?
  sector                String?
  country               String?
  city                  String?
  address               String?
  contact_email         String?
  contact_phone         String?
  license_type          String?
  tenant_id             String
  created_at            DateTime                @default(now())
  updated_at            DateTime
  organization_profiles organization_profiles[]

  @@index([sector])
  @@index([tenant_id])
}

model partner_invitations {
  id                                                  String    @id
  partner_tenant_id                                   String
  email                                               String
  invite_token                                        String    @unique
  status                                              String    @default("pending")
  invited_by_user_id                                  String?
  accepted_user_id                                    String?
  created_at                                          DateTime  @default(now())
  expires_at                                          DateTime
  accepted_at                                         DateTime?
  metadata                                            Json      @default("{}")
  users_partner_invitations_accepted_user_idTousers   users?    @relation("partner_invitations_accepted_user_idTousers", fields: [accepted_user_id], references: [id])
  users_partner_invitations_invited_by_user_idTousers users?    @relation("partner_invitations_invited_by_user_idTousers", fields: [invited_by_user_id], references: [id])
  tenants                                             tenants   @relation(fields: [partner_tenant_id], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([partner_tenant_id])
  @@index([status])
}

model poc_requests {
  id                     String    @id
  email                  String
  full_name              String
  company_name           String
  sector                 String?
  use_cases              String[]
  environment_preference String?
  preferred_start_date   DateTime?
  notes                  String?
  status                 String    @default("new")
  tenant_id              String?
  owner_internal_user_id String?
  created_at             DateTime  @default(now())
  updated_at             DateTime
  approved_at            DateTime?
  completed_at           DateTime?
  metadata               Json      @default("{}")
  users                  users?    @relation(fields: [owner_internal_user_id], references: [id])
  tenants                tenants?  @relation(fields: [tenant_id], references: [id])

  @@index([company_name])
  @@index([created_at])
  @@index([status])
}

model regulatory_applicability_rules {
  id                      String    @id
  framework_id            String
  regulator_code          String
  mandatory_sectors       Json      @default("[]")
  optional_sectors        Json      @default("[]")
  excluded_sectors        Json      @default("[]")
  company_size_min        Int?
  company_size_max        Int?
  revenue_threshold_min   Float?
  revenue_threshold_max   Float?
  legal_types             Json      @default("[]")
  business_activities     Json      @default("[]")
  geographic_scope        String?
  data_sensitivity        String?
  customer_data_volume    String?
  has_online_services     Boolean   @default(false)
  processes_payments      Boolean   @default(false)
  stores_pii              Boolean   @default(false)
  critical_infrastructure Boolean   @default(false)
  rule_logic              Json?
  effective_date          DateTime?
  expiry_date             DateTime?
  priority                Int       @default(0)
  weight                  Float     @default(1.0)
  tenant_id               String?
  created_at              DateTime  @default(now())
  updated_at              DateTime

  @@index([framework_id])
  @@index([regulator_code])
  @@index([tenant_id])
}

model remediation_plans {
  id                              String    @id
  assessment_id                   String
  gap_analysis_id                 String?
  tenant_id                       String
  plan_name                       String
  plan_description                String?
  plan_type                       String?
  target_frameworks               Json?
  target_controls                 Json?
  addresses_findings              Json?
  start_date                      DateTime?
  target_completion               DateTime?
  actual_completion               DateTime?
  estimated_budget_sar            Float?
  actual_budget_sar               Float?
  estimated_effort_days           Int?
  actual_effort_days              Int?
  required_resources              Json?
  priority_level                  String    @default("medium")
  phase                           String?
  status                          String    @default("draft")
  progress_percentage             Float     @default(0.0)
  total_tasks                     Int       @default(0)
  completed_tasks                 Int       @default(0)
  overdue_tasks                   Int       @default(0)
  plan_owner                      String?
  approved_by                     String?
  approved_at                     DateTime?
  expected_risk_reduction         Float?
  expected_compliance_improvement Float?
  business_benefits               Json?
  created_by                      String?
  created_at                      DateTime  @default(now())
  updated_at                      DateTime

  @@index([assessment_id])
  @@index([gap_analysis_id])
  @@index([status])
  @@index([tenant_id])
}

model remediation_tasks {
  id                  String    @id
  remediation_plan_id String
  finding_id          String?
  control_id          String?
  tenant_id           String
  task_title          String
  task_description    String?
  task_type           String?
  priority            String    @default("medium")
  sequence_number     Int?
  depends_on_tasks    Json?
  planned_start       DateTime?
  planned_end         DateTime?
  actual_start        DateTime?
  actual_end          DateTime?
  due_date            DateTime?
  estimated_hours     Float?
  actual_hours        Float?
  estimated_cost      Float?
  actual_cost         Float?
  assigned_to         String?
  assigned_team       String?
  collaborators       Json?
  status              String    @default("pending")
  progress_percentage Float     @default(0.0)
  is_blocked          Boolean   @default(false)
  blocker_reason      String?
  is_overdue          Boolean   @default(false)
  completion_evidence String?
  verified_by         String?
  verified_at         DateTime?
  notes               String?
  updates             Json?
  created_by          String?
  created_at          DateTime  @default(now())
  updated_at          DateTime

  @@index([assigned_to])
  @@index([control_id])
  @@index([finding_id])
  @@index([remediation_plan_id])
  @@index([status])
  @@index([tenant_id])
}

model sector_controls {
  id              String   @id
  sector          String
  control_id      String
  applicability   String?
  risk_multiplier Float    @default(1.0)
  mandatory       Boolean  @default(false)
  tenant_id       String?
  created_at      DateTime @default(now())
  updated_at      DateTime

  @@unique([sector, control_id])
  @@index([sector])
  @@index([tenant_id])
}

model subscriptions {
  id             String    @id
  tenant_id      String
  plan_id        String
  status         String    @default("active")
  billing_cycle  String
  amount         Float
  currency       String    @default("SAR")
  start_date     DateTime
  end_date       DateTime?
  auto_renew     Boolean   @default(true)
  payment_method String?
  created_at     DateTime  @default(now())
  updated_at     DateTime

  @@index([status])
  @@index([tenant_id])
}

model tasks {
  id                  String    @id
  tenant_id           String
  task_type           String
  title               String
  title_ar            String?
  description         String?
  description_ar      String?
  organization_id     String?
  assessment_id       String?
  control_id          String?
  finding_id          String?
  remediation_plan_id String?
  priority            String    @default("medium")
  status              String    @default("pending")
  progress_percentage Float     @default(0.0)
  assigned_to         String?
  assigned_to_email   String?
  assigned_to_name    String?
  assigned_team       String?
  collaborators       Json?
  due_date            DateTime?
  start_date          DateTime?
  completed_date      DateTime?
  estimated_hours     Float?
  actual_hours        Float?
  depends_on_tasks    Json?
  is_blocked          Boolean   @default(false)
  blocker_reason      String?
  notify_on_due       Boolean   @default(true)
  notify_on_complete  Boolean   @default(true)
  last_reminder_sent  DateTime?
  completion_notes    String?
  completion_evidence String?
  created_by          String?
  created_at          DateTime  @default(now())
  updated_at          DateTime

  @@index([assessment_id])
  @@index([assigned_to])
  @@index([due_date])
  @@index([organization_id])
  @@index([status])
  @@index([task_type])
  @@index([tenant_id])
}

model tenants {
  id                  String                @id
  slug                String                @unique
  display_name        String
  type                String
  status              String                @default("active")
  country             String?
  sector              String?
  metadata            Json                  @default("{}")
  created_at          DateTime              @default(now())
  updated_at          DateTime
  expires_at          DateTime?
  demo_requests       demo_requests[]
  partner_invitations partner_invitations[]
  poc_requests        poc_requests[]
  users               users[]

  @@index([status])
  @@index([type])
}

model users {
  id                                                                String                @id
  tenant_id                                                         String
  email                                                             String
  password_hash                                                     String?
  full_name                                                         String?
  role                                                              String                @default("user")
  is_partner                                                        Boolean               @default(false)
  is_super_admin                                                    Boolean               @default(false)
  metadata                                                          Json                  @default("{}")
  created_at                                                        DateTime              @default(now())
  updated_at                                                        DateTime
  last_login_at                                                     DateTime?
  demo_requests                                                     demo_requests[]
  partner_invitations_partner_invitations_accepted_user_idTousers   partner_invitations[] @relation("partner_invitations_accepted_user_idTousers")
  partner_invitations_partner_invitations_invited_by_user_idTousers partner_invitations[] @relation("partner_invitations_invited_by_user_idTousers")
  poc_requests                                                      poc_requests[]
  tenants                                                           tenants               @relation(fields: [tenant_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, email])
  @@index([email])
  @@index([tenant_id])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model landing_requests {
  id               Int       @id @default(autoincrement())
  name             String    @db.VarChar(255)
  company          String    @db.VarChar(255)
  email            String    @db.VarChar(255)
  phone            String?   @db.VarChar(50)
  preferred_date   DateTime? @db.Date
  preferred_time   String?   @db.VarChar(20)
  access_type      String    @db.VarChar(20)
  package          String?   @db.VarChar(100)
  features         Json?
  message          String?
  lead_score       Int?      @default(0)
  status           String?   @default("pending") @db.VarChar(20)
  approval_token   String?
  approved_at      DateTime? @db.Timestamp(6)
  rejected_at      DateTime? @db.Timestamp(6)
  rejection_reason String?
  confirmed_at     DateTime? @db.Timestamp(6)
  created_at       DateTime? @default(now()) @db.Timestamp(6)
  updated_at       DateTime? @default(now()) @db.Timestamp(6)
}

enum Role {
  USER
  ADMIN
  AUDITOR
  MANAGER
}
