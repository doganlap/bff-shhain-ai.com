// ============================================================================
// SHAHIN COMPLIANCE DATABASE SCHEMA - CLEAN PRISMA VERSION
// Enterprise GRC Compliance Database for Saudi Market
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

// ============================================================================
// CORE TABLES
// ============================================================================

// Organizations table with Saudi market focus
model organizations {
  id                String   @id @default(uuid())
  name              String
  name_ar           String?
  sector            String
  industry          String?
  country           String   @default("Saudi Arabia")
  city              String?
  contact_email     String?
  contact_phone     String?
  website           String?
  license_number    String?
  established_year  Int?
  employee_count    String?
  status            String   @default("active")

  // Saudi-specific fields
  cr_number         String?  // Commercial Registration
  tax_number        String?
  gosi_number       String?
  sdaia_license     String?  // SDAIA AI License
  nca_certification String?  @default("none")

  // Compliance metadata
  compliance_score  Decimal? @db.Decimal(5, 2)

  // Audit fields
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relations
  users             users[]

  @@index([sector])
  @@index([status])
  @@index([cr_number])
}

// Users with enhanced Saudi market roles
model users {
  id              String       @id @default(uuid())
  organization_id String?

  // Personal info
  email           String       @unique
  password_hash   String?
  full_name       String?
  full_name_ar    String?
  phone           String?
  national_id     String?      // Saudi National ID/Iqama
  job_title       String?
  job_title_ar    String?
  department      String?

  // Roles and permissions (Saudi market focused)
  role            String       @default("viewer")

  // Saudi-specific permissions
  can_access_sama_data   Boolean @default(false)
  can_access_health_data Boolean @default(false)
  can_access_government_data Boolean @default(false)

  // Account status
  status          String       @default("pending_verification")
  last_login_at   DateTime?
  login_attempts  Int          @default(0)
  locked_until    DateTime?

  // Multi-factor authentication
  mfa_enabled     Boolean      @default(false)
  mfa_secret      String?

  // Audit fields
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  // Relations
  organization    organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([organization_id])
  @@index([role])
  @@index([status])
}

// ============================================================================
// COMPLIANCE FRAMEWORKS & CONTROLS
// ============================================================================

// Compliance frameworks with Saudi market focus
model compliance_frameworks {
  id            String   @id @default(uuid())
  name          String
  name_ar       String?
  code          String   @unique // ISO27001, SOX, SAMA-CSF, NCA, etc.
  version       String?
  description   String?
  description_ar String?

  // Framework metadata
  authority     String?  // ISO, SOX, SAMA, NCA, etc.
  country       String   @default("Saudi Arabia")
  category      String   @default("general")
  status        String   @default("active")

  // Audit fields
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relations
  controls      compliance_controls[]

  @@index([code])
  @@index([category])
  @@index([status])
  @@index([authority])
}

// Compliance controls (the actual requirements)
model compliance_controls {
  id                String   @id @default(uuid())
  framework_id      String
  control_id        String   // Unique within framework
  title             String
  title_ar          String?
  description       String?
  description_ar    String?

  // Control classification
  category          String?
  subcategory       String?
  risk_level        String   @default("medium")

  // Implementation guidance
  implementation_guidance     String?
  implementation_guidance_ar  String?

  // Control lifecycle
  status            String   @default("active")

  // Saudi market specific
  sama_relevant     Boolean  @default(false)
  nca_relevant      Boolean  @default(false)
  moh_relevant      Boolean  @default(false)
  sfda_relevant     Boolean  @default(false)

  // Audit fields
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relations
  framework         compliance_frameworks @relation(fields: [framework_id], references: [id], onDelete: Cascade)

  @@index([framework_id])
  @@index([risk_level])
  @@index([status])
}

// ============================================================================
// ASSESSMENTS & AUDITS
// ============================================================================

// Compliance assessments
model assessments {
  id                String   @id @default(uuid())
  organization_id   String
  framework_id      String?

  // Assessment details
  title             String
  description       String?
  assessment_type   String   @default("gap_analysis")
  status            String   @default("planned")

  // Dates
  planned_start_date DateTime?
  actual_start_date DateTime?
  planned_end_date  DateTime?
  actual_end_date   DateTime?

  // Scoring and results
  overall_score     Decimal? @db.Decimal(5, 2)
  compliance_percentage Decimal? @db.Decimal(5, 2)
  risk_level        String?

  // Audit trail
  created_by        String
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  @@index([organization_id])
  @@index([status])
  @@index([assessment_type])
}

// ============================================================================
// EVIDENCE MANAGEMENT
// ============================================================================

// Evidence repository
model evidence {
  id               String   @id @default(uuid())
  organization_id  String
  assessment_id    String?
  control_id       String?

  // File metadata
  original_filename String
  stored_filename  String
  file_path        String
  file_size_bytes  BigInt?
  mime_type        String?
  file_hash        String?  // SHA-256

  // Evidence details
  title            String
  description      String?
  evidence_type    String   @default("other")

  // Compliance mapping
  framework_id     String?
  control_reference String?

  // Validation and approval
  status           String   @default("draft")
  submitted_by     String?
  submitted_at     DateTime?
  reviewed_by      String?
  reviewed_at      DateTime?
  review_notes     String?

  // Retention and archival
  retention_period_years Int @default(7)

  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  @@index([organization_id])
  @@index([assessment_id])
  @@index([status])
  @@index([evidence_type])
}

// ============================================================================
// RISK MANAGEMENT
// ============================================================================

// Risk register
model risks {
  id                String   @id @default(uuid())
  organization_id   String
  assessment_id     String?

  // Risk identification
  title             String
  description       String?
  category          String   @default("other")

  // Risk assessment
  likelihood        String   @default("moderate")
  impact            String   @default("moderate")
  inherent_risk_score Int?

  // Risk treatment
  status            String   @default("identified")
  treatment_strategy String  @default("mitigate")
  treatment_plan    String?

  // Responsible person
  responsible_person String?

  // Monitoring
  review_frequency  String   @default("quarterly")
  next_review_date  DateTime?
  last_reviewed_at  DateTime?
  last_reviewed_by  String?

  // Saudi market specific
  sama_relevant     Boolean  @default(false)
  regulatory_authority String?

  created_by        String
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  @@index([organization_id])
  @@index([category])
  @@index([status])
  @@index([inherent_risk_score])
}

// ============================================================================
// AUDIT & MONITORING
// ============================================================================

// Audit logs
model audit_logs {
  id            String   @id @default(uuid())
  user_id       String?
  organization_id String?
  action        String
  resource_type String?
  resource_id   String?
  changes       Json?
  ip_address    String?
  user_agent    String?
  risk_level    String   @default("low")
  timestamp     DateTime @default(now())

  @@index([user_id])
  @@index([organization_id])
  @@index([action])
  @@index([timestamp])
  @@index([risk_level])
}

// System monitoring
model system_monitoring {
  id            String   @id @default(uuid())
  metric_name   String
  metric_value  Decimal? @db.Decimal(15, 6)
  metric_unit   String?
  component     String?
  environment   String   @default("production")
  host_name     String?
  status        String   @default("normal")
  timestamp     DateTime @default(now())

  @@index([metric_name])
  @@index([component])
  @@index([status])
  @@index([timestamp])
}

// ============================================================================
// SAUDI MARKET SPECIFIC TABLES
// ============================================================================

// SAMA compliance tracking
model sama_compliance {
  id                      String   @id @default(uuid())
  organization_id         String
  sama_framework_version  String   @default("2021")

  // Compliance status
  overall_compliance_score Decimal? @db.Decimal(5, 2)
  critical_controls_compliant Int?
  total_critical_controls Int?

  // Regulatory deadlines
  last_sama_audit         DateTime?
  next_sama_audit         DateTime?

  // SAMA-specific requirements
  cybersecurity_maturity_level String?
  incident_reporting_compliance Boolean @default(false)
  data_protection_compliance    Boolean @default(false)

  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt

  @@index([organization_id])
}

// NCA cybersecurity controls tracking
model nca_compliance {
  id                    String   @id @default(uuid())
  organization_id       String

  // NCA domains compliance
  governance_compliance Decimal? @db.Decimal(5, 2)
  protection_compliance Decimal? @db.Decimal(5, 2)
  defense_compliance    Decimal? @db.Decimal(5, 2)
  response_compliance   Decimal? @db.Decimal(5, 2)
  recovery_compliance   Decimal? @db.Decimal(5, 2)

  // Maturity levels
  overall_maturity_level String?
  target_maturity_level  String?

  // Certification status
  nca_certified          Boolean @default(false)
  certification_date     DateTime?
  certification_expiry   DateTime?

  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  @@index([organization_id])
  @@index([nca_certified])
}
