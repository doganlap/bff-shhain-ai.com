// Main Application Database Schema
// Core GRC system tables

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

// Core Organizations
model organizations {
  id                String   @id @default(uuid())
  name              String
  name_ar           String?
  sector            String
  industry          String?
  country           String   @default("Saudi Arabia")
  city              String?
  contact_email     String?
  contact_phone     String?
  website           String?
  license_number    String?
  established_year  Int?
  employee_count    String?
  status            String   @default("active")

  cr_number         String?  // Commercial Registration
  tax_number        String?
  gosi_number       String?
  sdaia_license     String?  // SDAIA AI License
  nca_certification String?  @default("none")

  compliance_score  Decimal? @db.Decimal(5, 2)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  users             users[]
  assessments       assessments[]
  risks             risks[]
  work_orders       work_orders[]

  @@index([sector])
  @@index([status])
  @@index([cr_number])
  @@index([compliance_score])
}

// Users
model users {
  id              String       @id @default(uuid())
  organization_id String?

  email           String       @unique
  password_hash   String?
  full_name       String?
  full_name_ar    String?
  phone           String?
  national_id     String?      // Saudi National ID/Iqama
  job_title       String?
  job_title_ar    String?
  department      String?

  role            String       @default("viewer")
  can_access_sama_data   Boolean @default(false)
  can_access_health_data Boolean @default(false)
  can_access_government_data Boolean @default(false)

  status          String       @default("pending_verification")
  last_login_at   DateTime?
  login_attempts  Int          @default(0)
  locked_until    DateTime?

  mfa_enabled     Boolean      @default(false)
  mfa_secret      String?

  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  organization    organizations? @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([organization_id])
  @@index([role])
  @@index([status])
}

// Assessments
model assessments {
  id                String   @id @default(uuid())
  organization_id   String
  framework_id      String?

  title             String
  description       String?
  assessment_type   String   @default("gap_analysis")
  status            String   @default("planned")

  planned_start_date DateTime?
  actual_start_date DateTime?
  planned_end_date  DateTime?
  actual_end_date   DateTime?

  overall_score     Decimal? @db.Decimal(5, 2)
  compliance_percentage Decimal? @db.Decimal(5, 2)
  risk_level        String?

  created_by        String
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  organization      organizations @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([organization_id])
  @@index([status])
  @@index([assessment_type])
}

// Risks
model risks {
  id                String   @id @default(uuid())
  organization_id   String
  assessment_id     String?

  title             String
  description       String?
  category          String   @default("other")

  likelihood        String   @default("moderate")
  impact            String   @default("moderate")
  inherent_risk_score Int?

  status            String   @default("identified")
  treatment_strategy String  @default("mitigate")
  treatment_plan    String?

  responsible_person String?

  review_frequency  String   @default("quarterly")
  next_review_date  DateTime?
  last_reviewed_at  DateTime?
  last_reviewed_by  String?

  sama_relevant     Boolean  @default(false)
  regulatory_authority String?

  created_by        String
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  organization      organizations @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([organization_id])
  @@index([category])
  @@index([status])
  @@index([inherent_risk_score])
}

// Work Orders
model work_orders {
  id                String   @id @default(uuid())
  work_order_number String   @unique
  title             String
  description       String?
  type              String?
  category          String?
  priority          String   @default("medium")
  status            String   @default("pending")

  organization_id   String
  requester_id      String?
  assigned_to       String?
  assigned_team     String?

  due_date          DateTime?
  start_date        DateTime?
  completion_date   DateTime?

  estimated_hours   Decimal? @db.Decimal(10, 2)
  actual_hours      Decimal? @db.Decimal(10, 2)
  cost_estimate     Decimal? @db.Decimal(15, 2)
  actual_cost       Decimal? @db.Decimal(15, 2)

  location          String?
  approval_required Boolean  @default(false)
  approved_by       String?
  approved_at       DateTime?

  completion_notes  String?
  satisfaction_rating Int?

  tags              String[]
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  organization      organizations @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([organization_id])
  @@index([status])
  @@index([priority])
  @@index([assigned_to])
}

// Frameworks
model frameworks {
  id            String   @id @default(uuid())
  name          String
  name_ar       String?
  code          String   @unique
  version       String?
  description   String?
  description_ar String?

  authority     String?
  country       String   @default("Saudi Arabia")
  category      String   @default("general")
  status        String   @default("active")

  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@index([code])
  @@index([category])
  @@index([status])
  @@index([authority])
}

// Controls
model controls {
  id                String   @id @default(uuid())
  framework_id      String
  control_id        String
  title             String
  title_ar          String?
  description       String?
  description_ar    String?

  category          String?
  subcategory       String?
  risk_level        String   @default("medium")

  implementation_guidance     String?
  implementation_guidance_ar  String?

  status            String   @default("active")

  sama_relevant     Boolean  @default(false)
  nca_relevant      Boolean  @default(false)
  moh_relevant      Boolean  @default(false)
  sfda_relevant     Boolean  @default(false)

  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  @@index([framework_id])
  @@index([risk_level])
  @@index([status])
}

// Evidence
model evidence {
  id               String   @id @default(uuid())
  organization_id  String
  assessment_id    String?
  control_id       String?

  title            String
  description      String?
  evidence_type    String   @default("other")

  original_filename String
  stored_filename  String
  file_path        String
  file_size_bytes  BigInt?
  mime_type        String?
  file_hash        String?

  status           String   @default("draft")
  submitted_by     String?
  submitted_at     DateTime?
  reviewed_by      String?
  reviewed_at      DateTime?
  review_notes     String?

  retention_period_years Int @default(7)

  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  @@index([organization_id])
  @@index([assessment_id])
  @@index([status])
  @@index([evidence_type])
}

// Audit Logs
model audit_logs {
  id            String   @id @default(uuid())
  user_id       String?
  organization_id String?
  action        String
  resource_type String?
  resource_id   String?
  changes       Json?
  ip_address    String?
  user_agent    String?
  risk_level    String   @default("low")
  timestamp     DateTime @default(now())

  @@index([user_id])
  @@index([organization_id])
  @@index([action])
  @@index([timestamp])
  @@index([risk_level])
}

// Sessions
model sessions {
  id        String   @id @default(uuid())
  user_id   String?
  token     String   @unique
  ip_address String?
  user_agent String?
  last_activity DateTime @default(now())
  expires_at DateTime?
  created_at DateTime @default(now())

  @@index([user_id])
  @@index([token])
  @@index([expires_at])
}

// Notifications
model notifications {
  id            String   @id @default(uuid())
  user_id       String?
  organization_id String?
  title         String
  message       String
  type          String   @default("info")
  priority      String   @default("normal")
  status        String   @default("unread")
  action_url    String?
  expires_at    DateTime?
  created_at    DateTime @default(now())

  @@index([user_id])
  @@index([organization_id])
  @@index([type])
  @@index([status])
  @@index([created_at])
}
