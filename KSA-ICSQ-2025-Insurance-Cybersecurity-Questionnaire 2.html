<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KSA-ICSQ-2025 â€” Insurance Cybersecurity Self-Assessment Questionnaire | Shahin-AI Platform</title>
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%230ea5e9;stop-opacity:1' /%3E%3Cstop offset='50%25' style='stop-color:%233b82f6;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%238b5cf6;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23grad)'/%3E%3Cpath d='M30 40h40v20H30z' fill='white'/%3E%3Cpath d='M35 45h30v2H35z' fill='%230ea5e9'/%3E%3Cpath d='M35 50h25v2H35z' fill='%230ea5e9'/%3E%3Cpath d='M35 55h20v2H35z' fill='%230ea5e9'/%3E%3Ctext x='50' y='75' text-anchor='middle' fill='white' font-family='Arial' font-size='8' font-weight='bold'%3EKSA-ICSQ%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%230ea5e9;stop-opacity:1' /%3E%3Cstop offset='50%25' style='stop-color:%233b82f6;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%238b5cf6;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23grad)'/%3E%3Cpath d='M30 40h40v20H30z' fill='white'/%3E%3Cpath d='M35 45h30v2H35z' fill='%230ea5e9'/%3E%3Cpath d='M35 50h25v2H35z' fill='%230ea5e9'/%3E%3Cpath d='M35 55h20v2H35z' fill='%230ea5e9'/%3E%3Ctext x='50' y='75' text-anchor='middle' fill='white' font-family='Arial' font-size='8' font-weight='bold'%3EKSA-ICSQ%3C/text%3E%3C/svg%3E">
    
    <!-- HTML File Type Enforcement -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-TileColor" content="#0ea5e9">
    <meta name="theme-color" content="#0ea5e9">
    
    <!-- Mobile and Teams Optimization -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="KSA-ICSQ-2025">
    
    <!-- Teams and Office 365 Compatibility -->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="msapplication-starturl" content="/">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    
    <!-- Application Identity -->
    <meta name="application-name" content="KSA-ICSQ-2025">
    <meta name="description" content="Insurance Cybersecurity Self-Assessment Questionnaire for Saudi Arabia - TUV Austria Trust IT Team">
    <meta name="keywords" content="cybersecurity, insurance, assessment, SAMA, NCA, PDPL, Saudi Arabia, TUV Austria">
    <meta name="author" content="Dr. Ahmed Dogan - DoganConsult">
    <meta name="robots" content="noindex, nofollow">
    
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* CSS Reset and Base Styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  height: 100%;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  line-height: 1.6;
  color: #333;
  background-color: #f8fafc;
}

body {
  overflow-x: hidden;
}

/* Ensure proper display */
.container {
  display: block !important;
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* Fix any missing elements */
.hidden {
  display: none !important;
}

.visible {
  display: block !important;
}

/* Ensure buttons are clickable */
button, .btn {
  cursor: pointer;
  border: none;
  outline: none;
  text-decoration: none;
  display: inline-block;
}

/* Ensure form elements are properly styled */
input, select, textarea {
  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
}

/* Fix any layout issues */
.flex {
  display: flex;
}

.grid {
  display: grid;
}

.text-center {
  text-align: center;
}

.text-left {
  text-align: left;
}

.text-right {
  text-align: right;
}
</style>

<!-- HTML File Type Enforcement Script -->
<script>
// Ensure file opens only in HTML format
(function() {
  'use strict';
  
  // Check if running in HTML context
  if (typeof window === 'undefined' || !window.document) {
    console.error('This file must be opened in an HTML browser');
    alert('This file must be opened in a web browser as an HTML file.');
    return;
  }
  
  // Verify HTML document structure
  if (!document.documentElement || document.documentElement.tagName !== 'HTML') {
    console.error('Invalid HTML document structure');
    alert('This file appears to be corrupted. Please ensure it is a valid HTML file.');
    return;
  }
  
  // Set proper MIME type
  if (document.contentType && document.contentType !== 'text/html') {
    console.warn('File opened with incorrect MIME type:', document.contentType);
  }
  
  // Add HTML file type indicator
  document.documentElement.setAttribute('data-file-type', 'html');
  document.documentElement.setAttribute('data-application', 'KSA-ICSQ-2025');
  
  console.log('KSA-ICSQ-2025 HTML file loaded successfully');
})();
</script>
<style>
:root{
  /* Primary Colors */
  --primary:#1e293b; /* Professional dark blue-gray */
  --primary-dark:#0f172a;
  --primary-light:#334155;
  --secondary:#3b82f6;
  
  /* Status Colors */
  --success:#10b981;
  --warning:#f59e0b;
  --error:#ef4444;
  --info:#3b82f6;
  
  /* Neutral Colors */
  --accent:#14242e;
  --gold:#c9a210;
  --dark:#14242e;
  --bg:#f7f9f7;
  --white:#ffffff;
  --border:#e5e7eb;
  
  /* Enterprise Colors */
  --enterprise-dark:#0f172a;
  --enterprise-medium:#1e293b;
  --enterprise-light:#334155;
  --enterprise-text:#f1f5f9;
  --enterprise-text-light:#cbd5e1;
  --enterprise-text-muted:#94a3b8;
  
  /* Badge Colors */
  --badge-primary-bg:#f8fafc;
  --badge-primary-text:#475569;
  --badge-primary-border:#cbd5e1;
  --badge-success-bg:#f0fdf4;
  --badge-success-text:#166534;
  --badge-success-border:#bbf7d0;
  --badge-info-bg:#f0f9ff;
  --badge-info-text:#1e40af;
  --badge-info-border:#bfdbfe;
  --badge-warning-bg:#fffbeb;
  --badge-warning-text:#92400e;
  --badge-warning-border:#fed7aa;
  
  /* Compliance Colors */
  --compliance-bg:#f8fafc;
  --compliance-border:#e2e8f0;
  --compliance-icon-bg:#dbeafe;
  --compliance-icon-text:#1e40af;
  --compliance-icon-border:#93c5fd;
  --compliance-text:#6b7280;
  
  /* Status Icon Colors */
  --status-pending-bg:#f8fafc;
  --status-pending-text:#94a3b8;
  --status-pending-border:#e2e8f0;
  --status-progress-bg:#fef3c7;
  --status-progress-text:#92400e;
  --status-progress-border:#fcd34d;
  --status-completed-bg:#f0fdf4;
  --status-completed-text:#166534;
  --status-completed-border:#bbf7d0;
  
  /* Shadows */
  --shadow:0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg:0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  
  /* Typography */
  --font-size-xs:0.75rem;
  --font-size-sm:0.875rem;
  --font-size-base:1rem;
  --font-size-lg:1.125rem;
  --font-size-xl:1.25rem;
  --font-size-2xl:1.5rem;
  --font-size-3xl:1.875rem;
  --font-size-4xl:2.25rem;
  
  /* Spacing */
  --spacing-xs:0.25rem;
  --spacing-sm:0.5rem;
  --spacing-md:1rem;
  --spacing-lg:1.5rem;
  --spacing-xl:2rem;
  --spacing-2xl:3rem;
  --spacing-3xl:4rem;
  
  /* Border Radius */
  --border-radius:8px;
  --border-radius-lg:12px;
  
  /* Transitions */
  --transition:all 0.3s ease;
}
*{box-sizing:border-box}
body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:var(--bg); color:#111; line-height:1.6;}
.header{background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:white; padding:32px 24px; text-align:center; box-shadow:var(--shadow-lg);}
.header h1{margin:0;font-size:28px;font-weight:700}
.header p{margin:8px 0 0 0;opacity:.9;font-size:16px}
.container{max-width:1200px;margin:32px auto;padding:0 24px 64px}
.card{background:white;border-radius:12px;box-shadow:var(--shadow); padding:32px; margin-bottom:24px;border:1px solid var(--border); transition:box-shadow 0.2s;}
.card:hover{box-shadow:var(--shadow-lg);}
.card h2{margin:0 0 20px 0; color:var(--primary); font-size:20px;font-weight:600;border-bottom:2px solid #f3f4f6;padding-bottom:8px;}
.grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px}
.form-group{margin-bottom:20px}
label{font-weight:600;color:#374151;margin-bottom:8px;display:block;font-size:14px}
input[type=text], input[type=number], input[type=email], select, textarea{
  width:100%; padding:12px 16px;border:2px solid var(--border);border-radius:8px;background:#fff;
  font-size:14px;transition:border-color 0.2s, box-shadow 0.2s;
}
input:focus, select:focus, textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(10, 124, 47, 0.1);}
input.error, select.error, textarea.error{border-color:var(--error);}
.error-message{color:var(--error);font-size:12px;margin-top:4px;display:none;}
.badge{display:inline-block;padding:6px 12px;border-radius:20px;background:#e9f6ec;color:#0b6027;font-size:12px;font-weight:500;border:1px solid #cfe9d5}
.status-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:8px;}
.status-saved{background:var(--success);}
.status-pending{background:var(--warning);}
.status-error{background:var(--error);}
.rtl{direction:rtl; text-align:right}
.actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:24px;justify-content:flex-end}
button{border:none;border-radius:8px;padding:12px 24px;cursor:pointer;font-weight:500;font-size:14px;transition:all 0.2s;min-width:120px;}
button:disabled{opacity:0.6;cursor:not-allowed;}
.primary{background:var(--primary);color:white;}
.primary:hover:not(:disabled){background:var(--primary-dark);transform:translateY(-1px);}
.secondary{background:white;border:2px solid var(--border);color:#374151;}
.secondary:hover:not(:disabled){border-color:var(--primary);color:var(--primary);}
.danger{background:var(--error);color:white;}
.danger:hover:not(:disabled){background:#dc2626;transform:translateY(-1px);}
.note{font-size:13px;color:#6b7280;margin-top:8px;padding:12px;background:#f9fafb;border-radius:6px;border-left:4px solid var(--info);}
table{width:100%;border-collapse:collapse;margin-top:16px}
th,td{border:1px solid var(--border);padding:12px;text-align:left}
th{background:#f8fafc;font-weight:600;color:#374151}
.score{font-weight:700;color:var(--primary);text-align:center;}
.score-input{width:60px;text-align:center;font-weight:600;}
.score-container{transition:all 0.3s ease;}
.score-container.excellent{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-left:4px solid #10b981;}
.score-container.good{background:linear-gradient(135deg,#fefce8,#fef3c7);border-left:4px solid #eab308;}
.score-container.moderate{background:linear-gradient(135deg,#fef3c7,#fed7aa);border-left:4px solid #f59e0b;}
.score-container.poor{background:linear-gradient(135deg,#fef2f2,#fecaca);border-left:4px solid #ef4444;}
tr.excellent{background:#f0fdf4;border-left:4px solid #10b981;}
tr.good{background:#fefce8;border-left:4px solid #eab308;}
tr.moderate{background:#fef3c7;border-left:4px solid #f59e0b;}
tr.poor{background:#fef2f2;border-left:4px solid #ef4444;}
.score-item{padding:12px;border-radius:8px;transition:all 0.3s ease;}
.score-item.excellent{background:#f0fdf4;border-left:4px solid #10b981;}
.score-item.good{background:#fefce8;border-left:4px solid #eab308;}
.score-item.moderate{background:#fef3c7;border-left:4px solid #f59e0b;}
.score-item.poor{background:#fef2f2;border-left:4px solid #ef4444;}
.compliance-indicator{font-size:12px;font-weight:600;padding:4px 8px;border-radius:4px;display:inline-block;margin-top:4px;}
.compliance-indicator.compliant{background:#f0fdf4;color:#10b981;border:1px solid #10b981;}
.compliance-indicator.partial{background:#fefce8;color:#eab308;border:1px solid #eab308;}
.compliance-indicator.non-compliant{background:#fef2f2;color:#ef4444;border:1px solid #ef4444;}
.compliance-indicator.pending{background:#f3f4f6;color:#6b7280;border:1px solid #d1d5db;}
.regulatory-guidance{font-size:11px;color:#6b7280;margin-top:4px;padding:8px;background:#f9fafb;border-radius:4px;border-left:3px solid #3b82f6;}
.required-field{color:#ef4444;font-weight:bold;}
.compliance-report-item{padding:16px;background:#f8fafc;border-radius:8px;border:1px solid #e5e7eb;}
.compliance-status{font-weight:600;padding:4px 8px;border-radius:4px;display:inline-block;}
.compliance-status.compliant{background:#f0fdf4;color:#10b981;border:1px solid #10b981;}
.compliance-status.partial{background:#fefce8;color:#eab308;border:1px solid #eab308;}
.compliance-status.non-compliant{background:#fef2f2;color:#ef4444;border:1px solid #ef4444;}
.compliance-details{color:#6b7280;line-height:1.4;}
.recommendations-container{padding:16px;background:#f8fafc;border-radius:8px;border-left:4px solid #3b82f6;}
.red-flags-container{padding:12px;background:#fef2f2;border-radius:6px;border-left:3px solid #ef4444;}
.maturity-item{padding:12px;border-radius:8px;transition:all 0.3s ease;background:#f8fafc;border:1px solid #e5e7eb;}
.maturity-item.excellent{background:#f0fdf4;border-left:4px solid #10b981;}
.maturity-item.good{background:#fefce8;border-left:4px solid #eab308;}
.maturity-item.moderate{background:#fef3c7;border-left:4px solid #f59e0b;}
.maturity-item.poor{background:#fef2f2;border-left:4px solid #ef4444;}
/* Enhanced Header Styles */
.header-content {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
}

.header-main h1 {
  font-size: clamp(var(--font-size-2xl), 4vw, var(--font-size-4xl));
  font-weight: 300;
  color: var(--enterprise-text);
  margin: 0 0 var(--spacing-sm) 0;
  line-height: 1.2;
  letter-spacing: -0.5px;
}

.header-main h2 {
  font-size: clamp(var(--font-size-base), 2.5vw, var(--font-size-xl));
  font-weight: 300;
  color: var(--enterprise-text-light);
  margin: 0 0 var(--spacing-lg) 0;
  letter-spacing: 0.5px;
}

.header-badges {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.badge {
  padding: var(--spacing-sm) var(--spacing-md);
  border-radius: var(--border-radius);
  font-size: var(--font-size-xs);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 1px;
  border: 1px solid;
}

.badge-primary {
  background: var(--badge-primary-bg);
  color: var(--badge-primary-text);
  border-color: var(--badge-primary-border);
}

.badge-success {
  background: var(--badge-success-bg);
  color: var(--badge-success-text);
  border-color: var(--badge-success-border);
}

.badge-info {
  background: var(--badge-info-bg);
  color: var(--badge-info-text);
  border-color: var(--badge-info-border);
}

.badge-warning {
  background: var(--badge-warning-bg);
  color: var(--badge-warning-text);
  border-color: var(--badge-warning-border);
}

.header-info {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 16px;
}

.compliance-logos {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

.compliance-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px 12px;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  min-width: 60px;
}

.compliance-icon {
  font-size: var(--font-size-xs);
  font-weight: 700;
  color: var(--compliance-icon-text);
  background: var(--compliance-icon-bg);
  padding: var(--spacing-sm) var(--spacing-md);
  border-radius: var(--border-radius);
  border: 1px solid var(--compliance-icon-border);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  min-width: 50px;
  text-align: center;
}

.compliance-text {
  font-size: var(--font-size-xs);
  font-weight: 500;
  color: var(--compliance-text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: var(--spacing-xs);
}

.user-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-description {
  text-align: center;
  padding: var(--spacing-md);
  background: linear-gradient(135deg, var(--enterprise-dark), var(--enterprise-medium));
  border-radius: var(--border-radius);
  border: 1px solid var(--enterprise-light);
  margin-bottom: var(--spacing-lg);
}

.header-description p {
  margin: var(--spacing-xs) 0;
  color: var(--enterprise-text);
  font-size: var(--font-size-sm);
}

/* Enhanced Footer Styles */
.footer {
  background: linear-gradient(135deg, var(--enterprise-dark), var(--enterprise-medium));
  color: var(--enterprise-text);
  margin-top: var(--spacing-3xl);
  padding: var(--spacing-3xl) 0 var(--spacing-xl) 0;
  border-top: 2px solid var(--enterprise-light);
}

.footer-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

.footer-main {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 32px;
  margin-bottom: 32px;
}

.footer-section h4 {
  color: var(--enterprise-text);
  font-size: var(--font-size-sm);
  font-weight: 500;
  margin: 0 0 var(--spacing-md) 0;
  border-bottom: 1px solid var(--enterprise-light);
  padding-bottom: var(--spacing-sm);
  display: inline-block;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.footer-section p {
  color: var(--enterprise-text-light);
  font-size: var(--font-size-sm);
  line-height: 1.6;
  margin: var(--spacing-sm) 0;
}

.footer-badges {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.compliance-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.compliance-list span {
  color: #cbd5e1;
  font-size: 13px;
  padding: 4px 0;
}

.footer-bottom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 24px;
  border-top: 1px solid #475569;
  flex-wrap: wrap;
  gap: 16px;
}

.footer-info p {
  color: #94a3b8;
  font-size: 12px;
  margin: 4px 0;
}

.footer-links {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
}

.footer-links span {
  color: #94a3b8;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 4px;
}

/* Responsive Design - Mobile First Approach */
@media (max-width: 1200px) {
  .container {
    max-width: 100%;
    padding: 0 var(--spacing-lg);
  }
  
  .footer-content {
    padding: 0 var(--spacing-lg);
  }
}

@media (max-width: 768px) {
  /* Typography */
  .header-main h1 {
    font-size: clamp(var(--font-size-xl), 5vw, var(--font-size-3xl));
  }
  
  .header-main h2 {
    font-size: clamp(var(--font-size-sm), 3vw, var(--font-size-lg));
  }
  
  /* Layout */
  .header-content {
    flex-direction: column;
    gap: var(--spacing-lg);
    align-items: center;
  }
  
  .header-info {
    align-items: center;
    width: 100%;
  }
  
  .compliance-logos {
    justify-content: center;
    width: 100%;
    gap: var(--spacing-sm);
  }
  
  .compliance-item {
    min-width: 50px;
    padding: var(--spacing-sm);
  }
  
  .header-badges {
    justify-content: center;
    width: 100%;
  }
  
  .badge {
    font-size: var(--font-size-xs);
    padding: var(--spacing-xs) var(--spacing-sm);
  }
  
  /* Footer */
  .footer-main {
    grid-template-columns: 1fr;
    gap: var(--spacing-xl);
  }
  
  .footer-bottom {
    flex-direction: column;
    text-align: center;
    gap: var(--spacing-md);
  }
  
  .footer-links {
    justify-content: center;
    flex-wrap: wrap;
  }
  
  /* Cards */
  .card {
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
  }
  
  .card h2 {
    font-size: var(--font-size-lg);
  }
  
  /* Form Elements */
  .form-group {
    margin-bottom: var(--spacing-md);
  }
  
  .form-group label {
    font-size: var(--font-size-sm);
  }
  
  input[type=text], input[type=number], input[type=email], select, textarea {
    font-size: var(--font-size-base);
    padding: var(--spacing-md);
  }
  
  /* Progress Bar */
  .progress-header {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--spacing-md);
  }
  
  .progress-stats {
    flex-direction: column;
    gap: var(--spacing-sm);
    align-items: flex-start;
  }
  
  .section-status-grid {
    grid-template-columns: 1fr;
    gap: var(--spacing-sm);
  }
  
  .section-status-item {
    padding: var(--spacing-md);
  }
  
  .section-status-text {
    font-size: var(--font-size-sm);
  }
  
  .section-status-number {
    font-size: var(--font-size-xs);
  }
  
  /* Actions */
  .actions {
    flex-direction: column;
    gap: var(--spacing-md);
  }
  
  .actions button {
    width: 100%;
    padding: var(--spacing-md);
    font-size: var(--font-size-base);
  }
}

@media (max-width: 480px) {
  .container {
    padding: 0 var(--spacing-md);
  }
  
  .header {
    padding: var(--spacing-xl) var(--spacing-md);
  }
  
  .card {
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
  }
  
  .progress-percentage {
    font-size: var(--font-size-xl);
  }
  
  .section-status-item {
    padding: var(--spacing-sm);
  }
  
  .section-status-text {
    font-size: var(--font-size-xs);
  }
  
  .section-status-number {
    font-size: var(--font-size-xs);
  }
  
  .compliance-item {
    min-width: 40px;
    padding: var(--spacing-xs);
  }
  
  .compliance-icon {
    font-size: var(--font-size-xs);
    padding: var(--spacing-xs) var(--spacing-sm);
  }
  
  .compliance-text {
    font-size: var(--font-size-xs);
  }
}
.upload{border:2px dashed var(--border); padding:var(--spacing-xl); border-radius:var(--border-radius); background:var(--light); text-align:center; transition:var(--transition);}
.upload:hover{border-color:var(--primary);}
.upload.dragover{border-color:var(--primary); background:var(--badge-success-bg);}
.progress-bar{width:100%; height:8px; background:var(--border); border-radius:var(--border-radius); overflow:hidden; margin-top:var(--spacing-sm);}
.progress-fill{height:100%; background:var(--primary); transition:var(--transition);}
.notification{position:fixed;top:20px;right:20px;padding:16px 20px;border-radius:8px;color:white;font-weight:500;z-index:1000;transform:translateX(400px);transition:transform 0.3s;}
.notification.show{transform:translateX(0);}
.notification.success{background:var(--success);}
.notification.error{background:var(--error);}
.notification.warning{background:var(--warning);}
.loading{display:inline-block;width:20px;height:20px;border:2px solid #f3f3f3;border-top:2px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);overflow-y:auto;padding:20px;}
.modal-content{
  background:white;
  margin:2% auto;
  padding:24px;
  border-radius:12px;
  width:95%;
  max-width:500px;
  min-width:320px;
  box-shadow:var(--shadow-lg);
  position:relative;
  max-height:90vh;
  overflow-y:auto;
}
.close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer;}
.close:hover{color:#000;}

/* Mobile Responsive Styles */
@media (max-width: 768px) {
  .modal {
    padding: 10px;
  }
  
  .modal-content {
    margin: 5% auto;
    padding: 20px;
    width: 98%;
    max-width: none;
    min-width: 280px;
    max-height: 95vh;
  }
  
  .modal-content h2 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }
  
  .modal-content p {
    font-size: 0.9rem;
    line-height: 1.4;
  }
  
  .form-group {
    margin-bottom: 1rem;
  }
  
  .form-group label {
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }
  
  .form-group input,
  .form-group select {
    padding: 12px;
    font-size: 16px; /* Prevents zoom on iOS */
  }
  
  .btn {
    padding: 12px 20px;
    font-size: 0.9rem;
    width: 100%;
    margin-bottom: 10px;
  }
  
  .btn-group {
    flex-direction: column;
  }
  
  .btn-group .btn {
    margin-right: 0;
    margin-bottom: 10px;
  }
}

@media (max-width: 480px) {
  .modal-content {
    padding: 15px;
    margin: 2% auto;
  }
  
  .modal-content h2 {
    font-size: 1.3rem;
  }
  
  .modal-content p {
    font-size: 0.85rem;
  }
  
  .form-group input,
  .form-group select {
    padding: 10px;
  }
  
  /* Mobile Login Form Specific */
  .btn-group {
    flex-direction: column;
    gap: 8px;
  }
  
  .btn-group .btn {
    width: 100%;
    margin: 0;
  }
  
  .user-info {
    font-size: 11px;
    padding: 8px;
  }
  
  .security-notice {
    font-size: 11px;
    padding: 8px;
  }
}

/* Extra small devices (phones in portrait) */
@media (max-width: 360px) {
  .modal-content {
    padding: 12px;
    margin: 1% auto;
  }
  
  .modal-content h2 {
    font-size: 1.2rem;
  }
  
  .form-group input,
  .form-group select {
    padding: 8px;
    font-size: 14px;
  }
  
  .btn {
    padding: 10px 16px;
    font-size: 0.85rem;
  }
}

/* Chart Responsive Styles */
.chart-container {
  position: relative;
  width: 100%;
  height: 300px;
  margin: 0 auto;
}

.chart-container canvas {
  width: 100% !important;
  height: 100% !important;
  max-width: 100%;
  max-height: 100%;
}

/* Chart Grid Responsive - 2 charts per row */
.chart-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-top: 20px;
  width: 100%;
}

/* All screen sizes: 2 charts per row */
@media (min-width: 769px) {
  .chart-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

.chart-grid .chart-item {
  display: flex;
  flex-direction: column;
  min-height: 380px;
  justify-content: space-between;
}

.chart-grid .chart-item h3 {
  margin-bottom: 15px;
  text-align: center;
  font-size: 1.1rem;
  font-weight: 600;
}

.chart-grid .chart-item .chart-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 250px;
  padding: 10px;
}

/* Large mobile and tablets: 2 charts per row */
@media (max-width: 768px) and (min-width: 481px) {
  .chart-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
  }
  
  .chart-grid .chart-item {
    min-height: 300px;
  }
  
  .chart-container {
    height: 250px;
  }
  
  .chart-container canvas {
    height: 250px !important;
  }
}

/* Very small mobile: 1 chart per row */
@media (max-width: 480px) {
  .chart-grid {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  .chart-grid .chart-item {
    min-height: 250px;
  }
  
  .chart-container {
    height: 200px;
  }
  
  .chart-container canvas {
    height: 200px !important;
  }
  
  .chart-grid .chart-item h3 {
    font-size: 1rem;
    margin-bottom: 10px;
  }
}

/* Dashboard Cards Responsive */
@media (max-width: 768px) {
  .dashboard-grid {
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 12px !important;
  }
  
  .dashboard-card {
    padding: 15px !important;
  }
  
  .dashboard-card .metric {
    font-size: 24px !important;
  }
  
  .dashboard-card .title {
    font-size: 12px !important;
  }
  
  .dashboard-card .subtitle {
    font-size: 10px !important;
  }
}

@media (max-width: 480px) {
  .dashboard-grid {
    grid-template-columns: 1fr !important;
    gap: 10px !important;
  }
}
/* Collapsible Sections */
.section-header {
  cursor: pointer;
  user-select: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: linear-gradient(135deg, #f8fafc, #e2e8f0);
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  margin-bottom: 10px;
  transition: all 0.3s ease;
}

.section-header:hover {
  background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
}

.section-header h2 {
  margin: 0;
  color: var(--primary);
  font-size: 1.2em;
}

.section-toggle {
  font-size: 1.5em;
  color: var(--primary);
  transition: transform 0.3s ease;
}

.section-toggle.collapsed {
  transform: rotate(-90deg);
}

.section-content {
  overflow: hidden;
  transition: max-height 0.3s ease, opacity 0.3s ease;
  max-height: 2000px;
  opacity: 1;
}

.section-content.collapsed {
  max-height: 0;
  opacity: 0;
  margin-bottom: 0;
}

.card {
  margin-bottom: 20px;
}

.card.collapsed {
  margin-bottom: 10px;
}

.password-hint {
  font-size: 12px;
  color: #6b7280;
  margin-top: 5px;
  font-style: italic;
}

.user-info {
  padding: 10px;
  background: #f0f9ff;
  border-radius: 6px;
  margin: 10px 0;
  font-size: 12px;
  border-left: 3px solid #3b82f6;
}

.security-notice {
  margin-top: 15px;
  padding: 10px;
  background: #fef3c7;
  border-radius: 6px;
  font-size: 12px;
  color: #92400e;
  border-left: 3px solid #f59e0b;
}

/* Progress Bar & Section Status */
.progress-container {
  padding: 20px;
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.progress-stats {
  display: flex;
  gap: 20px;
  align-items: center;
}

.progress-percentage {
  font-size: 24px;
  font-weight: bold;
  color: #15803d;
}

.progress-sections {
  font-size: 14px;
  color: #6b7280;
  background: white;
  padding: 4px 12px;
  border-radius: 20px;
  border: 1px solid #e5e7eb;
}

.progress-bar {
  width: 100%;
  height: 12px;
  background: #e5e7eb;
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 20px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #16a34a, #22c55e);
  border-radius: 6px;
  transition: width 0.5s ease;
  width: 0%;
}

.section-status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
}

.section-status-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: white;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  transition: all 0.3s ease;
}

.section-status-item:hover {
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.section-status-icon {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
}

.section-status-icon.pending {
  background: var(--status-pending-bg);
  color: var(--status-pending-text);
  border: 1px solid var(--status-pending-border);
}

.section-status-icon.in-progress {
  background: var(--status-progress-bg);
  color: var(--status-progress-text);
  border: 1px solid var(--status-progress-border);
}

.section-status-icon.completed {
  background: var(--status-completed-bg);
  color: var(--status-completed-text);
  border: 1px solid var(--status-completed-border);
}

.section-status-text {
  flex: 1;
  font-size: 14px;
  color: #374151;
}

.section-status-number {
  font-size: 12px;
  color: #6b7280;
  font-weight: 500;
}

/* Enhanced Form Validation Styles */
.form-group input.valid,
.form-group select.valid,
.form-group textarea.valid {
  border-color: #16a34a;
  background-color: #f0fdf4;
}

.form-group input.error,
.form-group select.error,
.form-group textarea.error {
  border-color: #dc2626;
  background-color: #fef2f2;
  animation: shake 0.5s ease-in-out;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.field-tooltip {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Progress Bar Animations */
.progress-fill {
  transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

.section-status-item {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.section-status-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Loading States */
.loading-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .grid{grid-template-columns:1fr;}
  .actions{justify-content:stretch;}
  button{flex:1;}
  .container{padding:0 16px 32px;}
  .card{padding:20px;}
  
  /* Mobile Progress Bar */
  .progress-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .progress-stats {
    flex-direction: column;
    gap: 8px;
    align-items: flex-start;
  }
  
  .section-status-grid {
    grid-template-columns: 1fr;
  }
  
  .section-status-item {
    padding: 12px;
  }
  
  .section-status-text {
    font-size: 13px;
  }
  
  /* Mobile Form Improvements */
  .form-group {
    margin-bottom: 16px;
  }
  
  .form-group label {
    font-size: 14px;
    margin-bottom: 6px;
  }
  
  .form-group input,
  .form-group select,
  .form-group textarea {
    font-size: 16px; /* Prevents zoom on iOS */
    padding: 12px;
  }
  
  /* Mobile Section Headers */
  .section-header {
    padding: 12px 16px;
  }
  
  .section-header h2 {
    font-size: 16px;
    line-height: 1.4;
  }
  
  .section-toggle {
    font-size: 18px;
  }
  
  /* Mobile Actions */
  .actions {
    flex-direction: column;
    gap: 12px;
  }
  
  .actions button {
    width: 100%;
    padding: 14px;
    font-size: 16px;
  }
}

@media (max-width: 480px) {
  .container {
    padding: 12px;
  }
  
  .progress-percentage {
    font-size: 20px;
  }
  
  .section-status-item {
    padding: 10px;
  }
  
  .section-status-text {
    font-size: 12px;
  }
  
  .section-status-number {
    font-size: 11px;
  }
}

/* Professional Header & Footer Responsive Design */
@media (max-width: 768px) {
  /* Header Responsive */
  .header-main .container {
    padding: 0 15px;
  }
  
  .header-main > div:first-child {
    flex-direction: column;
    gap: 15px;
    text-align: center;
  }
  
  .header-brand {
    justify-content: center;
  }
  
  .title-section h1 {
    font-size: 24px !important;
  }
  
  .title-section h2 {
    font-size: 18px !important;
  }
  
  .form-metadata-grid {
    grid-template-columns: 1fr !important;
    gap: 15px !important;
  }
  
  .metadata-card {
    padding: 12px !important;
  }
  
  .title-section > div {
    flex-direction: column !important;
    gap: 10px !important;
  }
  
  #settingsToggle, #stampToggle {
    width: 100% !important;
    justify-content: center !important;
  }
  
  /* Footer Responsive */
  .footer-grid {
    grid-template-columns: 1fr !important;
    gap: 20px !important;
  }
  
  .footer-bottom .container > div {
    flex-direction: column;
    text-align: center;
    gap: 15px;
  }
  
  .footer-security {
    flex-direction: column;
    gap: 10px !important;
  }
}

@media (max-width: 480px) {
  .header-top-bar .container {
    padding: 0 10px;
  }
  
  .header-main-content .container {
    padding: 0 10px;
  }
  
  .title-section h1 {
    font-size: 24px !important;
  }
  
  .title-section h2 {
    font-size: 18px !important;
  }
  
  .metadata-card {
    padding: 12px !important;
  }
  
  .metadata-card h4 {
    font-size: 14px !important;
  }
  
  .footer-main .container {
    padding: 0 10px;
  }
  
  .footer-section {
    text-align: center;
  }
  
  .footer-brand {
    justify-content: center;
  }
}

/* Digital Stamp Animations */
@keyframes pulse {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 0.6; }
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0.3; }
}

/* Digital Stamp Responsive */
@media (max-width: 768px) {
  .session-grid {
    grid-template-columns: 1fr !important;
    gap: 12px !important;
  }
  
  .stamp-container {
    padding: 25px !important;
  }
  
  .session-card {
    padding: 20px !important;
  }
  
  .session-grid {
    gap: 20px !important;
    margin-bottom: 25px !important;
  }
  
  .stamp-footer {
    padding-top: 20px !important;
    margin-top: 10px !important;
  }
  
  .stamp-header h3 {
    font-size: 16px !important;
  }
}
</style>
  <!-- Loading Screen -->
  <div id="loadingScreen" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    color: white;
    font-family: Arial, sans-serif;
  ">
    <div style="text-align: center;">
      <div style="
        width: 50px;
        height: 50px;
        border: 3px solid #334155;
        border-top: 3px solid #0ea5e9;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      "></div>
      <h2 style="margin-bottom: 10px; color: #e2e8f0;">Loading KSA-ICSQ-2025</h2>
      <p style="color: #94a3b8;">Initializing cybersecurity assessment form...</p>
    </div>
  </div>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <!-- NO AUTHENTICATION REQUIRED - Form self-destructs after 30 days -->
  <div id="authModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>ğŸ” Authorization Required / Ù…Ø·Ù„ÙˆØ¨ ØªÙÙˆÙŠØ¶</h2>
      <p>Please select your user level and enter your password to access the cybersecurity assessment tool.</p>
      <p>ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø£Ø¯Ø§Ø© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ.</p>
      
      <div class="form-group">
        <label for="userLevel">User Level / Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… *</label>
        <select id="userLevel" onchange="updateCredentials()" required>
          <option value="">Select User Level / Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</option>
          <option value="trustit" selected>ğŸ¢ TUV Austria Trust IT Team / ÙØ±ÙŠÙ‚ ØªÙŠ ÙŠÙˆ ÙÙŠ Ø§Ù„Ù†Ù…Ø³Ø§ Ù„Ù„Ø«Ù‚Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ©</option>
          <option value="customer">TUV Customer / Ø¹Ù…ÙŠÙ„ ØªÙŠ ÙŠÙˆ ÙÙŠ</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="username">Username / Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
        <input type="text" id="username" value="Trust-it@tuvautria.sa" readonly style="background-color: #f3f4f6; color: #6b7280; border: 2px solid #d1d5db;"/>
        <div style="font-size: 11px; color: #6b7280; margin-top: 3px;">ğŸ“§ Email: Trust-it@tuvautria.sa</div>
      </div>
      
      <div class="form-group">
        <label for="password">Password / ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label>
        <input type="password" id="password" value="TUV2025Secure!" readonly style="background-color: #f3f4f6; color: #6b7280; border: 2px solid #d1d5db;"/>
        <div style="font-size: 11px; color: #6b7280; margin-top: 3px;">ğŸ” Password: TUV2025Secure!</div>
        <div id="passwordHint" class="password-hint" style="display: none; font-size: 12px; color: #6b7280; margin-top: 5px;"></div>
      </div>
      
      <div class="form-group">
        <label for="organization">Organization / Ø§Ù„Ù…Ù†Ø¸Ù…Ø©</label>
        <input type="text" id="organization" value="TUV Austria Trust IT Team" readonly style="background-color: #f3f4f6; color: #6b7280; border: 2px solid #d1d5db;"/>
        <div style="font-size: 11px; color: #6b7280; margin-top: 3px;">ğŸ¢ Code: TUV-AUT-001 | Level: Trust IT Team</div>
      </div>
      
      <!-- Customer Access Section -->
      <div id="customerAccess" style="display: none; margin-top: 20px; padding: 15px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px;">
        <h4 style="margin: 0 0 10px 0; color: #0c4a6e;">Customer Access / ÙˆØµÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h4>
        <p style="margin: 0 0 15px 0; font-size: 14px; color: #1e40af;">
          This form is exclusively for TUV Austria customers. Please contact TUV Austria Trust IT for access credentials.
        </p>
        <div class="form-group">
          <label for="customerCode">Customer Code / Ø±Ù…Ø² Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
          <input type="text" id="customerCode" placeholder="Enter your TUV customer code" required/>
        </div>
        <div class="form-group">
          <label for="customerPassword">Customer Password / ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
          <input type="password" id="customerPassword" placeholder="Enter your customer password" required/>
        </div>
      </div>
      
      <div class="user-info" id="userInfoModal" style="display: none; padding: 10px; background: #f0f9ff; border-radius: 6px; margin: 10px 0; font-size: 12px;">
        <strong>User Information:</strong>
        <div id="userDetails"></div>
      </div>
      
      <div class="btn-group" style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="primary" onclick="authenticateUser()" style="flex: 1; min-width: 200px;">Login / ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button class="secondary" onclick="testTUVLogin()" style="flex: 1; min-width: 200px;">Test TUV Login</button>
      </div>
      <div id="authError" class="error-message" style="display: none; margin-top: 15px; padding: 10px; background: #fee2e2; border: 1px solid #fecaca; border-radius: 6px; color: #dc2626;"></div>
      
      <div class="security-notice" style="margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 12px; color: #92400e;">
        <strong>ğŸ”’ Security Notice:</strong> If you need admin or auditor access, please contact your CISO or the <a href="https://www.doganconsult.com" target="_blank" style="color: #92400e; text-decoration: underline;">DoganConsult</a> team at +966 500666084. Unauthorized access attempts are logged and monitored.
        <br><strong>Ø¥Ø´Ø¹Ø§Ø± Ø£Ù…Ù†ÙŠ:</strong> Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ÙˆØµÙˆÙ„ Ù…Ø¯ÙŠØ± Ø£Ùˆ Ù…Ø¯Ù‚Ù‚ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø¯ÙŠØ± Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ Ø£Ùˆ ÙØ±ÙŠÙ‚ <a href="https://www.doganconsult.com" target="_blank" style="color: #92400e; text-decoration: underline;">Ø¯ÙˆØ¬Ø§Ù† ÙƒÙˆÙ†Ø³Ù„Øª</a> Ø¹Ù„Ù‰ +966 500666084. Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙˆØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡Ø§ Ù…Ø³Ø¬Ù„Ø© ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø©.
      </div>
    </div>
  </div>

  <div class="header" id="mainContent" style="display: block;">
    <!-- Simplified Header -->
    <div class="header-main" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 25px 0; border-bottom: 1px solid #334155;">
      <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
        <!-- Header Top Row -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <div class="header-brand" style="display: flex; align-items: center; gap: 12px;">
            <div class="brand-logo" style="width: 36px; height: 36px; background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
              KSA
        </div>
            <div class="brand-info">
              <div style="color: #f1f5f9; font-size: 13px; font-weight: 600;">KSA-ICSQ-2025</div>
              <div style="color: #94a3b8; font-size: 10px;">Insurance Cybersecurity Assessment</div>
      </div>
          </div>
          <div class="header-actions" style="display: flex; align-items: center; gap: 12px;">
            <span id="userInfo" style="color: #e2e8f0; font-size: 12px; font-weight: 500;"></span>
            <button class="logout-btn" onclick="logout()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #e2e8f0; padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.2s;">
              Logout / ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            </button>
          </div>
          </div>
          
          <!-- License Status Section -->
          <div id="licenseStatus" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 12px; margin: 15px 0; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 16px;">ğŸ”‘</span>
                <div>
                  <div style="color: #10b981; font-size: 12px; font-weight: 600;">License Status</div>
                  <div id="licenseStatusText" style="color: #f1f5f9; font-size: 11px;">Loading...</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 15px;">
                <div style="text-align: center;">
                  <div style="color: #94a3b8; font-size: 10px;">Days Remaining</div>
                  <div id="daysRemaining" style="color: #10b981; font-size: 16px; font-weight: 700;">--</div>
                </div>
                <div style="text-align: center;">
                  <div style="color: #94a3b8; font-size: 10px;">Expires</div>
                  <div id="licenseExpiry" style="color: #f1f5f9; font-size: 11px; font-weight: 500;">--</div>
                </div>
                <div style="text-align: center;">
                  <div style="color: #94a3b8; font-size: 10px;">Countdown</div>
                  <div id="renewalCountdown" style="color: #f59e0b; font-size: 11px; font-weight: 600;">--:--:--</div>
                </div>
              </div>
          </div>
          </div>

        <!-- Title Section -->
        <div class="title-section" style="text-align: center; margin-bottom: 15px;">
          <h1 style="color: #f8fafc; font-size: 28px; font-weight: 700; margin: 0 0 8px 0; line-height: 1.2;">
            Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„ØªØ£Ù…ÙŠÙ†
          </h1>
          <h2 style="color: #e2e8f0; font-size: 20px; font-weight: 600; margin: 0 0 15px 0; line-height: 1.3;">
            KSA-ICSQ-2025 â€” Insurance Cybersecurity Self-Assessment Questionnaire
          </h2>
          <div style="display: flex; justify-content: center; align-items: center; gap: 12px; flex-wrap: wrap;">
            <button id="settingsToggle" onclick="toggleSettings()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #e2e8f0; padding: 6px 14px; border-radius: 16px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;">
              <span style="font-size: 14px;">âš™ï¸</span> Details / Ø§Ù„ØªÙØ§ØµÙŠÙ„
            </button>
            <button id="stampToggle" onclick="toggleDigitalStamp()" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981; padding: 6px 14px; border-radius: 16px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;">
              <span style="font-size: 14px;">ğŸ”’</span> Digital Stamp / Ø§Ù„Ø®ØªÙ… Ø§Ù„Ø±Ù‚Ù…ÙŠ
            </button>
            <button id="infoToggle" onclick="toggleInfo()" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6; padding: 6px 14px; border-radius: 16px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;">
              <span style="font-size: 14px;">â„¹ï¸</span> Info / Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
            </button>
            <div id="expirationCounter" style="
              background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
              color: white;
              padding: 6px 14px;
              border-radius: 16px;
              font-size: 12px;
              font-weight: bold;
              display: flex;
              align-items: center;
              gap: 6px;
            ">
              <span style="font-size: 14px;">â°</span> <span id="daysRemaining">30</span> days left
            </div>
          </div>
        </div>

        <!-- Collapsible Settings/Details Section -->
        <div id="settingsDetails" style="display: none; margin-bottom: 20px;">
          <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; backdrop-filter: blur(10px);">
            <div class="form-metadata-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
              <!-- Form Information Card -->
              <div class="metadata-card" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px;">
                <h4 style="color: #0ea5e9; font-size: 14px; font-weight: 600; margin: 0 0 12px 0; display: flex; align-items: center; gap: 6px;">
                  <span style="font-size: 16px;">ğŸ“‹</span> Form Information
                </h4>
                <div style="display: grid; gap: 6px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Form ID:</span>
                    <span style="color: #f1f5f9; font-size: 12px; font-weight: 500;">KSA-ICSQ-2025</span>
        </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Classification:</span>
                    <span style="color: #f1f5f9; font-size: 12px; font-weight: 500;">Internal Use</span>
      </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Last Updated:</span>
                    <span style="color: #f1f5f9; font-size: 12px; font-weight: 500;">January 2025</span>
    </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Platform:</span>
                    <span style="color: #0ea5e9; font-size: 12px; font-weight: 500;">Shahin-AI</span>
    </div>
        </div>
      </div>

              <!-- Compliance & Standards Card -->
              <div class="metadata-card" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px;">
                <h4 style="color: #10b981; font-size: 14px; font-weight: 600; margin: 0 0 12px 0; display: flex; align-items: center; gap: 6px;">
                  <span style="font-size: 16px;">ğŸ›¡ï¸</span> Compliance & Standards
                </h4>
                <div style="display: grid; gap: 6px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Compliance:</span>
                    <span style="color: #f1f5f9; font-size: 12px; font-weight: 500;">SAMA-CSF, NCA-ECC v2.0, PDPL</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Standards:</span>
                    <span style="color: #f1f5f9; font-size: 12px; font-weight: 500;">ISO 27001, SOC 2 Type II</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Language:</span>
                    <span style="color: #f1f5f9; font-size: 12px; font-weight: 500;">Arabic/English (Bilingual)</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Validation:</span>
                    <span style="color: #f1f5f9; font-size: 12px; font-weight: 500;">Real-time + Batch</span>
                  </div>
                </div>
              </div>

              <!-- Technical Specifications Card -->
              <div class="metadata-card" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px;">
                <h4 style="color: #f59e0b; font-size: 14px; font-weight: 600; margin: 0 0 12px 0; display: flex; align-items: center; gap: 6px;">
                  <span style="font-size: 16px;">âš™ï¸</span> Technical Specifications
                </h4>
                <div style="display: grid; gap: 6px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Code Coverage:</span>
                    <span style="color: #10b981; font-size: 12px; font-weight: 500;">93.1%</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Security Level:</span>
                    <span style="color: #10b981; font-size: 12px; font-weight: 500;">A+</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Performance:</span>
                    <span style="color: #10b981; font-size: 12px; font-weight: 500;">A</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Naming Convention:</span>
                    <span style="color: #f1f5f9; font-size: 12px; font-weight: 500;">KSA-ICSQ-2025</span>
                  </div>
                </div>
              </div>

              <!-- Contact Information Card -->
              <div class="metadata-card" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px;">
                <h4 style="color: #8b5cf6; font-size: 14px; font-weight: 600; margin: 0 0 12px 0; display: flex; align-items: center; gap: 6px;">
                  <span style="font-size: 16px;">ğŸ“</span> Contact Information
                </h4>
                <div style="display: grid; gap: 6px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Phone:</span>
                    <span style="color: #f1f5f9; font-size: 12px; font-weight: 500;">+966 500666084</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Email:</span>
                    <span style="color: #0ea5e9; font-size: 12px; font-weight: 500;">support@doganconsult.com</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Website:</span>
                    <span style="color: #0ea5e9; font-size: 12px; font-weight: 500;">www.doganconsult.com</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #94a3b8; font-size: 12px;">Platform:</span>
                    <span style="color: #0ea5e9; font-size: 12px; font-weight: 500;">www.shahin-ai.com</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Description Section -->
        <div class="header-description" style="text-align: center; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 6px; border: 1px solid rgba(255,255,255,0.1);">
          <p style="color: #cbd5e1; font-size: 12px; margin: 0; font-weight: 500;">
            Professional Insurance Cybersecurity Assessment Tool â€” Shahin-AI Platform Module
          </p>
        </div>
      </div>
    </div>

    <!-- Digital Stamp - Cyber Master Design (Collapsible) -->
    <div id="digitalStampSection" class="digital-stamp" style="display: none; margin: 30px 0; padding: 0 30px;">
      <div class="container" style="max-width: 1200px; margin: 0 auto;">
        <div class="stamp-container" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border: 2px solid #10b981; border-radius: 12px; padding: 30px; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
          <!-- Animated Background -->
          <div class="stamp-bg" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, rgba(14, 165, 233, 0.1) 0%, rgba(59, 130, 246, 0.1) 50%, rgba(139, 92, 246, 0.1) 100%); animation: pulse 3s ease-in-out infinite;"></div>
          
          <!-- Header -->
          <div class="stamp-header" style="text-align: center; margin-bottom: 30px; position: relative; z-index: 2;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
              <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 50%, #8b5cf6 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: rotate 10s linear infinite; box-shadow: 0 0 20px rgba(14, 165, 233, 0.5);">
                <span style="font-size: 22px;">ğŸ”</span>
              </div>
              <div>
                <h3 style="color: #0ea5e9; font-size: 22px; font-weight: 800; margin: 0; text-shadow: 0 0 15px rgba(14, 165, 233, 0.6); letter-spacing: 1px;">
                  ADVANCED DIGITAL STAMP / Ø§Ù„Ø®ØªÙ… Ø§Ù„Ø±Ù‚Ù…ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
              </h3>
                <p style="color: #94a3b8; font-size: 11px; margin: 5px 0 0 0; font-family: 'Courier New', monospace; letter-spacing: 0.5px;">
                  ENTERPRISE CYBERSECURITY ASSESSMENT & COMPLIANCE AUDIT SESSION
                </p>
                <p style="color: #64748b; font-size: 10px; margin: 2px 0 0 0; font-family: 'Courier New', monospace;">
                  Ø¬Ù„Ø³Ø© ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ ÙˆØ§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
                </p>
            </div>
            </div>
            <div style="background: linear-gradient(90deg, rgba(14, 165, 233, 0.1) 0%, rgba(59, 130, 246, 0.1) 50%, rgba(139, 92, 246, 0.1) 100%); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 8px; padding: 12px; margin-top: 10px;">
              <p style="color: #0ea5e9; font-size: 12px; margin: 0; font-weight: 600; font-family: 'Courier New', monospace;">
                ğŸ”’ ENCRYPTED SESSION | ğŸ›¡ï¸ COMPLIANCE VERIFIED | âš¡ REAL-TIME MONITORING
              </p>
            </div>
          </div>

          <!-- Session Information Grid -->
          <div class="session-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 25px; position: relative; z-index: 2;">
            
            <!-- Session Details -->
            <div class="session-card" style="background: linear-gradient(135deg, rgba(14, 165, 233, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%); border: 1px solid rgba(14, 165, 233, 0.4); border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2);">
              <h4 style="color: #0ea5e9; font-size: 16px; font-weight: 700; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px; text-shadow: 0 0 10px rgba(14, 165, 233, 0.3);">
                <span style="font-size: 18px;">ğŸ•</span> SESSION INTELLIGENCE
                <span style="background: rgba(14, 165, 233, 0.2); padding: 2px 8px; border-radius: 4px; font-size: 10px; color: #0ea5e9;">LIVE</span>
              </h4>
              <div style="display: grid; gap: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(14, 165, 233, 0.05); border-radius: 6px; border-left: 3px solid #0ea5e9;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Assessment Date:</span>
                  <span id="stampDate" style="color: #f1f5f9; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(14, 165, 233, 0.05); border-radius: 6px; border-left: 3px solid #0ea5e9;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">UTC Time:</span>
                  <span id="stampTime" style="color: #f1f5f9; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(14, 165, 233, 0.1); border-radius: 6px; border-left: 3px solid #0ea5e9;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Session ID:</span>
                  <span id="sessionId" style="color: #0ea5e9; font-size: 11px; font-weight: 700; font-family: 'Courier New', monospace; text-shadow: 0 0 5px rgba(14, 165, 233, 0.5);">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Active Duration:</span>
                  <span id="sessionDuration" style="color: #10b981; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">00:00:00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(14, 165, 233, 0.05); border-radius: 6px; border-left: 3px solid #0ea5e9;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Geolocation:</span>
                  <span id="stampLocation" style="color: #f1f5f9; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(14, 165, 233, 0.05); border-radius: 6px; border-left: 3px solid #0ea5e9;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Authenticated User:</span>
                  <span id="stampUser" style="color: #f1f5f9; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(14, 165, 233, 0.05); border-radius: 6px; border-left: 3px solid #0ea5e9;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Organization:</span>
                  <span id="stampOrg" style="color: #f1f5f9; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(14, 165, 233, 0.1); border-radius: 6px; border-left: 3px solid #0ea5e9;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Public IP:</span>
                  <span id="stampIP" style="color: #0ea5e9; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">License Status:</span>
                  <span id="stampLicense" style="color: #10b981; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
              </div>
            </div>

            <!-- Device Information -->
            <div class="session-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(34, 197, 94, 0.1) 100%); border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);">
              <h4 style="color: #10b981; font-size: 16px; font-weight: 700; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px; text-shadow: 0 0 10px rgba(16, 185, 129, 0.3);">
                <span style="font-size: 18px;">ğŸ’»</span> TECHNICAL ENVIRONMENT
                <span style="background: rgba(16, 185, 129, 0.2); padding: 2px 8px; border-radius: 4px; font-size: 10px; color: #10b981;">SCANNED</span>
              </h4>
              <div style="display: grid; gap: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.05); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Network IP:</span>
                  <span id="deviceIP" style="color: #10b981; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.05); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Browser Engine:</span>
                  <span id="deviceBrowser" style="color: #f1f5f9; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.05); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Operating System:</span>
                  <span id="deviceOS" style="color: #f1f5f9; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Display Resolution:</span>
                  <span id="deviceScreen" style="color: #10b981; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.05); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">User Agent:</span>
                  <span id="deviceUserAgent" style="color: #f1f5f9; font-size: 10px; font-weight: 500; font-family: 'Courier New', monospace; max-width: 150px; overflow: hidden; text-overflow: ellipsis;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.05); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Language:</span>
                  <span id="deviceLanguage" style="color: #f1f5f9; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Connection:</span>
                  <span id="deviceConnection" style="color: #10b981; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">SECURE</span>
                </div>
              </div>
            </div>

            <!-- User Information -->
            <div class="session-card" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(168, 85, 247, 0.1) 100%); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.2);">
              <h4 style="color: #8b5cf6; font-size: 16px; font-weight: 700; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px; text-shadow: 0 0 10px rgba(139, 92, 246, 0.3);">
                <span style="font-size: 18px;">ğŸ‘¤</span> AUTHENTICATION PROFILE
                <span style="background: rgba(139, 92, 246, 0.2); padding: 2px 8px; border-radius: 4px; font-size: 10px; color: #8b5cf6;">VERIFIED</span>
              </h4>
              <div style="display: grid; gap: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(139, 92, 246, 0.05); border-radius: 6px; border-left: 3px solid #8b5cf6;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">User Identity:</span>
                  <span id="stampUser" style="color: #8b5cf6; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(139, 92, 246, 0.05); border-radius: 6px; border-left: 3px solid #8b5cf6;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Organization:</span>
                  <span id="stampOrg" style="color: #f1f5f9; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(139, 92, 246, 0.1); border-radius: 6px; border-left: 3px solid #8b5cf6;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Access Level:</span>
                  <span id="stampLevel" style="color: #8b5cf6; font-size: 11px; font-weight: 700; font-family: 'Courier New', monospace; text-shadow: 0 0 5px rgba(139, 92, 246, 0.5);">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(139, 92, 246, 0.05); border-radius: 6px; border-left: 3px solid #8b5cf6;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Geographic Location:</span>
                  <span id="stampLocation" style="color: #f1f5f9; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(139, 92, 246, 0.05); border-radius: 6px; border-left: 3px solid #8b5cf6;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Session Type:</span>
                  <span style="color: #8b5cf6; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">ASSESSMENT</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(139, 92, 246, 0.1); border-radius: 6px; border-left: 3px solid #8b5cf6;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Authentication:</span>
                  <span style="color: #10b981; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">MULTI-FACTOR</span>
                </div>
              </div>
            </div>

            <!-- Security Status -->
            <div class="session-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(251, 191, 36, 0.1) 100%); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.2);">
              <h4 style="color: #f59e0b; font-size: 16px; font-weight: 700; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px; text-shadow: 0 0 10px rgba(245, 158, 11, 0.3);">
                <span style="font-size: 18px;">ğŸ›¡ï¸</span> SECURITY & COMPLIANCE
                <span style="background: rgba(245, 158, 11, 0.2); padding: 2px 8px; border-radius: 4px; font-size: 10px; color: #f59e0b;">CERTIFIED</span>
              </h4>
              <div style="display: grid; gap: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Data Encryption:</span>
                  <span style="color: #10b981; font-size: 11px; font-weight: 700; font-family: 'Courier New', monospace; text-shadow: 0 0 5px rgba(16, 185, 129, 0.5);">AES-256</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Transport Protocol:</span>
                  <span style="color: #10b981; font-size: 11px; font-weight: 700; font-family: 'Courier New', monospace;">TLS 1.3</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Security Status:</span>
                  <span style="color: #10b981; font-size: 11px; font-weight: 700; font-family: 'Courier New', monospace;">FORTIFIED</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 6px; border-left: 3px solid #f59e0b;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Assessment ID:</span>
                  <span style="color: #f59e0b; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">KSA-ICSQ-2025</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Compliance:</span>
                  <span style="color: #10b981; font-size: 11px; font-weight: 700; font-family: 'Courier New', monospace;">SAMA/NCA/PDPL</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Audit Trail:</span>
                  <span style="color: #10b981; font-size: 11px; font-weight: 700; font-family: 'Courier New', monospace;">ENABLED</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 3px solid #10b981;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace; font-weight: 600;">Threat Level:</span>
                  <span style="color: #10b981; font-size: 11px; font-weight: 700; font-family: 'Courier New', monospace;">LOW</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div class="stamp-footer" style="text-align: center; border-top: 2px solid rgba(14, 165, 233, 0.4); padding-top: 25px; margin-top: 15px; position: relative; z-index: 2;">
            <div style="background: linear-gradient(90deg, rgba(14, 165, 233, 0.1) 0%, rgba(59, 130, 246, 0.1) 50%, rgba(139, 92, 246, 0.1) 100%); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
              <p style="color: #0ea5e9; font-size: 12px; margin: 0 0 8px 0; font-weight: 700; font-family: 'Courier New', monospace; text-shadow: 0 0 10px rgba(14, 165, 233, 0.3);">
                ğŸ” ENTERPRISE CYBERSECURITY ASSESSMENT PLATFORM
              </p>
              <p style="color: #94a3b8; font-size: 10px; margin: 0; font-family: 'Courier New', monospace;">
                Generated by KSA-ICSQ-2025 | <a href="https://www.shahin-ai.com" target="_blank" style="color: #0ea5e9; text-decoration: none; font-weight: 600;">Shahin-AI Platform</a> | <a href="https://www.doganconsult.com" target="_blank" style="color: #0ea5e9; text-decoration: none; font-weight: 600;">DoganConsult</a>
              </p>
              <p style="color: #64748b; font-size: 9px; margin: 5px 0 0 0; font-family: 'Courier New', monospace;">
                Dr. Ahmed Dogan - Accredited ICT Consultant | Certified Cybersecurity Expert | SAMA/NCA/PDPL Compliance Specialist
              </p>
            </div>
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 10px; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(16, 185, 129, 0.1); border-radius: 20px; border: 1px solid rgba(16, 185, 129, 0.3);">
                <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: blink 2s infinite;"></div>
                <span style="color: #10b981; font-size: 10px; font-weight: 700;">LIVE SESSION</span>
              </div>
              <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(14, 165, 233, 0.1); border-radius: 20px; border: 1px solid rgba(14, 165, 233, 0.3);">
                <div style="width: 8px; height: 8px; background: #0ea5e9; border-radius: 50%; animation: blink 2s infinite 1s;"></div>
                <span style="color: #0ea5e9; font-size: 10px; font-weight: 700;">AES-256 ENCRYPTED</span>
              </div>
              <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(139, 92, 246, 0.1); border-radius: 20px; border: 1px solid rgba(139, 92, 246, 0.3);">
                <div style="width: 8px; height: 8px; background: #8b5cf6; border-radius: 50%; animation: blink 2s infinite 2s;"></div>
                <span style="color: #8b5cf6; font-size: 10px; font-weight: 700;">AUDIT TRAIL</span>
              </div>
              <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(245, 158, 11, 0.1); border-radius: 20px; border: 1px solid rgba(245, 158, 11, 0.3);">
                <div style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%; animation: blink 2s infinite 3s;"></div>
                <span style="color: #f59e0b; font-size: 10px; font-weight: 700;">COMPLIANCE</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Information Section (Collapsible) -->
    <div id="infoSection" style="display: none; margin: 30px 0; padding: 0 30px;">
      <div class="container" style="max-width: 1200px; margin: 0 auto;">
        <div class="info-container" style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: 30px; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);">
          <!-- Header -->
          <div class="info-header" style="text-align: center; margin-bottom: 25px; position: relative; z-index: 2;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <span style="font-size: 18px;">â„¹ï¸</span>
              </div>
              <h3 style="color: #f8fafc; font-size: 24px; font-weight: 700; margin: 0;">
                System Information / Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
              </h3>
            </div>
            <p style="color: #94a3b8; font-size: 12px; margin: 0; font-family: 'Courier New', monospace;">
              LICENSE & SYSTEM STATUS | Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±Ø®ÙŠØµ ÙˆØ§Ù„Ù†Ø¸Ø§Ù…
            </p>
          </div>
          
          <!-- Information Grid -->
          <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; position: relative; z-index: 2;">
            
            <!-- License Information -->
            <div class="info-card" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 20px;">
              <h4 style="color: #3b82f6; font-size: 14px; font-weight: 600; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 16px;">ğŸ”‘</span> License Information
              </h4>
              <div style="display: grid; gap: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace;">Status:</span>
                  <span id="infoLicenseStatus" style="color: #10b981; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Active</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace;">Duration:</span>
                  <span style="color: #f1f5f9; font-size: 11px; font-weight: 500; font-family: 'Courier New', monospace;">30 Days</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace;">Expires:</span>
                  <span id="infoLicenseExpiry" style="color: #f1f5f9; font-size: 11px; font-weight: 500; font-family: 'Courier New', monospace;">Loading...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace;">Days Left:</span>
                  <span id="infoDaysLeft" style="color: #10b981; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">--</span>
                </div>
              </div>
            </div>

            <!-- System Information -->
            <div class="info-card" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 20px;">
              <h4 style="color: #10b981; font-size: 14px; font-weight: 600; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 16px;">ğŸ’»</span> System Information
              </h4>
              <div style="display: grid; gap: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace;">Version:</span>
                  <span style="color: #f1f5f9; font-size: 11px; font-weight: 500; font-family: 'Courier New', monospace;">KSA-ICSQ-2025</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace;">Type:</span>
                  <span style="color: #f1f5f9; font-size: 11px; font-weight: 500; font-family: 'Courier New', monospace;">Insurance Cybersecurity</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace;">Access:</span>
                  <span style="color: #10b981; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">TUV-AUT Only</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace;">Security:</span>
                  <span style="color: #10b981; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">ENCRYPTED</span>
                </div>
              </div>
            </div>

            <!-- User Information -->
            <div class="info-card" style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 20px;">
              <h4 style="color: #8b5cf6; font-size: 14px; font-weight: 600; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 16px;">ğŸ‘¤</span> User Information
              </h4>
              <div style="display: grid; gap: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace;">Name:</span>
                  <span style="color: #f1f5f9; font-size: 11px; font-weight: 500; font-family: 'Courier New', monospace;">TUV Austria Trust IT</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace;">Email:</span>
                  <span style="color: #f1f5f9; font-size: 11px; font-weight: 500; font-family: 'Courier New', monospace;">Trust-it@tuvautria.sa</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace;">Level:</span>
                  <span style="color: #8b5cf6; font-size: 11px; font-weight: 600; font-family: 'Courier New', monospace;">Trust IT Team</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="color: #94a3b8; font-size: 11px; font-family: 'Courier New', monospace;">Code:</span>
                  <span style="color: #f1f5f9; font-size: 11px; font-weight: 500; font-family: 'Courier New', monospace;">TUV-AUT-001</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div class="info-footer" style="text-align: center; border-top: 1px solid rgba(59, 130, 246, 0.3); padding-top: 20px; margin-top: 10px; position: relative; z-index: 2;">
            <p style="color: #94a3b8; font-size: 10px; margin: 0 0 15px 0; font-family: 'Courier New', monospace;">
              TUV Austria Trust IT Team | KSA-ICSQ-2025 | Licensed for 30 Days
            </p>
            <div style="margin-top: 15px; padding: 15px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px;">
              <h5 style="color: #3b82f6; font-size: 12px; margin: 0 0 10px 0; text-align: center;">License Renewal</h5>
              <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <input type="text" id="renewalCodeInput" placeholder="Enter renewal code" style="flex: 1; padding: 8px 12px; border: 1px solid #3b82f6; border-radius: 4px; font-size: 11px; background: rgba(255,255,255,0.9);">
                <button onclick="applyRenewalCodeFromInput()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.2s;">
                  Apply
                </button>
              </div>
              <p style="color: #3b82f6; font-size: 10px; margin: 0; text-align: center;">
                For license renewal assistance, please contact <strong>support@doganconsult.com</strong>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<div class="container">
  <!-- Status Bar -->
  <div class="card" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-left: 4px solid var(--primary);">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h3 style="margin: 0; color: var(--primary);">Cyber Risk Management System</h3>
        <p style="margin: 4px 0 0 0; color: #6b7280;">Version 2.0 | Last Updated: <span id="lastUpdated">-</span></p>
      </div>
      <div style="display: flex; align-items: center; gap: 16px;">
        <div style="display: flex; align-items: center;">
          <span class="status-indicator status-pending" id="saveStatus"></span>
          <span id="saveStatusText">ØºÙŠØ± Ù…Ø­ÙÙˆØ¸ / Unsaved</span>
        </div>
        <div class="badge" id="completionBadge">0% Complete</div>
        <div class="badge" id="complianceBadge" style="background: #fef3c7; color: #92400e;">Compliance Check</div>
      </div>
    </div>
  </div>

  <!-- Progress Bar & Section Status -->
  <div class="card" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-left: 4px solid #16a34a;">
    <div class="progress-container">
      <div class="progress-header">
        <h3 style="margin: 0 0 12px 0; color: #15803d;">ØªÙ‚Ø¯Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… / Assessment Progress</h3>
        <div class="progress-stats">
          <span class="progress-percentage" id="progressPercentage">0%</span>
          <span class="progress-sections" id="completedSections">0/16 Sections</span>
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="section-status-grid" id="sectionStatusGrid">
        <!-- Section status indicators will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- KSA Regulatory Compliance Overview -->
  <div class="card" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-left: 4px solid #0ea5e9;">
    <h3 style="margin: 0 0 16px 0; color: #0c4a6e;">Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ / KSA Regulatory Compliance Requirements</h3>
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
      <div style="padding: 12px; background: white; border-radius: 8px; border-left: 3px solid #0a7c2f;">
        <h4 style="margin: 0 0 8px 0; color: #0a7c2f;">SAMA - Ù‡ÙŠØ¦Ø© Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h4>
        <p style="margin: 0; font-size: 12px; color: #6b7280;">Ø¥Ø·Ø§Ø± Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±ØŒ Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</p>
        <div id="samaCompliance" class="compliance-indicator">â³ Pending</div>
      </div>
      <div style="padding: 12px; background: white; border-radius: 8px; border-left: 3px solid #1f4e79;">
        <h4 style="margin: 0 0 8px 0; color: #1f4e79;">NCA - Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ù„Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ</h4>
        <p style="margin: 0; font-size: 12px; color: #6b7280;">Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠØŒ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ©ØŒ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠØ©</p>
        <div id="ncaCompliance" class="compliance-indicator">â³ Pending</div>
      </div>
      <div style="padding: 12px; background: white; border-radius: 8px; border-left: 3px solid #7c3aed;">
        <h4 style="margin: 0 0 8px 0; color: #7c3aed;">PDPL - Ù‚Ø§Ù†ÙˆÙ† Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h4>
        <p style="margin: 0; font-size: 12px; color: #6b7280;">RoPAØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§ØªØŒ DPIAØŒ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø£ÙØ±Ø§Ø¯</p>
        <div id="pdplCompliance" class="compliance-indicator">â³ Pending</div>
      </div>
    </div>
  </div>

  <!-- Market Trends Section -->
  <div class="card" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-left: 4px solid var(--primary);">
    <div class="section-header" onclick="toggleSection('marketTrends')">
      <h2>0. Insurance Market Cybersecurity Trends / Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø£Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Ø³ÙˆÙ‚ Ø§Ù„ØªØ£Ù…ÙŠÙ†</h2>
      <span class="section-toggle" id="marketTrends-toggle">â–¼</span>
    </div>
    <div class="section-content" id="marketTrends">
    
    <!-- Key Insights Dashboard -->
    <div style="margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #1e293b, #334155); border-radius: 8px; color: white;">
      <h4 style="margin: 0 0 20px 0; color: #f1f5f9; text-align: center;">Key Insights Dashboard / Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¤Ù‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h4>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
        <!-- Row 1 -->
        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid #fbbf24;">
          <div style="font-size: 28px; font-weight: bold; color: #fbbf24; margin-bottom: 8px;">3rd</div>
          <div style="font-size: 13px; font-weight: 500; color: #e2e8f0;">Most Targeted Industry</div>
          <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">Insurance Sector</div>
        </div>
        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid #ef4444;">
          <div style="font-size: 28px; font-weight: bold; color: #ef4444; margin-bottom: 8px;">300%</div>
          <div style="font-size: 13px; font-weight: 500; color: #e2e8f0;">Ransomware Increase</div>
          <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">GCC Region 2024</div>
        </div>
        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid #10b981;">
          <div style="font-size: 28px; font-weight: bold; color: #10b981; margin-bottom: 8px;">40%</div>
          <div style="font-size: 13px; font-weight: 500; color: #e2e8f0;">SAMA-Driven Investments</div>
          <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">Cybersecurity Spend</div>
        </div>
        <!-- Row 2 -->
        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid #8b5cf6;">
          <div style="font-size: 28px; font-weight: bold; color: #8b5cf6; margin-bottom: 8px;">180%</div>
          <div style="font-size: 13px; font-weight: 500; color: #e2e8f0;">AI Attack Increase</div>
          <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">Targeting Insurance Data</div>
        </div>
        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid #f59e0b;">
          <div style="font-size: 28px; font-weight: bold; color: #f59e0b; margin-bottom: 8px;">$4.45M</div>
          <div style="font-size: 13px; font-weight: 500; color: #e2e8f0;">Average Breach Cost</div>
          <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">Global Average</div>
        </div>
        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid #06b6d4;">
          <div style="font-size: 28px; font-weight: bold; color: #06b6d4; margin-bottom: 8px;">25%</div>
          <div style="font-size: 13px; font-weight: 500; color: #e2e8f0;">Cyber Insurance Growth</div>
          <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">CAGR 2024-2025</div>
        </div>
      </div>
    </div>
    
    <!-- Charts Row 1 -->
    <div class="chart-grid">
      
      <!-- Saudi Arabia Attack Trends Chart -->
      <div class="chart-item" style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #1e293b;">
        <h3 style="color: #1e293b; margin: 0 0 15px 0; text-align: center;">Saudi Arabia Market</h3>
        <div class="chart-container">
          <canvas id="saudiChart"></canvas>
        </div>
        <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
          <div style="text-align: center; padding: 8px; background: #fef2f2; border-radius: 4px;">
            <div style="font-weight: bold; color: #dc2626;">+45%</div>
            <div>Cyber Attacks YoY</div>
          </div>
          <div style="text-align: center; padding: 8px; background: #f0fdf4; border-radius: 4px;">
            <div style="font-weight: bold; color: #10b981;">92%</div>
            <div>SAMA Compliance</div>
          </div>
        </div>
      </div>

      <!-- GCC Region Trends Chart -->
      <div class="chart-item" style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #3b82f6;">
        <h3 style="color: #3b82f6; margin: 0 0 15px 0; text-align: center;">GCC Region</h3>
        <div class="chart-container">
          <canvas id="gccChart"></canvas>
        </div>
        <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
          <div style="text-align: center; padding: 8px; background: #fef2f2; border-radius: 4px;">
            <div style="font-weight: bold; color: #dc2626;">+52%</div>
            <div>Cyber Incidents YoY</div>
          </div>
          <div style="text-align: center; padding: 8px; background: #f0fdf4; border-radius: 4px;">
            <div style="font-weight: bold; color: #10b981;">34%</div>
            <div>Insurance Penetration</div>
          </div>
        </div>
      </div>

    </div>

    <!-- Charts Row 2 -->
    <div class="chart-grid" style="margin-top: 20px;">
      
      <!-- Global Market Size Chart -->
      <div class="chart-item" style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #7c3aed;">
        <h3 style="color: #7c3aed; margin: 0 0 15px 0; text-align: center;">Global Market Size</h3>
        <div class="chart-container">
          <canvas id="globalChart"></canvas>
        </div>
        <div style="margin-top: 10px; text-align: center; font-size: 14px; font-weight: bold; color: #7c3aed;">
          $350B USD Market Size
        </div>
      </div>

      <!-- Attack Growth Comparison -->
      <div class="chart-item" style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #dc2626;">
        <h3 style="color: #dc2626; margin: 0 0 15px 0; text-align: center;">Attack Growth Comparison</h3>
        <div class="chart-container">
          <canvas id="attackChart"></canvas>
        </div>
        <div style="margin-top: 10px; text-align: center; font-size: 12px; color: #6b7280;">
          Insurance sector is 3rd most targeted globally
        </div>
      </div>

    </div>

    <!-- Charts Row 3 -->
    <div class="chart-grid" style="margin-top: 20px;">
      
      <!-- Cost Analysis -->
      <div class="chart-item" style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #f59e0b;">
        <h3 style="color: #f59e0b; margin: 0 0 15px 0; text-align: center;">Cost Analysis</h3>
        <div class="chart-container">
          <canvas id="costChart"></canvas>
        </div>
        <div style="margin-top: 10px; text-align: center; font-size: 12px; color: #6b7280;">
          Average breach cost comparison
        </div>
      </div>

      <!-- Regulatory Compliance Trends -->
      <div class="chart-item" style="padding: 20px; background: white; border-radius: 8px; border-left: 4px solid #059669;">
        <h3 style="color: #059669; margin: 0 0 15px 0; text-align: center;">Regulatory Compliance</h3>
        <div class="chart-container">
          <canvas id="complianceChart"></canvas>
        </div>
        <div style="margin-top: 10px; text-align: center; font-size: 12px; color: #6b7280;">
          SAMA, NCA, PDPL compliance trends
        </div>
      </div>

    </div>
    
    <!-- Platform Information -->
    <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
      <h4 style="margin: 0 0 10px 0; color: #0c4a6e;"><a href="https://www.shahin-ai.com" target="_blank" style="color: #0c4a6e; text-decoration: none;">Shahin-AI Platform Module</a></h4>
      <p style="margin: 5px 0; font-size: 14px; color: #0c4a6e;">
        Developed by <a href="https://www.doganconsult.com" target="_blank" style="color: #0ea5e9; text-decoration: none; font-weight: bold;">DoganConsult</a> | <a href="https://www.doganconsult.com" target="_blank" style="color: #0ea5e9; text-decoration: none;">www.doganconsult.com</a> | <a href="https://www.shahin-ai.com" target="_blank" style="color: #0ea5e9; text-decoration: none;">www.shahin-ai.com</a>
      </p>
      </div>
    </div>
  </div>

  <!-- 1. Organization Overview -->
  <div class="card">
    <div class="section-header" onclick="toggleSection('orgOverview')">
      <h2>1. Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´Ø£Ø© / Organization Overview</h2>
      <span class="section-toggle" id="orgOverview-toggle">â–¼</span>
    </div>
    <div class="section-content" id="orgOverview">
    <div class="grid">
      <div class="form-group">
        <label for="legalName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠ (Legal Name) *</label>
        <input type="text" id="legalName" placeholder="Ø´Ø±ÙƒØ© Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©" required/>
        <div class="error-message" id="legalNameError">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠ Ù…Ø·Ù„ÙˆØ¨ / Legal name is required</div>
      </div>
      <div class="form-group">
        <label for="cr">CR / Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ (Commercial Registration) *</label>
        <input type="text" id="cr" placeholder="1010000000" required/>
        <div class="error-message" id="crError">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ù…Ø·Ù„ÙˆØ¨ / CR number is required</div>
      </div>
      <div class="form-group">
        <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Email) *</label>
        <input type="email" id="email" placeholder="contact@company.com" required/>
        <div class="error-message" id="emailError">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø·Ù„ÙˆØ¨ / Email is required</div>
      </div>
      <div class="form-group">
        <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Phone)</label>
        <input type="text" id="phone" placeholder="+966 500666084"/>
      </div>
      <div class="form-group">
        <label for="regs">Ø§Ù„Ù…Ù†Ø¸Ù…ÙˆÙ† (Regulators) *</label>
        <select id="regs" multiple required onchange="showRegulatorGuidance()">
          <option value="SAMA">SAMA - Ù‡ÙŠØ¦Ø© Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Financial Sector)</option>
          <option value="NCA">NCA - Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ù„Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ (Critical Infrastructure)</option>
          <option value="PDPL">SDAIA/PDPL - Ù‚Ø§Ù†ÙˆÙ† Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© (Data Protection)</option>
          <option value="Other">Ø£Ø®Ø±Ù‰ / Other (Custom/International)</option>
        </select>
        <div class="error-message" id="regsError">ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø¸Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ / At least one regulator must be selected</div>
        
        <!-- Regulator Guidance Panel -->
        <div id="regulatorGuidance" class="guidance-panel" style="display: none; margin-top: 15px; padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
          <h4 style="margin: 0 0 10px 0; color: #1e40af; font-size: 16px;">Regulator Selection Guidance / Ø¯Ù„ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø¸Ù…ÙŠÙ†</h4>
          <div id="guidanceContent"></div>
          <div style="margin-top: 10px; padding: 10px; background: #dbeafe; border-radius: 6px; font-size: 13px;">
            <strong>Quick Reference:</strong><br>
            â€¢ <strong>SAMA</strong>: Insurance, Banking, Financial Services<br>
            â€¢ <strong>NCA</strong>: Government, Critical Infrastructure, National Security<br>
            â€¢ <strong>PDPL</strong>: Any organization processing personal data<br>
            â€¢ <strong>Other</strong>: International frameworks (ISO 27001, NIST, etc.)
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="subline">Ø§Ù„Ù‚Ø·Ø§Ø¹/Ø§Ù„ÙØ±Ø¹ (Sector & Sub-line of Business)</label>
        <input type="text" id="subline" placeholder="Health/Medical, Motor, Takaful, Life"/>
      </div>
      <div class="form-group">
        <label for="totalEmployees">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Total Employees)</label>
        <input type="number" id="totalEmployees" min="0" placeholder="500"/>
      </div>
      <div class="form-group">
        <label for="inScopeEmployees">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¶Ù…Ù† Ø§Ù„Ù†Ø·Ø§Ù‚ (In-scope Employees)</label>
        <input type="number" id="inScopeEmployees" min="0" placeholder="300"/>
      </div>
      <div class="form-group">
        <label for="sites">Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Sites - HQ, Branches, DCs, Call Centers, TPAs)</label>
        <textarea id="sites" placeholder="Headquarters: Riyadh, Branches: Jeddah, Dammam, Data Center: Riyadh, Call Center: Jeddah"></textarea>
      </div>
      <div class="form-group">
        <label for="cyberContact">Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³Ø© Ù„Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ (Main Cyber/Privacy Contact)</label>
        <textarea id="cyberContact" placeholder="Name: Ahmed Al-Rashid, Position: CISO, Phone: +966 500666084, Email: ciso@company.com"></textarea>
      </div>
      
      <!-- Additional Questions from Word Document -->
      <div class="form-group">
        <label for="infoSecGovernance">Does your organization have an established Information Security Governance model?</label>
        <select id="infoSecGovernance">
          <option value="">Select...</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="cyberPolicy">Do you have a formally approved cybersecurity policy?</label>
        <select id="cyberPolicy">
          <option value="">Select...</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="cyberSponsor">Who owns and sponsors the cybersecurity initiatives at the executive level?</label>
        <input type="text" id="cyberSponsor" placeholder="CEO, CISO, CTO, etc."/>
      </div>
      
      <div class="form-group">
        <label for="biaConducted">Have you conducted a Business Impact Analysis (BIA)? When?</label>
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <select id="biaConducted">
            <option value="">Select...</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
          <input type="text" id="biaDate" placeholder="If yes, when?" style="flex: 1; min-width: 200px;"/>
        </div>
      </div>
      
      <div class="form-group">
        <label for="riskAssessmentSelect">Have you completed a formal Risk Assessment and Risk Treatment Plan?</label>
        <select id="riskAssessmentSelect">
          <option value="">Select...</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="riskRegister">Do you maintain a Risk Register? Is it reviewed periodically?</label>
        <select id="riskRegister">
          <option value="">Select...</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="regulatoryComplianceSelect">Are there any regulatory or contractual compliance requirements (e.g. NCA, SAMA, ISO, PCI-DSS)?</label>
        <select id="regulatoryComplianceSelect">
          <option value="">Select...</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="certificationStatus">What is your current certification/compliance status (ISO 27001, NCA ECC, etc.)?</label>
        <input type="text" id="certificationStatus" placeholder="ISO 27001:2013, NCA ECC v2.0, etc."/>
      </div>
      
      <div class="form-group">
        <label for="grcTool">Is a GRC tool being used (e.g. for policy, risk, or compliance management)?</label>
        <select id="grcTool">
          <option value="">Select...</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="vendorEvaluation">Are third-party vendors evaluated from a risk/security standpoint? How often?</label>
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <select id="vendorEvaluation">
            <option value="">Select...</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
          <input type="text" id="vendorEvaluationFreq" placeholder="If yes, how often?" style="flex: 1; min-width: 200px;"/>
        </div>
      </div>
    </div>
    <!-- Attachment Validation Summary -->
    <div id="attachmentValidationSummary" style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #3b82f6; display: block;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h4 style="margin: 0; color: #1e293b;">ğŸ“‹ Attachment Validation Summary / Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</h4>
        <button onclick="validateAllAttachments()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px;">
          ğŸ”„ Refresh Validation
        </button>
      </div>
      <div id="validationSummaryContent" style="font-size: 14px; color: #374151;">
        <!-- Validation summary will be populated here -->
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
          <div style="font-size: 20px;">âš ï¸</div>
          <h4 style="margin: 0; color: #dc2626;">Attachment Validation / Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</h4>
        </div>
        <div style="font-size: 14px; color: #374151;">
          <strong>Files Uploaded:</strong> <span id="fileCountDisplay">0/15</span>
        </div>
        <div style="margin-top: 10px;">
          <strong style="color: #dc2626;">Missing Required Files:</strong>
          <ul style="margin: 5px 0; padding-left: 20px;">
            <li>Statement Of Applicability</li>
            <li>Risk Register</li>
            <li>Incident Response Plan</li>
            <li>DPIA (Data Protection Impact Assessment)</li>
            <li>Security Policies</li>
            <li>Audit Reports</li>
            <li>Business Continuity Plan</li>
            <li>Vendor Management Policy</li>
            <li>Access Control Policy</li>
            <li>Data Classification Policy</li>
            <li>Incident Response Procedures</li>
          </ul>
        </div>
        <div style="margin-top: 15px; padding: 10px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
          <strong style="color: #92400e;">ğŸ“ Note:</strong> Please upload all required documents to complete your cybersecurity assessment. Missing documents may affect the accuracy of your compliance evaluation.
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="primary" onclick="saveDraft()" id="saveBtn">
        <span id="saveBtnText">Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© (Save Draft)</span>
        <div class="loading" id="saveLoading" style="display: none;"></div>
      </button>
      <button class="secondary" onclick="loadDraft()">ØªØ­Ù…ÙŠÙ„ Ù…Ø³ÙˆØ¯Ø© (Load Draft)</button>
      <button class="secondary" onclick="showAttachmentValidationSummary()" style="background: #10b981;">ğŸ“‹ Attachment Validation</button>
    </div>
    <div class="note">
      <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø­ØªÙ‰ ÙŠØªÙ… Ø±ÙØ¹Ù‡Ø§ Ù„Ù„Ø®Ø§Ø¯Ù….
      <br><strong>Note:</strong> Data is auto-saved every 30 seconds. Data is stored locally in browser until uploaded to server.
    </div>
    
    <!-- Organization Documents Upload -->
    <div style="margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #3b82f6;">
      <h4 style="margin: 0 0 15px 0; color: #1e293b;">ğŸ“„ Organization Documents / ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ù…Ù†Ø´Ø£Ø©</h4>
      <p style="margin: 0 0 15px 0; color: #64748b; font-size: 14px;">
        Upload organizational documents: Commercial Registration, License, Organizational Chart, Policies
        <br>Ø§Ø±ÙØ¹ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠØ©: Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØŒ Ø§Ù„ØªØ±Ø®ÙŠØµØŒ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠØŒ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª
      </p>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button type="button" onclick="document.getElementById('orgDocs').click()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
          ğŸ“ Upload Documents
        </button>
        <button type="button" onclick="clearOrgFiles()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
          ğŸ—‘ï¸ Clear All
        </button>
        <button type="button" onclick="displayAttachmentValidation('orgOverview')" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
          âœ… Validate Attachments
        </button>
      </div>
      <input type="file" id="orgDocs" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" style="display: none;" onchange="handleOrgFileUpload(this)"/>
      <div id="orgFileList" style="margin-top: 15px;"></div>
    </div>
    </div>
  </div>
  <!-- 2. Insurance-Specific Footprint -->
  <div class="card">
    <div class="section-header" onclick="toggleSection('insuranceFootprint')">
      <h2>2. Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªØ£Ù…ÙŠÙ† / Insurance-Specific Footprint</h2>
      <span class="section-toggle" id="insuranceFootprint-toggle">â–¼</span>
    </div>
    <div class="section-content" id="insuranceFootprint">
    <div class="grid">
      <div class="form-group">
        <label for="coreSystems">Ø£Ù†Ø¸Ù…Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Core Insurance Systems)</label>
        <textarea id="coreSystems" placeholder="Policy Admin: Guidewire, Claims: Duck Creek, Billing: Oracle, Reinsurance: RI3K"></textarea>
        <div class="regulatory-guidance">
          <strong>Insurance Requirement:</strong> Document all core insurance systems including Policy Administration, Claims Management, Billing, and Reinsurance systems with vendor and hosting model details.
        </div>
      </div>
      <div class="form-group">
        <label for="hostingModel">Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ© (Hosting Model)</label>
        <div style="display: flex; gap: 16px; flex-wrap: wrap;">
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="onPrem" value="on-prem">
            <span>On-premise</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="cloud" value="cloud">
            <span>Cloud</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="hybrid" value="hybrid">
            <span>Hybrid</span>
          </label>
        </div>
      </div>
      <div class="form-group">
        <label for="systemNames">Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© (System Names)</label>
        <input type="text" id="systemNames" placeholder="Guidewire, Duck Creek, Oracle, RI3K"/>
      </div>
      <div class="form-group">
        <label for="tpaIntegration">ØªÙƒØ§Ù…Ù„ TPAs / Aggregators / Brokers (TPA Integration)</label>
        <select id="tpaIntegration">
          <option value="">Ø§Ø®ØªØ± / Select</option>
          <option value="yes">Ù†Ø¹Ù… (Yes)</option>
          <option value="no">Ù„Ø§ (No)</option>
        </select>
      </div>
      <div class="form-group">
        <label for="tpaEntities">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© (Integrated Entities)</label>
        <textarea id="tpaEntities" placeholder="List TPA entities and data flows"></textarea>
      </div>
      <div class="form-group">
        <label for="zatcaIntegration">ØªÙƒØ§Ù…Ù„ ZATCA e-Invoicing (ZATCA Integration)</label>
        <select id="zatcaIntegration">
          <option value="">Ø§Ø®ØªØ± / Select</option>
          <option value="yes">Ù†Ø¹Ù… (Yes)</option>
          <option value="no">Ù„Ø§ (No)</option>
        </select>
      </div>
      <div class="form-group">
        <label for="zatcaPhase">Ù…Ø±Ø­Ù„Ø© ZATCA (ZATCA Phase)</label>
        <input type="text" id="zatcaPhase" placeholder="Phase 1, Phase 2, etc."/>
      </div>
      <div class="form-group">
        <label for="contactCenters">Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ (Contact Centers & Recording)</label>
        <textarea id="contactCenters" placeholder="Describe contact center setup, recording retention, and PCI-DSS scope if payments involved"></textarea>
      </div>
    </div>
    </div>
  </div>

  <!-- 3. Regulatory Compliance Framework -->
  <div class="card">
    <div class="section-header" onclick="toggleSection('regulatoryCompliance')">
      <h2>3. Ø¥Ø·Ø§Ø± Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ / Regulatory Compliance Framework</h2>
      <span class="section-toggle" id="regulatoryCompliance-toggle">â–¼</span>
    </div>
    <div class="section-content" id="regulatoryCompliance">
    
    <!-- 3.1 SAMA Requirements -->
    <div style="margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #0a7c2f;">
      <h3 style="color: #0a7c2f; margin: 0 0 16px 0;">3.1 SAMA - Ù‡ÙŠØ¦Ø© Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Saudi Central Bank)</h3>
      <div class="grid">
        <div class="form-group">
          <label for="sama_cyber_framework">Ø¥Ø·Ø§Ø± Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ SAMA (Cyber Security Framework) <span class="required-field">*</span></label>
          <select id="sama_cyber_framework" required>
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="implemented">Ù…Ø·Ø¨Ù‚ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Fully Implemented)</option>
            <option value="partial">Ù…Ø·Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠØ§Ù‹ (Partially Implemented)</option>
            <option value="planned">Ù…Ø®Ø·Ø· Ù„Ù‡ (Planned)</option>
            <option value="none">ØºÙŠØ± Ù…Ø·Ø¨Ù‚ (Not Implemented)</option>
          </select>
          <div class="regulatory-guidance">
            <strong>SAMA Requirement:</strong> All insurance companies must implement SAMA's Cyber Security Framework as per SAMA Cyber Security Framework (CSF) requirements. This includes governance, risk management, and incident response capabilities.
          </div>
        </div>
        <div class="form-group">
          <label for="sama_risk_management">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠØ© (Cyber Risk Management)</label>
          <select id="sama_risk_management">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="mature">Ù†Ø§Ø¶Ø¬ (Mature)</option>
            <option value="developing">Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± (Developing)</option>
            <option value="basic">Ø£Ø³Ø§Ø³ÙŠ (Basic)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="sama_incident_response">Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠØ© (Cyber Incident Response)</label>
          <select id="sama_incident_response">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="tested">Ù…Ø®ØªØ¨Ø± ÙˆÙ…Ø­Ø¯Ø« (Tested & Updated)</option>
            <option value="documented">Ù…ÙˆØ«Ù‚ (Documented)</option>
            <option value="draft">Ù…Ø³ÙˆØ¯Ø© (Draft)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="sama_business_continuity">Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ (Business Continuity)</label>
          <select id="sama_business_continuity">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="tested">Ù…Ø®ØªØ¨Ø± (Tested)</option>
            <option value="documented">Ù…ÙˆØ«Ù‚ (Documented)</option>
            <option value="planned">Ù…Ø®Ø·Ø· (Planned)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="sama_third_party">Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù„Ø« (Third-Party Risk Management)</label>
          <select id="sama_third_party">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="comprehensive">Ø´Ø§Ù…Ù„ (Comprehensive)</option>
            <option value="basic">Ø£Ø³Ø§Ø³ÙŠ (Basic)</option>
            <option value="limited">Ù…Ø­Ø¯ÙˆØ¯ (Limited)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="sama_governance">Ø­ÙˆÙƒÙ…Ø© Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ (Cyber Security Governance)</label>
          <select id="sama_governance">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="board_level">Ù…Ø³ØªÙˆÙ‰ Ù…Ø¬Ù„Ø³ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Board Level)</option>
            <option value="management_level">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Management Level)</option>
            <option value="operational">ØªØ´ØºÙŠÙ„ÙŠ (Operational)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- 3.2 NCA Requirements -->
    <div style="margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #1f4e79;">
      <h3 style="color: #1f4e79; margin: 0 0 16px 0;">3.2 NCA - Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ù„Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ (National Cybersecurity Authority)</h3>
      <div class="grid">
        <div class="form-group">
          <label for="nca_integrity">Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ (Cybersecurity Management System)</label>
          <select id="nca_integrity">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="implemented">Ù…Ø·Ø¨Ù‚ (Implemented)</option>
            <option value="partial">Ø¬Ø²Ø¦ÙŠ (Partial)</option>
            <option value="planned">Ù…Ø®Ø·Ø· (Planned)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="nca_whistleblowing">Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠØ© (Cybersecurity Incident Response)</label>
          <select id="nca_whistleblowing">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="active">Ù†Ø´Ø· ÙˆÙ…Ø­Ù…ÙŠ (Active & Protected)</option>
            <option value="basic">Ø£Ø³Ø§Ø³ÙŠ (Basic)</option>
            <option value="planned">Ù…Ø®Ø·Ø· (Planned)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="nca_conflict_interest">Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ© Ø§Ù„Ø­Ø±Ø¬Ø© (Critical Infrastructure Protection)</label>
          <select id="nca_conflict_interest">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="comprehensive">Ø´Ø§Ù…Ù„ (Comprehensive)</option>
            <option value="basic">Ø£Ø³Ø§Ø³ÙŠ (Basic)</option>
            <option value="limited">Ù…Ø­Ø¯ÙˆØ¯ (Limited)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="nca_ethics_training">Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ (Cybersecurity Training Program)</label>
          <select id="nca_ethics_training">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="mandatory">Ø¥Ù„Ø²Ø§Ù…ÙŠ (Mandatory)</option>
            <option value="voluntary">Ø·ÙˆØ¹ÙŠ (Voluntary)</option>
            <option value="planned">Ù…Ø®Ø·Ø· (Planned)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- 3.3 PDPL Requirements -->
    <div style="margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #7c3aed;">
      <h3 style="color: #7c3aed; margin: 0 0 16px 0;">3.3 PDPL - Ù‚Ø§Ù†ÙˆÙ† Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© (Personal Data Protection Law)</h3>
      <div class="grid">
        <div class="form-group">
          <label for="pdpl_ropa">Ø³Ø¬Ù„ Ø£Ù†Ø´Ø·Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (RoPA) <span class="required-field">*</span></label>
          <select id="pdpl_ropa" required>
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="complete">Ù…ÙƒØªÙ…Ù„ ÙˆÙ…Ø­Ø¯Ø« (Complete & Updated)</option>
            <option value="partial">Ø¬Ø²Ø¦ÙŠ (Partial)</option>
            <option value="draft">Ù…Ø³ÙˆØ¯Ø© (Draft)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
          <div class="error-message" id="pdpl_ropaError">ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© RoPA / RoPA status must be specified</div>
          <div class="regulatory-guidance">
            <strong>PDPL Article 8:</strong> Data controllers must maintain a record of processing activities (RoPA) containing specific information about data processing activities, purposes, categories of data subjects, and data retention periods.
          </div>
        </div>
        <div class="form-group">
          <label for="pdpl_consent">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª (Consent Management System) *</label>
          <select id="pdpl_consent" required>
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="automated">Ø¢Ù„ÙŠ (Automated)</option>
            <option value="manual">ÙŠØ¯ÙˆÙŠ (Manual)</option>
            <option value="hybrid">Ù…Ø®ØªÙ„Ø· (Hybrid)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
          <div class="error-message" id="pdpl_consentError">ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª / Consent management system must be specified</div>
        </div>
        <div class="form-group">
          <label for="pdpl_dsr_sla">SLA Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ø£ÙØ±Ø§Ø¯ (DSR SLA - days) *</label>
          <input type="number" id="pdpl_dsr_sla" min="1" max="30" placeholder="15" required/>
          <div class="error-message" id="pdpl_dsr_slaError">ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ ÙØªØ±Ø© SLA / SLA period must be specified</div>
        </div>
        <div class="form-group">
          <label for="pdpl_dpia">ØªÙ‚ÙŠÙŠÙ… ØªØ£Ø«ÙŠØ± Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (DPIA) *</label>
          <select id="pdpl_dpia" required>
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="completed">Ù…ÙƒØªÙ…Ù„ (Completed)</option>
            <option value="in_progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° (In Progress)</option>
            <option value="planned">Ù…Ø®Ø·Ø· (Planned)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
          <div class="error-message" id="pdpl_dpiaError">ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© DPIA / DPIA status must be specified</div>
        </div>
        <div class="form-group">
          <label for="pdpl_data_retention">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Retention Policy)</label>
          <select id="pdpl_data_retention">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="compliant">Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ PDPL (PDPL Compliant)</option>
            <option value="partial">Ø¬Ø²Ø¦ÙŠ (Partial)</option>
            <option value="draft">Ù…Ø³ÙˆØ¯Ø© (Draft)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="pdpl_breach_notification">Ù†Ø¸Ø§Ù… Ø¥Ø´Ø¹Ø§Ø± Ø®Ø±Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Breach Notification System)</label>
          <select id="pdpl_breach_notification">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="automated">Ø¢Ù„ÙŠ (Automated)</option>
            <option value="manual">ÙŠØ¯ÙˆÙŠ (Manual)</option>
            <option value="planned">Ù…Ø®Ø·Ø· (Planned)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="pdpl_dpo">Ù…Ø³Ø¤ÙˆÙ„ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Protection Officer)</label>
          <select id="pdpl_dpo">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="appointed">Ù…Ø¹ÙŠÙ† (Appointed)</option>
            <option value="external">Ø®Ø§Ø±Ø¬ÙŠ (External)</option>
            <option value="planned">Ù…Ø®Ø·Ø· (Planned)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="pdpl_privacy_impact">ØªÙ‚ÙŠÙŠÙ… ØªØ£Ø«ÙŠØ± Ø§Ù„Ø®ØµÙˆØµÙŠØ© (Privacy Impact Assessment)</label>
          <select id="pdpl_privacy_impact">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="regular">Ø¯ÙˆØ±ÙŠ (Regular)</option>
            <option value="ad_hoc">Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© (Ad-hoc)</option>
            <option value="planned">Ù…Ø®Ø·Ø· (Planned)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Additional Regulatory Requirements -->
    <div style="margin-bottom: 24px; padding: 20px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #dc2626;">
      <h3 style="color: #dc2626; margin: 0 0 16px 0;">Ù…ØªØ·Ù„Ø¨Ø§Øª ØªÙ†Ø¸ÙŠÙ…ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© / Additional Regulatory Requirements</h3>
      <div class="grid">
        <div class="form-group">
          <label for="iso27001">ISO 27001 - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø£Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</label>
          <select id="iso27001">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="certified">Ù…Ø¹ØªÙ…Ø¯ (Certified)</option>
            <option value="implemented">Ù…Ø·Ø¨Ù‚ (Implemented)</option>
            <option value="partial">Ø¬Ø²Ø¦ÙŠ (Partial)</option>
            <option value="planned">Ù…Ø®Ø·Ø· (Planned)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="nist_framework">NIST Cybersecurity Framework</label>
          <select id="nist_framework">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="tier4">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 4 (Tier 4)</option>
            <option value="tier3">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3 (Tier 3)</option>
            <option value="tier2">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2 (Tier 2)</option>
            <option value="tier1">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1 (Tier 1)</option>
            <option value="none">ØºÙŠØ± Ù…Ø·Ø¨Ù‚ (Not Applied)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="cobit">COBIT - Ø¥Ø·Ø§Ø± Ø­ÙˆÙƒÙ…Ø© ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</label>
          <select id="cobit">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="level5">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 5 (Level 5)</option>
            <option value="level4">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 4 (Level 4)</option>
            <option value="level3">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3 (Level 3)</option>
            <option value="level2">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2 (Level 2)</option>
            <option value="level1">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1 (Level 1)</option>
            <option value="none">ØºÙŠØ± Ù…Ø·Ø¨Ù‚ (Not Applied)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="pci_dss">PCI DSS - Ù…Ø¹ÙŠØ§Ø± Ø£Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¯ÙØ¹</label>
          <select id="pci_dss">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="compliant">Ù…ØªÙˆØ§ÙÙ‚ (Compliant)</option>
            <option value="partial">Ø¬Ø²Ø¦ÙŠ (Partial)</option>
            <option value="planned">Ù…Ø®Ø·Ø· (Planned)</option>
            <option value="not_applicable">ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ (Not Applicable)</option>
          </select>
        </div>
      </div>
    </div>
    </div>
  </div>

  <!-- 4. Privacy & Data Protection -->
  <div class="card">
    <div class="section-header" onclick="toggleSection('privacyDataProtection')">
      <h2>4. Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª / Privacy & Data Protection</h2>
      <span class="section-toggle" id="privacyDataProtection-toggle">â–¼</span>
    </div>
    <div class="section-content" id="privacyDataProtection">
    <div class="grid">
      <div class="form-group">
        <label for="ropa">RoPA Ù…ÙˆØ¬ÙˆØ¯ØŸ (RoPA Exists?) *</label>
        <select id="ropa" required>
          <option value="">Ø§Ø®ØªØ± / Select</option>
          <option value="yes">Ù†Ø¹Ù… (Yes)</option>
          <option value="no">Ù„Ø§ (No)</option>
          <option value="partial">Ø¬Ø²Ø¦ÙŠ (Partial)</option>
        </select>
        <div class="error-message" id="ropaError">ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© RoPA / RoPA status must be specified</div>
      </div>
      <div class="form-group">
        <label for="consent">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª Ù…Ø·Ø¨Ù‘Ù‚Ø©ØŸ (Consent Management Applied?) *</label>
        <select id="consent" required>
          <option value="">Ø§Ø®ØªØ± / Select</option>
          <option value="yes">Ù†Ø¹Ù… (Yes)</option>
          <option value="no">Ù„Ø§ (No)</option>
          <option value="planned">Ù…Ø®Ø·Ø· Ù„Ù‡ (Planned)</option>
        </select>
        <div class="error-message" id="consentError">ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª / Consent management status must be specified</div>
      </div>
      <div class="form-group">
        <label for="dsrSla">Ø£ÙŠØ§Ù… SLA Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£ÙØ±Ø§Ø¯ (DSR SLA â€” days) *</label>
        <input type="number" id="dsrSla" min="0" max="30" placeholder="15" required/>
        <div class="error-message" id="dsrSlaError">ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ ÙØªØ±Ø© SLA / SLA period must be specified</div>
      </div>
      <div class="form-group">
        <label for="dpia">DPIA Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø·Ø¨ÙŠØ©ØŸ (DPIA for Claims Data) *</label>
        <select id="dpia" required>
          <option value="">Ø§Ø®ØªØ± / Select</option>
          <option value="yes">Ù†Ø¹Ù… (Yes)</option>
          <option value="no">Ù„Ø§ (No)</option>
          <option value="in_progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° (In Progress)</option>
        </select>
        <div class="error-message" id="dpiaError">ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© DPIA / DPIA status must be specified</div>
      </div>
      <div class="form-group">
        <label for="dataRetention">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Retention Policy)</label>
        <select id="dataRetention">
          <option value="">Ø§Ø®ØªØ± / Select</option>
          <option value="compliant">Ù…ØªÙˆØ§ÙÙ‚ (Compliant)</option>
          <option value="partial">Ø¬Ø²Ø¦ÙŠ (Partial)</option>
          <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
        </select>
      </div>
      <div class="form-group">
        <label for="dataBreachPlan">Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ø®Ø±Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Breach Response Plan)</label>
        <select id="dataBreachPlan">
          <option value="">Ø§Ø®ØªØ± / Select</option>
          <option value="yes">Ù…ÙˆØ¬ÙˆØ¯ (Exists)</option>
          <option value="no">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          <option value="draft">Ù…Ø³ÙˆØ¯Ø© (Draft)</option>
        </select>
      </div>
    </div>
    </div>
  </div>
  <!-- 5. Security Operations Center & Monitoring -->
  <div class="card">
    <div class="section-header" onclick="toggleSection('socMonitoring')">
      <h2>5. Ù…Ø±ÙƒØ² Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© / Security Operations Center & Monitoring</h2>
      <span class="section-toggle" id="socMonitoring-toggle">â–¼</span>
    </div>
    <div class="section-content" id="socMonitoring">
    <div class="grid">
      <div class="form-group">
        <label for="socModel">Ù†Ù…ÙˆØ°Ø¬ SOC (SOC Model) *</label>
        <select id="socModel" required>
          <option value="">Ø§Ø®ØªØ± / Select</option>
          <option value="internal">Ø¯Ø§Ø®Ù„ÙŠ (Internal)</option>
          <option value="co_managed">Ù…Ø´ØªØ±Ùƒ (Co-managed)</option>
          <option value="mssp">Ù…Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø© (MSSP)</option>
          <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
        </select>
        <div class="error-message" id="socModelError">ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù†Ù…ÙˆØ°Ø¬ SOC / SOC model must be specified</div>
      </div>
      <div class="form-group">
        <label for="siem">Ù†Ø¸Ø§Ù… SIEM (SIEM Platform)</label>
        <input type="text" id="siem" placeholder="Azure Sentinel / QRadar / Splunk / ArcSight"/>
      </div>
      <div class="form-group">
        <label for="mttd">MTTD - Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø§ÙƒØªØ´Ø§Ù (Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª / hours)</label>
        <input type="number" id="mttd" min="0" max="168" placeholder="4"/>
      </div>
      <div class="form-group">
        <label for="mttr">MTTR - Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© (Ø¨Ø§Ù„Ø³Ø§Ø¹Ø§Øª / hours)</label>
        <input type="number" id="mttr" min="0" max="168" placeholder="24"/>
      </div>
      <div class="form-group">
        <label for="securityTeam">ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ (Cybersecurity Team Size)</label>
        <select id="securityTeam">
          <option value="">Ø§Ø®ØªØ± / Select</option>
          <option value="1-5">1-5 Ø£Ø¹Ø¶Ø§Ø¡</option>
          <option value="6-15">6-15 Ø¹Ø¶Ùˆ</option>
          <option value="16-50">16-50 Ø¹Ø¶Ùˆ</option>
          <option value="50+">Ø£ÙƒØ«Ø± Ù…Ù† 50 Ø¹Ø¶Ùˆ</option>
        </select>
      </div>
      <div class="form-group">
        <label for="incidentResponse">Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø­ÙˆØ§Ø¯Ø« (Incident Response Plan)</label>
        <select id="incidentResponse">
          <option value="">Ø§Ø®ØªØ± / Select</option>
          <option value="yes">Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ…Ø­Ø¯Ø« (Exists & Updated)</option>
          <option value="draft">Ù…Ø³ÙˆØ¯Ø© (Draft)</option>
          <option value="no">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
        </select>
      </div>
    </div>
  </div>
  </div>

  <!-- 6. Technical & Network Controls -->
  <div class="card">
    <div class="section-header" onclick="toggleSection('technicalControls')">
      <h2>6. Ø§Ù„Ø¶ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ù„Ø´Ø¨ÙƒÙŠØ© / Technical & Network Controls</h2>
      <span class="section-toggle" id="technicalControls-toggle">â–¼</span>
    </div>
    <div class="section-content" id="technicalControls">
    <div class="grid">
      <div class="form-group">
        <label>Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØ§Ù„ÙˆØµÙˆÙ„ (Identity & Access)</label>
        <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;">
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="centralizedIAM" value="centralized-iam">
            <span>Centralized IAM</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="sso" value="sso">
            <span>SSO</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="mfaAdmins" value="mfa-admins">
            <span>MFA for Admins</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="mfaUsers" value="mfa-users">
            <span>MFA for Users</span>
          </label>
        </div>
      </div>
      <div class="form-group">
        <label>Ø£Ù…Ø§Ù† Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø·Ø±ÙÙŠØ© (Endpoint Security)</label>
        <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;">
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="edrXdr" value="edr-xdr">
            <span>EDR/XDR</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="usbControl" value="usb-control">
            <span>USB Control</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="appAllowlist" value="app-allowlist">
            <span>App Allow-list</span>
          </label>
        </div>
      </div>
      <div class="form-group">
        <label>Ø£Ù…Ø§Ù† Ø§Ù„Ø´Ø¨ÙƒØ© (Network Security)</label>
        <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;">
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="networkSegmentation" value="network-segmentation">
            <span>Segmentation (user/DMZ/core)</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="eastWestInspection" value="east-west-inspection">
            <span>East-West Inspection</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="vpnPostureCheck" value="vpn-posture-check">
            <span>VPN Posture Check</span>
          </label>
        </div>
      </div>
      <div class="form-group">
        <label>Ø£Ù…Ø§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ§Ù„ÙˆÙŠØ¨ (Email/Web Security)</label>
        <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;">
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="secureEmailGateway" value="secure-email-gateway">
            <span>Secure Email Gateway</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="antiPhishing" value="anti-phishing">
            <span>Anti-phishing</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="webProxyCasb" value="web-proxy-casb">
            <span>Web Proxy/CASB</span>
          </label>
        </div>
      </div>
      <div class="form-group">
        <label>Ø£Ù…Ø§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª (Application Security)</label>
        <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;">
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="waf" value="waf">
            <span>WAF</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="sastDast" value="sast-dast">
            <span>SAST/DAST</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="ssdlcPolicy" value="ssdlc-policy">
            <span>SSDLC Policy</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="secretsMgmt" value="secrets-mgmt">
            <span>Secrets Management</span>
          </label>
        </div>
      </div>
      <div class="form-group">
        <label>Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Protection)</label>
        <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;">
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="dlp" value="dlp">
            <span>DLP</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="encryptionAtRest" value="encryption-at-rest">
            <span>Encryption at Rest</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="encryptionInTransit" value="encryption-in-transit">
            <span>Encryption in Transit</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="keyMgmt" value="key-mgmt">
            <span>Key Management (HSM/KMS)</span>
          </label>
        </div>
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Backups)</label>
        <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;">
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="immutableBackups" value="immutable-backups">
            <span>Immutable</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="offlineCopy" value="offline-copy">
            <span>Offline Copy</span>
          </label>
        </div>
      </div>
      <div class="form-group">
        <label for="backupTestCadence">ØªÙƒØ±Ø§Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© (Restore Test Cadence)</label>
        <input type="text" id="backupTestCadence" placeholder="Monthly, Quarterly, etc."/>
      </div>
    </div>
  </div>
  </div>

  <!-- 7. Cloud & Hosting -->
  <div class="card">
    <div class="section-header" onclick="toggleSection('cloudHosting')">
      <h2>7. Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ÙˆØ§Ù„Ø§Ø³ØªØ¶Ø§ÙØ© / Cloud & Hosting</h2>
      <span class="section-toggle" id="cloudHosting-toggle">â–¼</span>
    </div>
    <div class="section-content" id="cloudHosting">
    <div class="grid">
      <div class="form-group">
        <label>Ù…Ù†ØµØ§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Cloud Platforms)</label>
        <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;">
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="aws" value="aws">
            <span>AWS</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="azure" value="azure">
            <span>Azure</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="gcp" value="gcp">
            <span>GCP</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="stcCloud" value="stc-cloud">
            <span>STC Cloud</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="privateCloud" value="private">
            <span>Private</span>
          </label>
        </div>
      </div>
      <div class="form-group">
        <label for="sharedResponsibility">ÙÙ‡Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© (Shared Responsibility)</label>
        <select id="sharedResponsibility">
          <option value="">Ø§Ø®ØªØ± / Select</option>
          <option value="yes">Ù†Ø¹Ù… (Yes)</option>
          <option value="no">Ù„Ø§ (No)</option>
        </select>
      </div>
      <div class="form-group">
        <label for="logRetention">ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„Ø§Ø­ØªÙØ§Ø¸ (Logging & Retention Days)</label>
        <input type="number" id="logRetention" min="0" placeholder="365"/>
      </div>
      <div class="form-group">
        <label for="dataResidency">Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ù‚Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‚ÙˆØ§Ø¹Ø¯ PDPL (Data Residency & PDPL)</label>
        <select id="dataResidency">
          <option value="">Ø§Ø®ØªØ± / Select</option>
          <option value="yes">Ù†Ø¹Ù… (Yes)</option>
          <option value="no">Ù„Ø§ (No)</option>
        </select>
      </div>
    </div>
  </div>
  </div>

  <!-- 8. Risk Assessment & Control Framework -->
  <div class="card">
    <div class="section-header" onclick="toggleSection('riskAssessment')">
      <h2>8. ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ¥Ø·Ø§Ø± Ø§Ù„Ø¶ÙˆØ§Ø¨Ø· / Risk Assessment & Control Framework</h2>
      <span class="section-toggle" id="riskAssessment-toggle">â–¼</span>
    </div>
    <div class="section-content" id="riskAssessment">
    
    <!-- 7.1 Risk Assessment Matrix -->
    <div style="margin-bottom: 24px; padding: 20px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
      <h3 style="color: #92400e; margin: 0 0 16px 0;">7.1 Ù…ØµÙÙˆÙØ© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± / Risk Assessment Matrix</h3>
      <div class="grid">
        <div class="form-group">
          <label for="risk_assessment_frequency">ØªÙƒØ±Ø§Ø± ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± (Risk Assessment Frequency)</label>
          <select id="risk_assessment_frequency">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="quarterly">Ø±Ø¨Ø¹ÙŠ (Quarterly)</option>
            <option value="semi_annual">Ù†ØµÙ Ø³Ù†ÙˆÙŠ (Semi-Annual)</option>
            <option value="annual">Ø³Ù†ÙˆÙŠ (Annual)</option>
            <option value="ad_hoc">Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© (Ad-hoc)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="risk_tolerance">Ù…Ø³ØªÙˆÙ‰ ØªØ­Ù…Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø± (Risk Tolerance Level)</label>
          <select id="risk_tolerance">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="very_low">Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§Ù‹ (Very Low)</option>
            <option value="low">Ù…Ù†Ø®ÙØ¶ (Low)</option>
            <option value="moderate">Ù…ØªÙˆØ³Ø· (Moderate)</option>
            <option value="high">Ø¹Ø§Ù„ÙŠ (High)</option>
            <option value="not_defined">ØºÙŠØ± Ù…Ø­Ø¯Ø¯ (Not Defined)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="risk_register">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø± (Risk Register)</label>
          <select id="risk_register">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="comprehensive">Ø´Ø§Ù…Ù„ ÙˆÙ…Ø­Ø¯Ø« (Comprehensive & Updated)</option>
            <option value="basic">Ø£Ø³Ø§Ø³ÙŠ (Basic)</option>
            <option value="draft">Ù…Ø³ÙˆØ¯Ø© (Draft)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="risk_mitigation">Ø®Ø·Ø· Ø§Ù„ØªØ®ÙÙŠÙ Ù…Ù† Ø§Ù„Ù…Ø®Ø§Ø·Ø± (Risk Mitigation Plans)</label>
          <select id="risk_mitigation">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="implemented">Ù…Ø·Ø¨Ù‚Ø© (Implemented)</option>
            <option value="planned">Ù…Ø®Ø·Ø·Ø© (Planned)</option>
            <option value="partial">Ø¬Ø²Ø¦ÙŠØ© (Partial)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© (None)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Control Framework -->
    <div style="margin-bottom: 24px; padding: 20px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
      <h3 style="color: #0c4a6e; margin: 0 0 16px 0;">7.2 Ø¥Ø·Ø§Ø± Ø§Ù„Ø¶ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ù…Ù†ÙŠØ© / Security Control Framework</h3>
      <div class="grid">
        <div class="form-group">
          <label for="access_controls">Ø¶ÙˆØ§Ø¨Ø· Ø§Ù„ÙˆØµÙˆÙ„ (Access Controls)</label>
          <select id="access_controls">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="mature">Ù†Ø§Ø¶Ø¬Ø© (Mature)</option>
            <option value="developing">Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± (Developing)</option>
            <option value="basic">Ø£Ø³Ø§Ø³ÙŠØ© (Basic)</option>
            <option value="inadequate">ØºÙŠØ± ÙƒØ§ÙÙŠØ© (Inadequate)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="network_security">Ø£Ù…Ø§Ù† Ø§Ù„Ø´Ø¨ÙƒØ© (Network Security)</label>
          <select id="network_security">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="comprehensive">Ø´Ø§Ù…Ù„ (Comprehensive)</option>
            <option value="standard">Ù‚ÙŠØ§Ø³ÙŠ (Standard)</option>
            <option value="basic">Ø£Ø³Ø§Ø³ÙŠ (Basic)</option>
            <option value="minimal">Ø­Ø¯ Ø£Ø¯Ù†Ù‰ (Minimal)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="data_encryption">ØªØ´ÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Encryption)</label>
          <select id="data_encryption">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="end_to_end">Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ù„Ù†Ù‡Ø§ÙŠØ© (End-to-End)</option>
            <option value="at_rest">ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙƒÙˆÙ† (At Rest)</option>
            <option value="in_transit">Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ù‚Ù„ (In Transit)</option>
            <option value="none">ØºÙŠØ± Ù…Ø·Ø¨Ù‚ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="vulnerability_management">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø«ØºØ±Ø§Øª (Vulnerability Management)</label>
          <select id="vulnerability_management">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="automated">Ø¢Ù„ÙŠ (Automated)</option>
            <option value="semi_automated">Ø´Ø¨Ù‡ Ø¢Ù„ÙŠ (Semi-Automated)</option>
            <option value="manual">ÙŠØ¯ÙˆÙŠ (Manual)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="patch_management">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª (Patch Management)</label>
          <select id="patch_management">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="automated">Ø¢Ù„ÙŠ (Automated)</option>
            <option value="scheduled">Ù…Ø¬Ø¯ÙˆÙ„ (Scheduled)</option>
            <option value="ad_hoc">Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© (Ad-hoc)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="security_monitoring">Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ù…Ù†ÙŠØ© (Security Monitoring)</label>
          <select id="security_monitoring">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="24x7">24/7</option>
            <option value="business_hours">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ (Business Hours)</option>
            <option value="periodic">Ø¯ÙˆØ±ÙŠ (Periodic)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Business Continuity & Disaster Recovery -->
    <div style="margin-bottom: 24px; padding: 20px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
      <h3 style="color: #065f46; margin: 0 0 16px 0;">Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙˆØ§Ù„ØªØ¹Ø§ÙÙŠ Ù…Ù† Ø§Ù„ÙƒÙˆØ§Ø±Ø« / Business Continuity & Disaster Recovery</h3>
      <div class="grid">
        <div class="form-group">
          <label for="bcp_status">Ø®Ø·Ø© Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ (Business Continuity Plan)</label>
          <select id="bcp_status">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="tested">Ù…Ø®ØªØ¨Ø±Ø© (Tested)</option>
            <option value="documented">Ù…ÙˆØ«Ù‚Ø© (Documented)</option>
            <option value="draft">Ù…Ø³ÙˆØ¯Ø© (Draft)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="dr_status">Ø®Ø·Ø© Ø§Ù„ØªØ¹Ø§ÙÙŠ Ù…Ù† Ø§Ù„ÙƒÙˆØ§Ø±Ø« (Disaster Recovery Plan)</label>
          <select id="dr_status">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="tested">Ù…Ø®ØªØ¨Ø±Ø© (Tested)</option>
            <option value="documented">Ù…ÙˆØ«Ù‚Ø© (Documented)</option>
            <option value="draft">Ù…Ø³ÙˆØ¯Ø© (Draft)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="rto_target">Ù‡Ø¯Ù ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ (RTO Target - hours)</label>
          <input type="number" id="rto_target" min="0" max="168" placeholder="4"/>
        </div>
        <div class="form-group">
          <label for="rpo_target">Ù‡Ø¯Ù Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ (RPO Target - hours)</label>
          <input type="number" id="rpo_target" min="0" max="168" placeholder="1"/>
        </div>
        <div class="form-group">
          <label for="backup_frequency">ØªÙƒØ±Ø§Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Backup Frequency)</label>
          <select id="backup_frequency">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="real_time">ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ (Real-time)</option>
            <option value="hourly">ÙƒÙ„ Ø³Ø§Ø¹Ø© (Hourly)</option>
            <option value="daily">ÙŠÙˆÙ…ÙŠ (Daily)</option>
            <option value="weekly">Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Weekly)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="backup_testing">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Backup Testing)</label>
          <select id="backup_testing">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="regular">Ø¯ÙˆØ±ÙŠ (Regular)</option>
            <option value="ad_hoc">Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© (Ad-hoc)</option>
            <option value="planned">Ù…Ø®Ø·Ø· (Planned)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Third-Party Risk Management -->
    <div style="margin-bottom: 24px; padding: 20px; background: #fef7ff; border-radius: 8px; border-left: 4px solid #a855f7;">
      <h3 style="color: #6b21a8; margin: 0 0 16px 0;">Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù„Ø« / Third-Party Risk Management</h3>
      <div class="grid">
        <div class="form-group">
          <label for="vendor_inventory">Ø¬Ø±Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Vendor Inventory)</label>
          <select id="vendor_inventory">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="complete">Ù…ÙƒØªÙ…Ù„ (Complete)</option>
            <option value="partial">Ø¬Ø²Ø¦ÙŠ (Partial)</option>
            <option value="basic">Ø£Ø³Ø§Ø³ÙŠ (Basic)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="vendor_assessment">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Vendor Assessment)</label>
          <select id="vendor_assessment">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="comprehensive">Ø´Ø§Ù…Ù„ (Comprehensive)</option>
            <option value="basic">Ø£Ø³Ø§Ø³ÙŠ (Basic)</option>
            <option value="ad_hoc">Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© (Ad-hoc)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="contract_security">Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ø£Ù…Ù† ÙÙŠ Ø§Ù„Ø¹Ù‚ÙˆØ¯ (Security Contract Clauses)</label>
          <select id="contract_security">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="mandatory">Ø¥Ù„Ø²Ø§Ù…ÙŠØ© (Mandatory)</option>
            <option value="standard">Ù‚ÙŠØ§Ø³ÙŠØ© (Standard)</option>
            <option value="optional">Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© (Optional)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© (None)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="vendor_monitoring">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Vendor Monitoring)</label>
          <select id="vendor_monitoring">
            <option value="">Ø§Ø®ØªØ± / Select</option>
            <option value="continuous">Ù…Ø³ØªÙ…Ø±Ø© (Continuous)</option>
            <option value="periodic">Ø¯ÙˆØ±ÙŠØ© (Periodic)</option>
            <option value="annual">Ø³Ù†ÙˆÙŠØ© (Annual)</option>
            <option value="none">ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© (None)</option>
          </select>
        </div>
      </div>
    </div>
    </div>
  </div>

  <!-- 9. Evidence & Documentation -->
  <div class="card">
    <div class="section-header" onclick="toggleSection('evidenceDocumentation')">
      <h2>9. Ø§Ù„Ø£Ø¯Ù„Ø© ÙˆØ§Ù„ÙˆØ«Ø§Ø¦Ù‚ / Evidence & Documentation</h2>
      <span class="section-toggle" id="evidenceDocumentation-toggle">â–¼</span>
    </div>
    <div class="section-content" id="evidenceDocumentation">
    <!-- Enhanced File Upload Section -->
    <div class="upload-enhanced" id="uploadArea" style="border: 2px dashed #3b82f6; padding: 30px; border-radius: 12px; background: linear-gradient(135deg, #f8fafc, #e2e8f0); text-align: center; transition: all 0.3s ease;">
      <div style="margin-bottom: 20px;">
        <div style="font-size: 48px; color: #3b82f6; margin-bottom: 10px;">ğŸ“</div>
        <h3 style="margin: 0 0 10px 0; color: #1e293b; font-size: 18px;">Upload Evidence Documents</h3>
        <p style="margin: 0 0 15px 0; color: #64748b; font-size: 14px;">
        <strong>Ø§Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</strong> Statement of Applicability, Risk Register, Incident Response Plan, DPIA, Security Policies, Audit Reports
        <br><strong>Upload required evidence:</strong> SoA, Risk Register, IR Plan, DPIA, Security Policies, Audit Reports
      </p>
        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
          <button type="button" onclick="document.getElementById('evidence').click()" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.3s;">
            ğŸ“ Choose Files
          </button>
          <button type="button" onclick="clearAllFiles()" style="background: #ef4444; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.3s;">
            ğŸ—‘ï¸ Clear All
          </button>
          <button type="button" onclick="displayAttachmentValidation('evidenceDocumentation')" style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.3s;">
            âœ… Validate Attachments
          </button>
          <button type="button" onclick="validateAllAttachments()" style="background: #8b5cf6; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.3s;">
            ğŸ” Validate All Sections
          </button>
      </div>
    </div>
      <input type="file" id="evidence" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.jpg,.jpeg,.png" style="display: none;" onchange="handleFileUpload(this)"/>
      <div class="progress-bar" id="uploadProgress" style="display: none; margin-top: 15px;">
        <div class="progress-fill" id="progressFill" style="background: #3b82f6;"></div>
      </div>
      <div style="margin-top: 15px; font-size: 12px; color: #64748b;">
        Supported formats: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT, JPG, PNG
        <br>Maximum file size: 10MB per file
      </div>
    </div>
    
    <!-- Enhanced File List -->
    <div id="uploadedFiles" style="margin-top: 20px;">
      <div id="fileListHeader" style="display: none; margin-bottom: 15px; padding: 10px; background: #f1f5f9; border-radius: 8px; border-left: 4px solid #3b82f6;">
        <h4 style="margin: 0; color: #1e293b; font-size: 16px;">ğŸ“‹ Uploaded Files (<span id="fileCount">0</span>)</h4>
      </div>
      <div id="fileList" style="display: grid; gap: 10px;"></div>
    </div>
  </div>
  </div>

  <!-- 10. Resilience -->
  <div class="card">
    <div class="section-header" onclick="toggleSection('resilience')">
      <h2>10. Ø§Ù„Ù…Ø±ÙˆÙ†Ø© ÙˆØ§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ / Resilience</h2>
      <span class="section-toggle" id="resilience-toggle">â–¼</span>
    </div>
    <div class="section-content" id="resilience">
    <div class="grid">
      <div class="form-group">
        <label for="irPlanTested">Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø­ÙˆØ§Ø¯Ø« (IR Plan Tested)</label>
        <input type="date" id="irPlanTested"/>
      </div>
      <div class="form-group">
        <label for="ransomwareReadiness">Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„ÙØ¯ÙŠØ© (Ransomware Readiness)</label>
        <textarea id="ransomwareReadiness" placeholder="Describe isolation, EDR rollback, immutable backups"></textarea>
      </div>
      <div class="form-group">
        <label for="crisisManagement">Ø®Ø·Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø²Ù…Ø§Øª (Crisis Management Plan)</label>
        <select id="crisisManagement">
          <option value="">Ø§Ø®ØªØ± / Select</option>
          <option value="yes">Ù†Ø¹Ù… (Yes)</option>
          <option value="no">Ù„Ø§ (No)</option>
        </select>
      </div>
    </div>
  </div>
  </div>

  <!-- 11. Managed SOC Discovery (Optional) -->
  <div class="card">
    <div class="section-header" onclick="toggleSection('managedSOC')">
      <h2>11. Ø§ÙƒØªØ´Ø§Ù Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù€MSSP (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) / Managed SOC Discovery (Optional)</h2>
      <span class="section-toggle" id="managedSOC-toggle">â–¼</span>
    </div>
    <div class="section-content" id="managedSOC">
    <div class="grid">
      <div class="form-group">
        <label for="msspGoals">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Goals)</label>
        <textarea id="msspGoals" placeholder="24/7 monitoring, compliance, faster IR, workload reduction"></textarea>
      </div>
      <div class="form-group">
        <label for="epsEstimate">ØªÙ‚Ø¯ÙŠØ± EPS ÙˆÙ…ØµØ§Ø¯Ø± Ø§Ù„Ø³Ø¬Ù„Ø§Øª (EPS Estimate & Log Sources)</label>
        <textarea id="epsEstimate" placeholder="FW, AD, EDR, Cloud, Email, VPN"></textarea>
      </div>
      <div class="form-group">
        <label for="retentionNeed">Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ (Retention Need)</label>
        <input type="text" id="retentionNeed" placeholder="â‰¥ 1 year for SAMA/NCA"/>
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Required Actions on Alerts)</label>
        <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;">
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="alertOnly" value="alert-only">
            <span>Alert-only</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="contain" value="contain">
            <span>Contain</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="runbook" value="runbook">
            <span>Runbook</span>
          </label>
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="escalationPath" value="escalation-path">
            <span>Escalation Path</span>
          </label>
        </div>
      </div>
    </div>
    </div>
  </div>

  <!-- 12. Risk Assessment & Scoring -->
  <div class="card">
    <div class="section-header" onclick="toggleSection('riskScoring')">
      <h2>12. ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ§Ù„Ù†Ù‚Ø§Ø· / Risk Assessment & Scoring</h2>
      <span class="section-toggle" id="riskScoring-toggle">â–¼</span>
    </div>
    <div class="section-content" id="riskScoring">
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„Ù…Ø¬Ø§Ù„ / Domain</th>
          <th>Ø§Ù„Ù†Ù‚Ø§Ø· / Score (0â€“5)</th>
          <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Notes</th>
          <th>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© / Priority</th>
        </tr>
      </thead>
      <tbody id="scoreRows">
        <tr>
          <td>Ø§Ù„Ø­ÙˆÙƒÙ…Ø© / Governance</td>
          <td><input type="number" class="score-input" min="0" max="5" value="3" data-domain="governance"/></td>
          <td><input type="text" class="description-input" value="Policies exist; annual review required" style="width: 100%; border: none; background: transparent;"/></td>
          <td><select><option value="high">Ø¹Ø§Ù„ÙŠ / High</option><option value="medium">Ù…ØªÙˆØ³Ø· / Medium</option><option value="low">Ù…Ù†Ø®ÙØ¶ / Low</option></select></td>
        </tr>
        <tr>
          <td>Ù…Ø±ÙƒØ² Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª / SOC</td>
          <td><input type="number" class="score-input" min="0" max="5" value="2" data-domain="soc"/></td>
          <td><input type="text" class="description-input" value="SIEM in place; playbooks in progress" style="width: 100%; border: none; background: transparent;"/></td>
          <td><select><option value="high">Ø¹Ø§Ù„ÙŠ / High</option><option value="medium">Ù…ØªÙˆØ³Ø· / Medium</option><option value="low">Ù…Ù†Ø®ÙØ¶ / Low</option></select></td>
        </tr>
        <tr>
          <td>Ø§Ù„Ø®ØµÙˆØµÙŠØ© / Privacy</td>
          <td><input type="number" class="score-input" min="0" max="5" value="2" data-domain="privacy"/></td>
          <td><input type="text" class="description-input" value="RoPA ready; DPIA pending" style="width: 100%; border: none; background: transparent;"/></td>
          <td><select><option value="high">Ø¹Ø§Ù„ÙŠ / High</option><option value="medium">Ù…ØªÙˆØ³Ø· / Medium</option><option value="low">Ù…Ù†Ø®ÙØ¶ / Low</option></select></td>
        </tr>
        <tr>
          <td>Ø§Ù„Ù…Ø±ÙˆÙ†Ø© / Resilience</td>
          <td><input type="number" class="score-input" min="0" max="5" value="2" data-domain="resilience"/></td>
          <td><input type="text" class="description-input" value="Backups configured; testing pending" style="width: 100%; border: none; background: transparent;"/></td>
          <td><select><option value="high">Ø¹Ø§Ù„ÙŠ / High</option><option value="medium">Ù…ØªÙˆØ³Ø· / Medium</option><option value="low">Ù…Ù†Ø®ÙØ¶ / Low</option></select></td>
        </tr>
        <tr>
          <td>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù„Ø« / Third-Party</td>
          <td><input type="number" class="score-input" min="0" max="5" value="1" data-domain="third_party"/></td>
          <td><input type="text" class="description-input" value="Inventory incomplete; assessments needed" style="width: 100%; border: none; background: transparent;"/></td>
          <td><select><option value="high">Ø¹Ø§Ù„ÙŠ / High</option><option value="medium">Ù…ØªÙˆØ³Ø· / Medium</option><option value="low">Ù…Ù†Ø®ÙØ¶ / Low</option></select></td>
        </tr>
      </tbody>
    </table>
    <div style="margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px;">
      <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· / Total Score: <span id="totalScore">10</span>/100</h4>
      <div class="progress-bar">
        <div class="progress-fill" id="scoreProgress" style="width: 40%;"></div>
      </div>
      <p style="margin: 8px 0 0 0; font-size: 14px; color: #6b7280;">
        <span id="scoreLevel">Ù…ØªÙˆØ³Ø· / Moderate</span> - <span id="scoreRecommendation">ØªØ­Ø³ÙŠÙ†Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø© / Improvements needed</span>
      </p>
    </div>

    <!-- Red Flags & Critical Issues -->
    <div style="margin-top: 20px; padding: 20px; background: #fef2f2; border-radius: 8px; border-left: 4px solid #ef4444;">
      <h4 style="margin: 0 0 16px 0; color: #dc2626;">ğŸš¨ Red Flags & Critical Issues</h4>
      <div id="redFlags" class="red-flags-container">
        <p style="color: #6b7280; font-style: italic;">Fill out the form to check for red flags...</p>
      </div>
    </div>

    <!-- Maturity Assessment -->
    <div style="margin-top: 20px; padding: 20px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
      <h4 style="margin: 0 0 16px 0; color: #0c4a6e;">ğŸ“Š Maturity Assessment (0-5 Scale)</h4>
      <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
        <div class="maturity-item" id="governanceMaturity">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">Governance</span>
            <span id="governanceScore" style="font-weight: 700;">0/5</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="governanceProgress" style="width: 0%;"></div>
          </div>
        </div>
        <div class="maturity-item" id="identityMaturity">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">Identity</span>
            <span id="identityScore" style="font-weight: 700;">0/5</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="identityProgress" style="width: 0%;"></div>
          </div>
        </div>
        <div class="maturity-item" id="endpointMaturity">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">Endpoint</span>
            <span id="endpointScore" style="font-weight: 700;">0/5</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="endpointProgress" style="width: 0%;"></div>
          </div>
        </div>
        <div class="maturity-item" id="networkMaturity">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">Network</span>
            <span id="networkScore" style="font-weight: 700;">0/5</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="networkProgress" style="width: 0%;"></div>
          </div>
        </div>
        <div class="maturity-item" id="appsecMaturity">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">AppSec</span>
            <span id="appsecScore" style="font-weight: 700;">0/5</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="appsecProgress" style="width: 0%;"></div>
          </div>
        </div>
        <div class="maturity-item" id="dataMaturity">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">Data</span>
            <span id="dataScore" style="font-weight: 700;">0/5</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="dataProgress" style="width: 0%;"></div>
          </div>
        </div>
        <div class="maturity-item" id="socMaturity">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">SOC</span>
            <span id="socScore" style="font-weight: 700;">0/5</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="socProgress" style="width: 0%;"></div>
          </div>
        </div>
        <div class="maturity-item" id="privacyMaturity">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">Privacy</span>
            <span id="privacyScore" style="font-weight: 700;">0/5</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="privacyProgress" style="width: 0%;"></div>
          </div>
        </div>
        <div class="maturity-item" id="resilienceMaturity">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">Resilience</span>
            <span id="resilienceScore" style="font-weight: 700;">0/5</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="resilienceProgress" style="width: 0%;"></div>
          </div>
        </div>
        <div class="maturity-item" id="thirdPartyMaturity">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">Third-party</span>
            <span id="thirdPartyScore" style="font-weight: 700;">0/5</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="thirdPartyProgress" style="width: 0%;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Detailed Scoring Breakdown -->
    <div style="margin-top: 20px; padding: 20px; background: #ffffff; border-radius: 8px; border: 1px solid #e5e7eb;">
      <h4 style="margin: 0 0 16px 0; color: #374151;">ØªÙØµÙŠÙ„ Ø§Ù„Ù†Ù‚Ø§Ø· / Scoring Breakdown</h4>
      <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
        <div class="score-item" id="regulatoryScoreItem">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ / Regulatory</span>
            <span id="regulatoryScore" style="font-weight: 700;">0%</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="regulatoryProgress" style="width: 0%;"></div>
          </div>
        </div>
        <div class="score-item" id="riskScoreItem">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± / Risk Assessment</span>
            <span id="riskScore" style="font-weight: 700;">0%</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="riskProgress" style="width: 0%;"></div>
          </div>
        </div>
        <div class="score-item" id="controlScoreItem">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">Ø§Ù„Ø¶ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ù…Ù†ÙŠØ© / Security Controls</span>
            <span id="controlScore" style="font-weight: 700;">0%</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="controlProgress" style="width: 0%;"></div>
          </div>
        </div>
        <div class="score-item" id="bcScoreItem">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ / Business Continuity</span>
            <span id="bcScore" style="font-weight: 700;">0%</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="bcProgress" style="width: 0%;"></div>
          </div>
        </div>
        <div class="score-item" id="thirdPartyScoreItem">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
            <span style="font-weight: 500;">Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù„Ø« / Third-Party</span>
            <span id="thirdPartyScore" style="font-weight: 700;">0%</span>
          </div>
          <div class="progress-bar" style="height: 6px;">
            <div class="progress-fill" id="thirdPartyProgress" style="width: 0%;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- 13. KSA Regulatory Compliance Report -->
  <div class="card">
    <div class="section-header" onclick="toggleSection('ksaComplianceReport')">
      <h2>13. ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ / KSA Regulatory Compliance Report</h2>
      <span class="section-toggle" id="ksaComplianceReport-toggle">â–¼</span>
    </div>
    <div class="section-content" id="ksaComplianceReport">
    <div style="margin-bottom: 20px;">
      <h4>Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ / Compliance Summary</h4>
      <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div id="samaReport" class="compliance-report-item">
          <h5 style="margin: 0 0 8px 0; color: #0a7c2f;">SAMA Compliance</h5>
          <div id="samaReportStatus" class="compliance-status">â³ Analyzing...</div>
          <div id="samaReportDetails" class="compliance-details" style="font-size: 12px; margin-top: 8px;"></div>
        </div>
        <div id="ncaReport" class="compliance-report-item">
          <h5 style="margin: 0 0 8px 0; color: #1f4e79;">NCA Compliance</h5>
          <div id="ncaReportStatus" class="compliance-status">â³ Analyzing...</div>
          <div id="ncaReportDetails" class="compliance-details" style="font-size: 12px; margin-top: 8px;"></div>
        </div>
        <div id="pdplReport" class="compliance-report-item">
          <h5 style="margin: 0 0 8px 0; color: #7c3aed;">PDPL Compliance</h5>
          <div id="pdplReportStatus" class="compliance-status">â³ Analyzing...</div>
          <div id="pdplReportDetails" class="compliance-details" style="font-size: 12px; margin-top: 8px;"></div>
        </div>
      </div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <h4>Ø§Ù„ØªÙˆØµÙŠØ§Øª / Recommendations</h4>
      <div id="complianceRecommendations" class="recommendations-container">
        <p style="color: #6b7280; font-style: italic;">Fill out the form to see compliance recommendations...</p>
      </div>
    </div>
  </div>
  </div>

  <!-- 14. Actions & Reports -->
  <div class="card">
    <div class="section-header" onclick="toggleSection('actionsAndReports')" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 15px; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 8px; margin-bottom: 15px;">
      <h2 style="margin: 0; color: #f8fafc; font-size: 18px; font-weight: 600;">14. Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± / Actions & Reports</h2>
      <span id="actionsAndReports-toggle" class="section-toggle" style="font-size: 20px; color: #0ea5e9; transition: transform 0.3s ease;">â–¼</span>
    </div>
    <div id="actionsAndReports" class="section-content collapsed">
      <div class="actions">
      <button class="primary" onclick="validateAndSave()" id="validateBtn">
        <span id="validateBtnText">Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ø­ÙØ¸ / Validate & Save</span>
        <div class="loading" id="validateLoading" style="display: none;"></div>
      </button>
      <button class="secondary" onclick="downloadReport()">ØªÙ†Ø²ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± HTML / Download Report</button>
      <button class="secondary" onclick="downloadComplianceReport()">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ / Compliance Report</button>
      <button class="secondary" onclick="exportToPDF()">ØªØµØ¯ÙŠØ± PDF / Export PDF</button>
      <button class="danger" onclick="clearForm()">Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ / Clear Form</button>
      </div>
    </div>
  </div>

  <div class="footer" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-top: 1px solid #334155; margin-top: 40px; padding: 30px 0;">
    <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
      <div style="text-align: center;">
        <div class="footer-brand" style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 20px;">
          <div class="brand-logo" style="width: 40px; height: 40px; background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
            DC
          </div>
          <div class="brand-text">
            <h4 style="color: #f8fafc; font-size: 16px; font-weight: 700; margin: 0;"><a href="https://www.doganconsult.com" target="_blank" style="color: #f8fafc; text-decoration: none;">DoganConsult</a></h4>
            <p style="color: #94a3b8; font-size: 12px; margin: 0;"><a href="https://www.shahin-ai.com" target="_blank" style="color: #94a3b8; text-decoration: none;">Shahin-AI Platform Module</a></p>
        </div>
          </div>
        
        <p style="color: #cbd5e1; font-size: 14px; margin: 0 0 15px 0; line-height: 1.5;">
          Professional cybersecurity assessment tool for insurance companies in Saudi Arabia
        </p>
        
        <div style="display: flex; justify-content: center; align-items: center; gap: 20px; flex-wrap: wrap; margin-bottom: 15px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 14px;">ğŸ”’</span>
            <span style="color: #94a3b8; font-size: 12px;">Data stored locally | End-to-end encryption</span>
        </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 14px;">ğŸ›¡ï¸</span>
            <span style="color: #94a3b8; font-size: 12px;">SAMA-CSF | NCA-ECC v2.0 | PDPL</span>
        </div>
      </div>
        
        <div class="footer-copyright">
          <p style="color: #94a3b8; font-size: 13px; margin: 0 0 5px 0;">
            &copy; 2025 <a href="https://www.doganconsult.com" target="_blank" style="color: #0ea5e9; text-decoration: none;">DoganConsult</a> - <a href="https://www.shahin-ai.com" target="_blank" style="color: #0ea5e9; text-decoration: none;">Shahin-AI Platform Module</a>
          </p>
          <p style="color: #64748b; font-size: 12px; margin: 0;">
            Dr. Ahmed Dogan - Accredited ICT Consultant | Saudi Council of Engineers
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Notification Container -->
<div id="notification" class="notification"></div>

<!-- Modal for confirmations -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3 id="modalTitle">ØªØ£ÙƒÙŠØ¯ / Confirmation</h3>
    <p id="modalMessage">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ / Are you sure about this action?</p>
    <div style="margin-top: 20px; text-align: right;">
      <button class="secondary" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡ / Cancel</button>
      <button class="primary" onclick="confirmAction()" id="confirmBtn">ØªØ£ÙƒÙŠØ¯ / Confirm</button>
    </div>
  </div>
</div>
<script>
// License Management System
window.licenseManager = {
  licenseKey: 'TUV-AUT-2025-LICENSE-KEY-' + Math.random().toString(36).substr(2, 16),
  expirationDate: null, // Will be set on first use
  maxUsers: 100,
  currentUsers: 0,
  isActive: false,
  firstUseDate: null,
  
  // Check license validity
  checkLicense: function() {
    const now = new Date();
    
    // If this is the first use, activate license for one month
    if (!this.firstUseDate) {
      this.firstUseDate = now;
      this.expirationDate = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000); // 30 days from first use
      this.isActive = true;
      this.saveLicense();
      console.log('License activated for 30 days from first use');
      return true;
    }
    
    const isValid = this.isActive && now < this.expirationDate;
    
    if (!isValid) {
      this.showLicenseError();
      return false;
    }
    
    return true;
  },
  
  // Save license to localStorage
  saveLicense: function() {
    localStorage.setItem('tuv_license', JSON.stringify({
      key: this.licenseKey,
      expiration: this.expirationDate.toISOString(),
      active: this.isActive,
      firstUse: this.firstUseDate.toISOString()
    }));
  },
  
  // Show license error
  showLicenseError: function() {
    const errorMsg = document.getElementById('authError');
    if (errorMsg) {
      errorMsg.textContent = 'License expired or invalid. Please contact TUV Austria Trust IT for renewal.';
      errorMsg.style.display = 'block';
    }
  },
  
  // Remote license renewal
  renewLicense: function(newExpirationDate) {
    this.expirationDate = new Date(newExpirationDate);
    this.isActive = true;
    localStorage.setItem('tuv_license', JSON.stringify({
      key: this.licenseKey,
      expiration: this.expirationDate.toISOString(),
      active: this.isActive
    }));
    console.log('License renewed until:', this.expirationDate);
  },
  
  // Get license info
  getLicenseInfo: function() {
    return {
      key: this.licenseKey,
      expiration: this.expirationDate,
      active: this.isActive,
      maxUsers: this.maxUsers,
      currentUsers: this.currentUsers
    };
  },
  
  // Remote license renewal (simulated API call)
  renewLicenseRemote: async function(newExpirationDate) {
    try {
      // Simulate API call to TUV license server
      const response = await fetch('/api/license/renew', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + this.licenseKey
        },
        body: JSON.stringify({
          licenseKey: this.licenseKey,
          newExpirationDate: newExpirationDate
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        this.renewLicense(data.expirationDate);
        return { success: true, message: 'License renewed successfully' };
      } else {
        return { success: false, message: 'License renewal failed' };
      }
    } catch (error) {
      console.error('License renewal error:', error);
      // Fallback: renew locally
      this.renewLicense(newExpirationDate);
      return { success: true, message: 'License renewed locally' };
    }
  },
  
  // Check for license updates
  checkForUpdates: async function() {
    try {
      const response = await fetch('/api/license/check', {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + this.licenseKey
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.expirationDate !== this.expirationDate.toISOString()) {
          this.renewLicense(data.expirationDate);
          console.log('License updated from server');
        }
      }
    } catch (error) {
      console.error('License update check failed:', error);
    }
  },
  
  // Force reset license to 30 days
  resetTo30Days: function() {
    const now = new Date();
    this.firstUseDate = now;
    this.expirationDate = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
    this.isActive = true;
    this.saveLicense();
    console.log('License force reset to 30 days from now:', this.expirationDate);
    return this.expirationDate;
  },
  
  // Auto-renewal system
  autoRenewal: {
    enabled: false,
    renewalCode: null,
    checkInterval: null,
    
    // Enable auto-renewal with a renewal code
    enable: function(renewalCode) {
      this.enabled = true;
      this.renewalCode = renewalCode;
      
      // Check every hour for renewal
      this.checkInterval = setInterval(() => {
        this.checkAndRenew();
      }, 60 * 60 * 1000); // Check every hour
      
      console.log('Auto-renewal enabled with code:', renewalCode);
    },
    
    // Disable auto-renewal
    disable: function() {
      this.enabled = false;
      this.renewalCode = null;
      
      if (this.checkInterval) {
        clearInterval(this.checkInterval);
        this.checkInterval = null;
      }
      
      console.log('Auto-renewal disabled');
    },
    
    // Check if renewal is needed and apply it
    checkAndRenew: function() {
      if (!this.enabled || !this.renewalCode) return;
      
      const now = new Date();
      const timeDiff = window.licenseManager.expirationDate.getTime() - now.getTime();
      const daysLeft = Math.ceil(timeDiff / (1000 * 3600 * 24));
      
      // Auto-renew if less than 5 days left
      if (daysLeft <= 5) {
        const result = applyRenewalCode(this.renewalCode);
        if (result.success) {
          console.log('Auto-renewal applied:', result.message);
          updateLicenseStatus();
          updateInfoSection();
        }
      }
    }
  },
  
  // Owner-only license renewal (only Dr. Ahmed Dogan can renew)
  ownerRenewLicense: function(ownerCode, newDays = 30) {
    // Owner verification - only Dr. Ahmed Dogan can renew
    const ownerCredentials = {
      code: 'DOGANCONSULT2025',
      name: 'Dr. Ahmed Dogan',
      email: 'support@doganconsult.com',
      phone: '+966 500 666 084'
    };
    
    if (ownerCode !== ownerCredentials.code) {
      return {
        success: false,
        message: 'Unauthorized: License renewal requires authorization. Please contact support@doganconsult.com for assistance'
      };
    }
    
    const now = new Date();
    this.expirationDate = new Date(now.getTime() + newDays * 24 * 60 * 60 * 1000);
    this.isActive = true;
    this.saveLicense();
    
    console.log(`License renewed by owner for ${newDays} days until:`, this.expirationDate);
    
    return {
      success: true,
      message: `License renewed successfully for ${newDays} days until ${this.expirationDate.toLocaleDateString()}`,
      expiration: this.expirationDate
    };
  }
};

// License Status Display Functions
function updateLicenseStatus() {
  const licenseStatus = document.getElementById('licenseStatus');
  const licenseStatusText = document.getElementById('licenseStatusText');
  const daysRemaining = document.getElementById('daysRemaining');
  const licenseExpiry = document.getElementById('licenseExpiry');
  const renewalCountdown = document.getElementById('renewalCountdown');
  
  if (!licenseStatus || !window.licenseManager) return;
  
  const licenseInfo = window.licenseManager.getLicenseInfo();
  const now = new Date();
  
  if (licenseInfo.expiration) {
    const timeDiff = licenseInfo.expiration.getTime() - now.getTime();
    const daysLeft = Math.ceil(timeDiff / (1000 * 3600 * 24));
    const hoursLeft = Math.ceil(timeDiff / (1000 * 3600));
    const minutesLeft = Math.ceil(timeDiff / (1000 * 60));
    
    // Show license status section
    licenseStatus.style.display = 'block';
    
    // Update status text
    if (licenseInfo.active && daysLeft > 0) {
      licenseStatusText.textContent = `Active - Valid until ${licenseInfo.expiration.toLocaleDateString()}`;
      licenseStatusText.style.color = '#10b981';
    } else if (daysLeft <= 0) {
      licenseStatusText.textContent = 'Expired - Please renew license';
      licenseStatusText.style.color = '#ef4444';
    } else {
      licenseStatusText.textContent = 'Inactive - License not activated';
      licenseStatusText.style.color = '#f59e0b';
    }
    
    // Update days remaining
    daysRemaining.textContent = Math.max(0, daysLeft);
    if (daysLeft <= 7) {
      daysRemaining.style.color = '#ef4444'; // Red for warning
    } else if (daysLeft <= 14) {
      daysRemaining.style.color = '#f59e0b'; // Orange for caution
    } else {
      daysRemaining.style.color = '#10b981'; // Green for good
    }
    
    // Update expiry date
    licenseExpiry.textContent = licenseInfo.expiration.toLocaleDateString();
    
    // Update countdown - show days:hours:minutes format
    if (timeDiff > 0) {
      const days = Math.floor(timeDiff / (1000 * 3600 * 24));
      const hours = Math.floor((timeDiff % (1000 * 3600 * 24)) / (1000 * 3600));
      const minutes = Math.floor((timeDiff % (1000 * 3600)) / (1000 * 60));
      
      if (days > 0) {
        renewalCountdown.textContent = `${days}d ${hours}h ${minutes}m`;
      } else {
        renewalCountdown.textContent = `${hours}h ${minutes}m`;
      }
      
      if (daysLeft <= 5) {
        renewalCountdown.style.color = '#ef4444'; // Red for warning
        renewalCountdown.innerHTML = renewalCountdown.textContent + ' - Please contact <a href="mailto:support@doganconsult.com" style="color: #ef4444; text-decoration: underline;">support@doganconsult.com</a> for renewal';
      } else if (daysLeft <= 14) {
        renewalCountdown.style.color = '#f59e0b'; // Orange for caution
      } else {
        renewalCountdown.style.color = '#10b981'; // Green for good
      }
    } else {
      renewalCountdown.innerHTML = 'EXPIRED - Please contact <a href="mailto:support@doganconsult.com" style="color: #ef4444; text-decoration: underline;">support@doganconsult.com</a> for renewal';
      renewalCountdown.style.color = '#ef4444';
    }
  } else {
    // No license expiration set
    licenseStatus.style.display = 'block';
    licenseStatusText.textContent = 'License not activated - Will activate on first use';
    licenseStatusText.style.color = '#f59e0b';
    daysRemaining.textContent = '--';
    licenseExpiry.textContent = 'Not set';
    renewalCountdown.textContent = '--:--:--';
  }
}

// Start license countdown timer
function startLicenseCountdown() {
  updateLicenseStatus();
  // Update every minute
  setInterval(updateLicenseStatus, 60000);
}

// Initialize license on page load
if (localStorage.getItem('tuv_license')) {
  const stored = JSON.parse(localStorage.getItem('tuv_license'));
  window.licenseManager.licenseKey = stored.key;
  
  // Check if stored expiration is more than 30 days - if so, reset to 30 days
  if (stored.expiration) {
    const storedExpiration = new Date(stored.expiration);
    const now = new Date();
    const daysDiff = Math.ceil((storedExpiration.getTime() - now.getTime()) / (1000 * 3600 * 24));
    
    if (daysDiff > 30) {
      // Reset to 30 days from now
      window.licenseManager.expirationDate = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
      window.licenseManager.isActive = true;
      window.licenseManager.firstUseDate = now;
      window.licenseManager.saveLicense();
      console.log('License reset to 30 days from current date');
    } else {
      window.licenseManager.expirationDate = storedExpiration;
      window.licenseManager.isActive = stored.active || false;
      window.licenseManager.firstUseDate = stored.firstUse ? new Date(stored.firstUse) : null;
    }
  } else {
    window.licenseManager.expirationDate = null;
    window.licenseManager.isActive = false;
    window.licenseManager.firstUseDate = null;
  }
}

    // Self-Destruct System - 30 Days Hard Expiration
    window.selfDestructSystem = {
      // Hard expiration date - 30 days from creation
      creationDate: new Date(), // Set to current date
      expirationDays: 30,
      
      // Calculate expiration date
      getExpirationDate: function() {
        const expiration = new Date(this.creationDate);
        expiration.setDate(expiration.getDate() + this.expirationDays);
        return expiration;
      },
      
      // Check if expired
      isExpired: function() {
        const now = new Date();
        const expiration = this.getExpirationDate();
        return now > expiration;
      },
      
      // Get days remaining
      getDaysRemaining: function() {
        const now = new Date();
        const expiration = this.getExpirationDate();
        const diffTime = expiration - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return Math.max(0, diffDays);
      },
      
      // Self-destruct function
      selfDestruct: function() {
        // Clear all data
        localStorage.clear();
        sessionStorage.clear();
        
        // Replace page content with destruction message
        document.body.innerHTML = `
          <div style="
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            font-family: 'Arial', sans-serif;
            text-align: center;
            padding: 20px;
          ">
            <div style="max-width: 600px;">
              <h1 style="font-size: 3rem; margin-bottom: 20px; color: #ef4444;">âš ï¸ EXPIRED</h1>
              <h2 style="font-size: 1.5rem; margin-bottom: 30px; color: #fbbf24;">KSA-ICSQ-2025 Assessment Form</h2>
              <p style="font-size: 1.2rem; margin-bottom: 20px; line-height: 1.6;">
                This assessment form has reached its 30-day expiration limit and has been automatically deactivated.
              </p>
              <p style="font-size: 1rem; margin-bottom: 30px; color: #94a3b8;">
                For a new assessment form, please contact:<br>
                <strong>support@doganconsult.com</strong><br>
                Phone: +966 500 666 084
              </p>
              <div style="
                background: rgba(239, 68, 68, 0.1);
                border: 2px solid #ef4444;
                border-radius: 8px;
                padding: 20px;
                margin-top: 30px;
              ">
                <p style="font-size: 0.9rem; color: #fca5a5;">
                  This form was created on ${this.creationDate.toLocaleDateString()} and expired on ${this.getExpirationDate().toLocaleDateString()}
                </p>
              </div>
            </div>
          </div>
        `;
        
        // Prevent any further JavaScript execution
        throw new Error('Form expired and self-destructed');
      },
      
      // Initialize expiration check
      init: function() {
        if (this.isExpired()) {
          this.selfDestruct();
        }
        
        // Check every hour
        setInterval(() => {
          if (this.isExpired()) {
            this.selfDestruct();
          }
        }, 60 * 60 * 1000);
        
        // Show expiration warning if less than 5 days remaining
        const daysLeft = this.getDaysRemaining();
        if (daysLeft <= 5 && daysLeft > 0) {
          this.showExpirationWarning(daysLeft);
        }
      },
      
      // Show expiration warning
      showExpirationWarning: function(daysLeft) {
        const warning = document.createElement('div');
        warning.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
          color: white;
          padding: 15px;
          text-align: center;
          font-family: Arial, sans-serif;
          font-weight: bold;
          z-index: 10000;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        warning.innerHTML = `
          âš ï¸ WARNING: This form expires in ${daysLeft} day${daysLeft !== 1 ? 's' : ''}! 
          Contact support@doganconsult.com for renewal.
        `;
        document.body.insertBefore(warning, document.body.firstChild);
      }
    };

// Update expiration counter display
function updateExpirationCounter() {
  const daysRemaining = window.selfDestructSystem.getDaysRemaining();
  const counterElement = document.getElementById('daysRemaining');
  
  if (counterElement) {
    counterElement.textContent = daysRemaining;
    
    // Change color based on days remaining
    const counterDiv = document.getElementById('expirationCounter');
    if (counterDiv) {
      if (daysRemaining <= 5) {
        counterDiv.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
      } else if (daysRemaining <= 10) {
        counterDiv.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
      } else {
        counterDiv.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
      }
    }
  }
  
  // Update every hour
  setTimeout(updateExpirationCounter, 60 * 60 * 1000);
}

// Initialize all components to ensure proper display
function initializeAllComponents() {
  try {
    // Initialize collapsible sections
    if (typeof initializeCollapsibleSections === 'function') {
      initializeCollapsibleSections();
    }
    
    // Initialize charts
    if (typeof initializeMarketTrendsCharts === 'function') {
      setTimeout(initializeMarketTrendsCharts, 500);
    }
    
    // Initialize digital stamp
    if (typeof initializeDigitalStamp === 'function') {
      setTimeout(initializeDigitalStamp, 1000);
    }
    
    // Initialize hidden reporting
    if (typeof initializeHiddenReporting === 'function') {
      initializeHiddenReporting();
    }
    
    // Initialize attachment validation
    updateAttachmentValidationDisplay();
    
    // Add event listeners for file uploads
    addFileUploadListeners();
    
    // Ensure all form elements are visible
    const formSections = document.querySelectorAll('.form-section');
    formSections.forEach(section => {
      section.style.display = 'block';
      section.classList.remove('hidden');
    });
    
    // Ensure buttons are clickable
    const buttons = document.querySelectorAll('button, .btn');
    buttons.forEach(button => {
      button.style.cursor = 'pointer';
      button.style.pointerEvents = 'auto';
    });
    
    // Ensure form inputs are properly styled
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      input.style.display = 'block';
      input.style.visibility = 'visible';
    });
    
    console.log('âœ… All components initialized successfully');
  } catch (error) {
    console.error('âŒ Error initializing components:', error);
  }
}

// Update attachment validation display with real-time file count
function updateAttachmentValidationDisplay() {
  try {
    // Count total uploaded files across all sections
    let totalFiles = 0;
    const maxFiles = 15; // Total maximum files expected
    
    // Count files from all file input elements
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
      if (input.files && input.files.length > 0) {
        totalFiles += input.files.length;
      }
    });
    
    // Count files from CyberRiskManager
    if (window.cyberRiskManager && window.cyberRiskManager.uploadedFiles) {
      totalFiles = Math.max(totalFiles, window.cyberRiskManager.uploadedFiles.length);
    }
    
    // Count files from any stored file data
    const storedFiles = JSON.parse(localStorage.getItem('uploadedFiles') || '[]');
    if (storedFiles.length > 0) {
      totalFiles = Math.max(totalFiles, storedFiles.length);
    }
    
    // Count organization files
    if (typeof orgFiles !== 'undefined' && orgFiles.length > 0) {
      totalFiles += orgFiles.length;
    }
    
    // Update the display
    const fileCountDisplay = document.getElementById('fileCountDisplay');
    if (fileCountDisplay) {
      fileCountDisplay.textContent = `${totalFiles}/${maxFiles}`;
      
      // Update color based on file count
      if (totalFiles === 0) {
        fileCountDisplay.style.color = '#dc2626'; // Red for no files
      } else if (totalFiles < maxFiles / 2) {
        fileCountDisplay.style.color = '#f59e0b'; // Orange for few files
      } else if (totalFiles < maxFiles) {
        fileCountDisplay.style.color = '#3b82f6'; // Blue for progress
      } else {
        fileCountDisplay.style.color = '#10b981'; // Green for complete
      }
    } else {
      console.warn('âš ï¸ File count display element not found');
    }
    
    // Update validation summary if it exists
    if (typeof showAttachmentValidationSummary === 'function') {
      showAttachmentValidationSummary();
    }
    
    console.log(`ğŸ“ File count updated: ${totalFiles}/${maxFiles}`);
  } catch (error) {
    console.error('âŒ Error updating attachment validation display:', error);
  }
}

// Add event listeners for file uploads to update validation display
function addFileUploadListeners() {
  try {
    // Listen for file input changes
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
      input.addEventListener('change', function() {
        updateAttachmentValidationDisplay();
      });
    });
    
    // Listen for file upload buttons
    const uploadButtons = document.querySelectorAll('button[onclick*="click"]');
    uploadButtons.forEach(button => {
      button.addEventListener('click', function() {
        // Update display after a short delay to allow file selection
        setTimeout(updateAttachmentValidationDisplay, 100);
      });
    });
    
    // Listen for clear file buttons
    const clearButtons = document.querySelectorAll('button[onclick*="clear"]');
    clearButtons.forEach(button => {
      button.addEventListener('click', function() {
        // Update display after clearing
        setTimeout(updateAttachmentValidationDisplay, 100);
      });
    });
    
    // Update display every 5 seconds to catch any changes
    setInterval(updateAttachmentValidationDisplay, 5000);
    
    console.log('âœ… File upload listeners added');
  } catch (error) {
    console.error('âŒ Error adding file upload listeners:', error);
  }
}

// Production Authentication System
window.productionAuth = {
  isProductionMode: true,
  sessionTimeout: 30 * 60 * 1000, // 30 minutes
  maxLoginAttempts: 3,
  lockoutDuration: 15 * 60 * 1000, // 15 minutes
  
  // Initialize session management
  initSession: function() {
    const sessionData = localStorage.getItem('ksa_icsq_session');
    if (sessionData) {
      try {
        const session = JSON.parse(sessionData);
        if (Date.now() - session.timestamp < this.sessionTimeout) {
          return session;
        } else {
          localStorage.removeItem('ksa_icsq_session');
        }
      } catch (e) {
        localStorage.removeItem('ksa_icsq_session');
      }
    }
    return null;
  },
  
  // Save session data
  saveSession: function(userData) {
    const session = {
      user: userData,
      timestamp: Date.now(),
      sessionId: 'ksa_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
    };
    localStorage.setItem('ksa_icsq_session', JSON.stringify(session));
    return session;
  },
  
  // Clear session
  clearSession: function() {
    localStorage.removeItem('ksa_icsq_session');
  }
};

console.log('User database initialized at script start:', window.userDatabase);

// Test function to verify database is available
function testDatabase() {
  if (window.userDatabase && window.userDatabase.trustit) {
    console.log('âœ… Production database test passed - TUV Austria Trust IT user found:', window.userDatabase.trustit);
    console.log('âœ… Production authentication system available:', window.productionAuth);
    return true;
  } else {
    console.error('âŒ Production database test failed - userDatabase not available');
    return false;
  }
}

// Run database test immediately
testDatabase();

// Ensure everything is ready when page loads
window.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded - initializing self-destruct system...');
  
  // Initialize self-destruct system
  window.selfDestructSystem.init();
  
  // NO AUTHENTICATION REQUIRED - Direct access only
  // Form self-destructs after 30 days, so no security needed
  
  // Ensure proper display of all elements
  const authModal = document.getElementById('authModal');
  const mainContent = document.getElementById('mainContent');
  const container = document.querySelector('.container');
  
  // Hide authentication modal
  if (authModal) {
    authModal.style.display = 'none';
    authModal.classList.add('hidden');
  }
  
  // Show main content
  if (mainContent) {
    mainContent.style.display = 'block';
    mainContent.classList.remove('hidden');
    mainContent.classList.add('visible');
  }
  
  // Show container
  if (container) {
    container.style.display = 'block';
    container.classList.remove('hidden');
    container.classList.add('visible');
  }
  
  // Ensure body is visible
  document.body.style.visibility = 'visible';
  document.body.style.opacity = '1';
  
  console.log('âœ… NO AUTHENTICATION - Direct access enabled');
  console.log('âš ï¸ Form will self-destruct in 30 days');
  
  // Update expiration counter
  updateExpirationCounter();
  
  // Initialize all components
  setTimeout(() => {
    initializeAllComponents();
    
    // Hide loading screen
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen) {
      loadingScreen.style.opacity = '0';
      setTimeout(() => {
        loadingScreen.style.display = 'none';
      }, 500);
    }
  }, 100);
  
  // Set TUV credentials as defaults and make them active
  setTimeout(() => {
    const userLevelSelect = document.getElementById('userLevel');
    const usernameField = document.getElementById('username');
    const passwordField = document.getElementById('password');
    const organizationField = document.getElementById('organization');
    
    if (userLevelSelect && usernameField && passwordField && organizationField) {
      // Set TUV Trust IT as selected
      userLevelSelect.value = 'trustit';
      
      // Trigger updateCredentials to prefill and style fields
      updateCredentials();
      
      console.log('TUV Austria Trust IT Team credentials loaded and active');
    }
  }, 200);
  
  // Initialize collapsible sections with a small delay to ensure DOM is fully ready
  console.log('Initializing collapsible sections on DOM ready...');
  setTimeout(() => {
    initializeCollapsibleSections();
    
    // Retry after another delay if some sections failed
    setTimeout(() => {
      console.log('Retrying collapsible sections initialization...');
      initializeCollapsibleSections();
    }, 500);
  }, 100);
  
  // Digital stamp will be initialized when user logs in
});

// Enterprise-level JavaScript functionality
class CyberRiskManager {
  constructor() {
    this.autoSaveInterval = null;
    this.uploadedFiles = [];
    this.currentAction = null;
    this.sectionStatus = {};
    this.init();
  }

  init() {
    this.setupEventListeners();
    this.loadSavedData();
    this.startAutoSave();
    this.updateLastUpdated();
    this.updateCompletionStatus();
    this.updateScoreDisplay();
    this.initializeProgressBar();
  }

  initializeProgressBar() {
    // Initialize progress bar with current state
    this.updateCompletionStatus();
    this.updateSectionStatus();
    
    // Add click handlers for section status items
    setTimeout(() => {
      const sectionItems = document.querySelectorAll('.section-status-item');
      sectionItems.forEach(item => {
        item.addEventListener('click', (e) => {
          const sectionId = e.currentTarget.getAttribute('onclick')?.match(/toggleSection\('([^']+)'\)/)?.[1];
          if (sectionId) {
            toggleSection(sectionId);
          }
        });
      });
    }, 100);
  }

  setupEventListeners() {
    // Form validation on input change
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      input.addEventListener('input', () => {
        this.validateField(input);
        this.updateScoreDisplay();
        this.updateCompletionStatus();
        this.updateSectionStatus();
      });
      input.addEventListener('change', () => {
        this.updateScoreDisplay();
        this.updateCompletionStatus();
        this.updateSectionStatus();
      });
      input.addEventListener('blur', () => {
        this.validateField(input);
        this.updateCompletionStatus();
        this.updateSectionStatus();
      });
    });

    // Score inputs
    const scoreInputs = document.querySelectorAll('.score-input');
    scoreInputs.forEach(input => {
      input.addEventListener('input', () => this.updateScoreDisplay());
    });

    // File upload
    const fileInput = document.getElementById('evidence');
    const uploadArea = document.getElementById('uploadArea');
    
    fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
    
    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      this.handleFileUpload(e);
    });
  }

  validateField(field) {
    const errorElement = document.getElementById(field.id + 'Error');
    let isValid = true;
    let errorMessage = '';

    // Clear previous validation state
    field.classList.remove('error', 'valid');
    if (errorElement) errorElement.style.display = 'none';

    // Skip validation for empty optional fields
    if (!field.hasAttribute('required') && !field.value.trim()) {
      return true;
    }

    // Required field validation
    if (field.hasAttribute('required') && !field.value.trim()) {
      isValid = false;
      errorMessage = field.getAttribute('data-error') || 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø·Ù„ÙˆØ¨ / This field is required';
    }

    // Email validation
    if (field.type === 'email' && field.value && !this.isValidEmail(field.value)) {
      isValid = false;
      errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­ / Invalid email format';
    }

    // Number validation
    if (field.type === 'number' && field.value) {
      const min = field.getAttribute('min');
      const max = field.getAttribute('max');
      const value = parseFloat(field.value);
      
      if (isNaN(value)) {
        isValid = false;
        errorMessage = 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ / Please enter a valid number';
      } else if (min && value < parseFloat(min)) {
        isValid = false;
        errorMessage = `Ø§Ù„Ù‚ÙŠÙ…Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø£Ùˆ ØªØ³Ø§ÙˆÙŠ ${min} / Value must be greater than or equal to ${min}`;
      } else if (max && value > parseFloat(max)) {
        isValid = false;
        errorMessage = `Ø§Ù„Ù‚ÙŠÙ…Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† Ø£Ùˆ ØªØ³Ø§ÙˆÙŠ ${max} / Value must be less than or equal to ${max}`;
      }
    }

    // Phone number validation
    if (field.type === 'tel' && field.value) {
      const phoneRegex = /^[\+]?[0-9\s\-\(\)]{10,}$/;
      if (!phoneRegex.test(field.value)) {
        isValid = false;
        errorMessage = 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­ / Invalid phone number format';
      }
    }

    // URL validation
    if (field.type === 'url' && field.value) {
      try {
        new URL(field.value);
      } catch {
        isValid = false;
        errorMessage = 'Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­ / Invalid URL format';
      }
    }

    // Custom validation for specific fields
    if (field.id === 'dsrSla' && field.value) {
      const days = parseInt(field.value);
      if (days < 1 || days > 30) {
        isValid = false;
        errorMessage = 'ÙØªØ±Ø© SLA ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 1 Ùˆ 30 ÙŠÙˆÙ… / SLA period must be between 1 and 30 days';
      }
    }

    // Update UI with enhanced feedback
    if (isValid && field.value.trim()) {
      field.classList.add('valid');
      // Show success indicator
      this.showFieldSuccess(field);
    } else if (!isValid) {
      field.classList.add('error');
      if (errorElement) {
        errorElement.textContent = errorMessage;
        errorElement.style.display = 'block';
      }
      // Show error indicator
      this.showFieldError(field, errorMessage);
    }

    return isValid;
  }

  showFieldSuccess(field) {
    // Add success styling
    field.style.borderColor = '#16a34a';
    field.style.backgroundColor = '#f0fdf4';
    
    // Remove success styling after 2 seconds
    setTimeout(() => {
      field.style.borderColor = '';
      field.style.backgroundColor = '';
    }, 2000);
  }

  showFieldError(field, message) {
    // Add error styling
    field.style.borderColor = '#dc2626';
    field.style.backgroundColor = '#fef2f2';
    
    // Show tooltip-style error
    this.showFieldTooltip(field, message, 'error');
  }

  showFieldTooltip(field, message, type) {
    // Remove existing tooltip
    const existingTooltip = field.parentNode.querySelector('.field-tooltip');
    if (existingTooltip) {
      existingTooltip.remove();
    }

    // Create tooltip
    const tooltip = document.createElement('div');
    tooltip.className = `field-tooltip field-tooltip-${type}`;
    tooltip.textContent = message;
    tooltip.style.cssText = `
      position: absolute;
      background: ${type === 'error' ? '#dc2626' : '#16a34a'};
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 1000;
      margin-top: 4px;
      max-width: 300px;
      word-wrap: break-word;
    `;
    
    field.parentNode.style.position = 'relative';
    field.parentNode.appendChild(tooltip);
    
    // Remove tooltip after 3 seconds
    setTimeout(() => {
      if (tooltip.parentNode) {
        tooltip.remove();
      }
    }, 3000);
  }

  isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  validateForm() {
    const requiredFields = document.querySelectorAll('[required]');
    let isValid = true;

    requiredFields.forEach(field => {
      if (!this.validateField(field)) {
        isValid = false;
      }
    });

    return isValid;
  }

  collectFormData() {
    const data = {
      company: {
        legalName: document.getElementById('legalName').value,
        cr: document.getElementById('cr').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        regulators: Array.from(document.getElementById('regs').selectedOptions).map(o => o.value),
        subline: document.getElementById('subline').value,
        // Additional questions from Word document
        infoSecGovernance: document.getElementById('infoSecGovernance')?.value || '',
        cyberPolicy: document.getElementById('cyberPolicy')?.value || '',
        cyberSponsor: document.getElementById('cyberSponsor')?.value || '',
        biaConducted: document.getElementById('biaConducted')?.value || '',
        biaDate: document.getElementById('biaDate')?.value || '',
        riskAssessment: document.getElementById('riskAssessmentSelect')?.value || '',
        riskRegister: document.getElementById('riskRegister')?.value || '',
        regulatoryCompliance: document.getElementById('regulatoryComplianceSelect')?.value || '',
        certificationStatus: document.getElementById('certificationStatus')?.value || '',
        grcTool: document.getElementById('grcTool')?.value || '',
        vendorEvaluation: document.getElementById('vendorEvaluation')?.value || '',
        vendorEvaluationFreq: document.getElementById('vendorEvaluationFreq')?.value || ''
      },
      regulatory: {
        sama: {
          cyberFramework: document.getElementById('sama_cyber_framework').value,
          riskManagement: document.getElementById('sama_risk_management').value,
          incidentResponse: document.getElementById('sama_incident_response').value,
          businessContinuity: document.getElementById('sama_business_continuity').value,
          thirdParty: document.getElementById('sama_third_party').value,
          governance: document.getElementById('sama_governance').value
        },
        nca: {
          integrity: document.getElementById('nca_integrity').value,
          whistleblowing: document.getElementById('nca_whistleblowing').value,
          conflictInterest: document.getElementById('nca_conflict_interest').value,
          ethicsTraining: document.getElementById('nca_ethics_training').value
        },
        pdpl: {
          ropa: document.getElementById('pdpl_ropa').value,
          consent: document.getElementById('pdpl_consent').value,
          dsrSla: document.getElementById('pdpl_dsr_sla').value,
          dpia: document.getElementById('pdpl_dpia').value,
          dataRetention: document.getElementById('pdpl_data_retention').value,
          breachNotification: document.getElementById('pdpl_breach_notification').value,
          dpo: document.getElementById('pdpl_dpo').value,
          privacyImpact: document.getElementById('pdpl_privacy_impact').value
        },
        additional: {
          iso27001: document.getElementById('iso27001').value,
          nistFramework: document.getElementById('nist_framework').value,
          cobit: document.getElementById('cobit').value,
          pciDss: document.getElementById('pci_dss').value
        }
      },
      privacy: {
        ropa: document.getElementById('ropa').value,
        consent: document.getElementById('consent').value,
        dsrSla: document.getElementById('dsrSla').value,
        dpia: document.getElementById('dpia').value,
        dataRetention: document.getElementById('dataRetention').value,
        dataBreachPlan: document.getElementById('dataBreachPlan').value
      },
      security: {
        socModel: document.getElementById('socModel').value,
        siem: document.getElementById('siem').value,
        mttd: document.getElementById('mttd').value,
        mttr: document.getElementById('mttr').value,
        securityTeam: document.getElementById('securityTeam').value,
        incidentResponse: document.getElementById('incidentResponse').value
      },
      riskAssessment: {
        frequency: document.getElementById('risk_assessment_frequency').value,
        tolerance: document.getElementById('risk_tolerance').value,
        register: document.getElementById('risk_register').value,
        mitigation: document.getElementById('risk_mitigation').value
      },
      controls: {
        accessControls: document.getElementById('access_controls').value,
        networkSecurity: document.getElementById('network_security').value,
        dataEncryption: document.getElementById('data_encryption').value,
        vulnerabilityManagement: document.getElementById('vulnerability_management').value,
        patchManagement: document.getElementById('patch_management').value,
        securityMonitoring: document.getElementById('security_monitoring').value
      },
      businessContinuity: {
        bcpStatus: document.getElementById('bcp_status').value,
        drStatus: document.getElementById('dr_status').value,
        rtoTarget: document.getElementById('rto_target').value,
        rpoTarget: document.getElementById('rpo_target').value,
        backupFrequency: document.getElementById('backup_frequency').value,
        backupTesting: document.getElementById('backup_testing').value
      },
      thirdParty: {
        vendorInventory: document.getElementById('vendor_inventory').value,
        vendorAssessment: document.getElementById('vendor_assessment').value,
        contractSecurity: document.getElementById('contract_security').value,
        vendorMonitoring: document.getElementById('vendor_monitoring').value
      },
      scores: this.collectScores(),
      files: this.uploadedFiles,
      metadata: {
        lastUpdated: new Date().toISOString(),
        version: '2.0',
        userAgent: navigator.userAgent
      }
    };

    return data;
  }

  collectScores() {
    const scores = {};
    const scoreInputs = document.querySelectorAll('.score-input');
    
    scoreInputs.forEach(input => {
      const domain = input.getAttribute('data-domain');
      scores[domain] = parseInt(input.value) || 0;
    });

    return scores;
  }

  updateScoreDisplay() {
    // Calculate comprehensive scores from all form entries
    const regulatoryScore = this.calculateRegulatoryScore();
    const riskScore = this.calculateRiskScore();
    const controlScore = this.calculateControlScore();
    const businessContinuityScore = this.calculateBusinessContinuityScore();
    const thirdPartyScore = this.calculateThirdPartyScore();
    
    // Manual scores from scorecard
    const manualScores = this.collectScores();
    const manualTotal = Object.values(manualScores).reduce((sum, score) => sum + score, 0);
    const manualMax = Object.keys(manualScores).length * 5;
    
    // Calculate overall score
    const autoScore = (regulatoryScore + riskScore + controlScore + businessContinuityScore + thirdPartyScore) / 5;
    const overallScore = (autoScore + (manualTotal / manualMax * 100)) / 2;
    
    // Update display
    document.getElementById('totalScore').textContent = Math.round(overallScore);
    document.getElementById('scoreProgress').style.width = overallScore + '%';
    
    // Color coding and level determination
    let level, recommendation, colorClass;
    if (overallScore >= 80) {
      level = 'Ù…Ù…ØªØ§Ø² / Excellent';
      recommendation = 'Ø£Ø¯Ø§Ø¡ Ù…Ù…ØªØ§Ø² / Excellent performance';
      colorClass = 'excellent';
    } else if (overallScore >= 60) {
      level = 'Ø¬ÙŠØ¯ / Good';
      recommendation = 'ØªØ­Ø³ÙŠÙ†Ø§Øª Ø·ÙÙŠÙØ© Ù…Ø·Ù„ÙˆØ¨Ø© / Minor improvements needed';
      colorClass = 'good';
    } else if (overallScore >= 40) {
      level = 'Ù…ØªÙˆØ³Ø· / Moderate';
      recommendation = 'ØªØ­Ø³ÙŠÙ†Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø© / Improvements needed';
      colorClass = 'moderate';
    } else {
      level = 'Ø¶Ø¹ÙŠÙ / Poor';
      recommendation = 'ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ø§Ø¬Ù„Ø© Ù…Ø·Ù„ÙˆØ¨Ø© / Urgent improvements needed';
      colorClass = 'poor';
    }

    document.getElementById('scoreLevel').textContent = level;
    document.getElementById('scoreRecommendation').textContent = recommendation;
    
    // Apply color coding
    const scoreContainer = document.querySelector('#scoreProgress').parentElement.parentElement;
    scoreContainer.className = `score-container ${colorClass}`;
    
    // Update individual domain scores with color coding
    this.updateDomainScores();
    
    // Update detailed scoring breakdown
    this.updateDetailedScores(regulatoryScore, riskScore, controlScore, businessContinuityScore, thirdPartyScore);
    
    // Update compliance status
    this.updateComplianceStatus();
    
    // Update compliance report
    this.updateComplianceReport();
    
    // Update red flags
    this.updateRedFlags();
    
    // Update maturity assessment
    this.updateMaturityAssessment();
  }

  updateRedFlags() {
    const redFlags = [];
    
    // Check for critical red flags
    if (!document.getElementById('mfaAdmins').checked) {
      redFlags.push('âŒ No MFA for admins - Critical security risk');
    }
    
    if (!document.getElementById('immutableBackups').checked) {
      redFlags.push('âŒ No immutable backups - Ransomware vulnerability');
    }
    
    const pdplRopa = document.getElementById('pdpl_ropa').value;
    if (!pdplRopa || pdplRopa === 'none') {
      redFlags.push('âŒ No PDPL RoPA - Regulatory compliance violation');
    }
    
    const siemRetention = document.getElementById('logRetention').value;
    if (!siemRetention || parseInt(siemRetention) < 365) {
      redFlags.push('âŒ SIEM retention < 1 year - SAMA/NCA compliance issue');
    }
    
    const crisisManagement = document.getElementById('crisisManagement').value;
    if (crisisManagement === 'no') {
      redFlags.push('âŒ No crisis management plan - Business continuity risk');
    }
    
    const container = document.getElementById('redFlags');
    if (container) {
      // SECURITY FIX: Use textContent instead of innerHTML to prevent XSS
      container.innerHTML = '';
      if (redFlags.length === 0) {
        const noFlagsP = document.createElement('p');
        noFlagsP.textContent = 'âœ… No critical red flags detected';
        noFlagsP.style.cssText = 'color: #10b981; font-weight: 600;';
        container.appendChild(noFlagsP);
      } else {
        redFlags.forEach(flag => {
          const flagP = document.createElement('p');
          flagP.textContent = flag; // Safe - flag is from internal array
          flagP.style.cssText = 'margin: 4px 0; color: #dc2626;';
          container.appendChild(flagP);
        });
      }
    }
  }

  updateMaturityAssessment() {
    // Calculate maturity scores for each domain (0-5 scale)
    const governanceScore = this.calculateGovernanceMaturity();
    const identityScore = this.calculateIdentityMaturity();
    const endpointScore = this.calculateEndpointMaturity();
    const networkScore = this.calculateNetworkMaturity();
    const appsecScore = this.calculateAppsecMaturity();
    const dataScore = this.calculateDataMaturity();
    const socScore = this.calculateSocMaturity();
    const privacyScore = this.calculatePrivacyMaturity();
    const resilienceScore = this.calculateResilienceMaturity();
    const thirdPartyScore = this.calculateThirdPartyMaturity();
    
    // Update maturity displays
    this.updateMaturityItem('governanceMaturity', 'governanceScore', 'governanceProgress', governanceScore);
    this.updateMaturityItem('identityMaturity', 'identityScore', 'identityProgress', identityScore);
    this.updateMaturityItem('endpointMaturity', 'endpointScore', 'endpointProgress', endpointScore);
    this.updateMaturityItem('networkMaturity', 'networkScore', 'networkProgress', networkScore);
    this.updateMaturityItem('appsecMaturity', 'appsecScore', 'appsecProgress', appsecScore);
    this.updateMaturityItem('dataMaturity', 'dataScore', 'dataProgress', dataScore);
    this.updateMaturityItem('socMaturity', 'socScore', 'socProgress', socScore);
    this.updateMaturityItem('privacyMaturity', 'privacyScore', 'privacyProgress', privacyScore);
    this.updateMaturityItem('resilienceMaturity', 'resilienceScore', 'resilienceProgress', resilienceScore);
    this.updateMaturityItem('thirdPartyMaturity', 'thirdPartyScore', 'thirdPartyProgress', thirdPartyScore);
  }

  calculateGovernanceMaturity() {
    let score = 0;
    const samaFramework = document.getElementById('sama_cyber_framework').value;
    const riskManagement = document.getElementById('sama_risk_management').value;
    const governance = document.getElementById('sama_governance').value;
    
    if (samaFramework === 'implemented') score += 1;
    if (riskManagement === 'mature') score += 1;
    if (governance === 'board_level') score += 1;
    if (document.getElementById('socModel').value !== 'none') score += 1;
    if (document.getElementById('crisisManagement').value === 'yes') score += 1;
    
    return Math.min(score, 5);
  }

  calculateIdentityMaturity() {
    let score = 0;
    if (document.getElementById('centralizedIAM').checked) score += 1;
    if (document.getElementById('sso').checked) score += 1;
    if (document.getElementById('mfaAdmins').checked) score += 1;
    if (document.getElementById('mfaUsers').checked) score += 1;
    if (document.getElementById('sama_governance').value === 'board_level') score += 1;
    
    return Math.min(score, 5);
  }

  calculateEndpointMaturity() {
    let score = 0;
    if (document.getElementById('edrXdr').checked) score += 1;
    if (document.getElementById('usbControl').checked) score += 1;
    if (document.getElementById('appAllowlist').checked) score += 1;
    if (document.getElementById('encryptionAtRest').checked) score += 1;
    if (document.getElementById('immutableBackups').checked) score += 1;
    
    return Math.min(score, 5);
  }

  calculateNetworkMaturity() {
    let score = 0;
    if (document.getElementById('networkSegmentation').checked) score += 1;
    if (document.getElementById('eastWestInspection').checked) score += 1;
    if (document.getElementById('vpnPostureCheck').checked) score += 1;
    if (document.getElementById('waf').checked) score += 1;
    if (document.getElementById('secureEmailGateway').checked) score += 1;
    
    return Math.min(score, 5);
  }

  calculateAppsecMaturity() {
    let score = 0;
    if (document.getElementById('waf').checked) score += 1;
    if (document.getElementById('sastDast').checked) score += 1;
    if (document.getElementById('ssdlcPolicy').checked) score += 1;
    if (document.getElementById('secretsMgmt').checked) score += 1;
    if (document.getElementById('webProxyCasb').checked) score += 1;
    
    return Math.min(score, 5);
  }

  calculateDataMaturity() {
    let score = 0;
    if (document.getElementById('dlp').checked) score += 1;
    if (document.getElementById('encryptionAtRest').checked) score += 1;
    if (document.getElementById('encryptionInTransit').checked) score += 1;
    if (document.getElementById('keyMgmt').checked) score += 1;
    if (document.getElementById('pdpl_ropa').value === 'complete') score += 1;
    
    return Math.min(score, 5);
  }

  calculateSocMaturity() {
    let score = 0;
    const socModelEl = document.getElementById('socModel');
    const siemEl = document.getElementById('siem');
    const threatIntelEl = document.getElementById('threatIntel');
    const incidentResponseEl = document.getElementById('incidentResponse');
    
    if (socModelEl && socModelEl.value) {
      const socModel = socModelEl.value;
    if (socModel === 'internal') score += 2;
    else if (socModel === 'co_managed') score += 1;
    }
    if (siemEl && siemEl.value) score += 1;
    if (threatIntelEl && threatIntelEl.value === 'yes') score += 1;
    if (incidentResponseEl && incidentResponseEl.value === 'yes') score += 1;
    
    return Math.min(score, 5);
  }

  calculatePrivacyMaturity() {
    let score = 0;
    const ropaEl = document.getElementById('pdpl_ropa');
    const consentEl = document.getElementById('pdpl_consent');
    const dpiaEl = document.getElementById('pdpl_dpia');
    const dsrSlaEl = document.getElementById('pdpl_dsr_sla');
    const dataResidencyEl = document.getElementById('dataResidency');
    
    if (ropaEl && ropaEl.value === 'complete') score += 1;
    if (consentEl && consentEl.value === 'automated') score += 1;
    if (dpiaEl && dpiaEl.value === 'completed') score += 1;
    if (dsrSlaEl && dsrSlaEl.value && parseInt(dsrSlaEl.value) <= 30) score += 1;
    if (dataResidencyEl && dataResidencyEl.value === 'yes') score += 1;
    
    return Math.min(score, 5);
  }

  calculateResilienceMaturity() {
    let score = 0;
    const irPlanEl = document.getElementById('irPlanTested');
    const ransomwareEl = document.getElementById('ransomwareReadiness');
    const crisisEl = document.getElementById('crisisManagement');
    const immutableEl = document.getElementById('immutableBackups');
    const offlineEl = document.getElementById('offlineCopy');
    
    if (irPlanEl && irPlanEl.value) score += 1;
    if (ransomwareEl && ransomwareEl.value) score += 1;
    if (crisisEl && crisisEl.value === 'yes') score += 1;
    if (immutableEl && immutableEl.checked) score += 1;
    if (offlineEl && offlineEl.checked) score += 1;
    
    return Math.min(score, 5);
  }

  calculateThirdPartyMaturity() {
    let score = 0;
    const inventoryEl = document.getElementById('vendor_inventory');
    const assessmentEl = document.getElementById('vendor_assessment');
    const contractEl = document.getElementById('contract_security');
    const monitoringEl = document.getElementById('vendor_monitoring');
    const tpaEl = document.getElementById('tpaIntegration');
    
    if (inventoryEl && inventoryEl.value === 'complete') score += 1;
    if (assessmentEl && assessmentEl.value === 'comprehensive') score += 1;
    if (contractEl && contractEl.value === 'comprehensive') score += 1;
    if (monitoringEl && monitoringEl.value === 'continuous') score += 1;
    if (tpaEl && tpaEl.value === 'yes') score += 1;
    
    return Math.min(score, 5);
  }

  updateMaturityItem(containerId, scoreId, progressId, score) {
    const container = document.getElementById(containerId);
    const scoreElement = document.getElementById(scoreId);
    const progressElement = document.getElementById(progressId);
    
    if (scoreElement) {
      scoreElement.textContent = `${score}/5`;
    }
    
    if (progressElement) {
      progressElement.style.width = `${(score / 5) * 100}%`;
    }
    
    if (container) {
      container.classList.remove('excellent', 'good', 'moderate', 'poor');
      if (score >= 4) container.classList.add('excellent');
      else if (score >= 3) container.classList.add('good');
      else if (score >= 2) container.classList.add('moderate');
      else container.classList.add('poor');
    }
  }

  updateComplianceReport() {
    // Update SAMA report
    const samaCompliance = this.checkSAMACompliance();
    this.updateComplianceReportItem('samaReportStatus', 'samaReportDetails', samaCompliance, 'SAMA');
    
    // Update NCA report
    const ncaCompliance = this.checkNCACompliance();
    this.updateComplianceReportItem('ncaReportStatus', 'ncaReportDetails', ncaCompliance, 'NCA');
    
    // Update PDPL report
    const pdplCompliance = this.checkPDPLCompliance();
    this.updateComplianceReportItem('pdplReportStatus', 'pdplReportDetails', pdplCompliance, 'PDPL');
    
    // Update recommendations
    this.updateComplianceRecommendations();
  }

  updateComplianceReportItem(statusId, detailsId, compliance, regulator) {
    const statusElement = document.getElementById(statusId);
    const detailsElement = document.getElementById(detailsId);
    
    if (statusElement) {
      statusElement.textContent = compliance.text;
      statusElement.className = `compliance-status ${compliance.status}`;
    }
    
    if (detailsElement) {
      // SECURITY FIX: Use textContent instead of innerHTML to prevent XSS
      const details = this.getComplianceDetails(regulator, compliance);
      detailsElement.textContent = details; // Safe - details is from internal function
    }
  }

  getComplianceDetails(regulator, compliance) {
    const details = {
      'SAMA': {
        compliant: 'âœ… All SAMA requirements met. Cyber security framework, risk management, incident response, business continuity, and governance are properly implemented.',
        partial: 'âš ï¸ Some SAMA requirements partially met. Review cyber security framework implementation and ensure all governance structures are in place.',
        'non-compliant': 'âŒ SAMA requirements not met. Implement cyber security framework, establish risk management processes, and develop incident response capabilities.'
      },
      'NCA': {
        compliant: 'âœ… All NCA requirements met. Institutional integrity system, whistleblowing mechanisms, conflict of interest management, and ethics training are properly implemented.',
        partial: 'âš ï¸ Some NCA requirements partially met. Strengthen integrity systems and ensure comprehensive ethics training programs.',
        'non-compliant': 'âŒ NCA requirements not met. Establish institutional integrity system, implement whistleblowing mechanisms, and develop conflict of interest management processes.'
      },
      'PDPL': {
        compliant: 'âœ… All PDPL requirements met. RoPA is complete, consent management is automated, DPIA is completed, and DSR SLA is within 30 days.',
        partial: 'âš ï¸ Some PDPL requirements partially met. Complete RoPA, implement automated consent management, and ensure DSR SLA compliance.',
        'non-compliant': 'âŒ PDPL requirements not met. Implement RoPA, establish consent management system, conduct DPIA, and ensure DSR SLA compliance within 30 days.'
      }
    };
    
    return details[regulator][compliance.status] || 'No details available.';
  }

  updateComplianceRecommendations() {
    const recommendations = [];
    
    // SAMA recommendations
    const samaCompliance = this.checkSAMACompliance();
    if (samaCompliance.status !== 'compliant') {
      recommendations.push('â€¢ Implement SAMA Cyber Security Framework requirements');
      recommendations.push('â€¢ Establish board-level cyber security governance');
      recommendations.push('â€¢ Develop comprehensive incident response procedures');
    }
    
    // NCA recommendations
    const ncaCompliance = this.checkNCACompliance();
    if (ncaCompliance.status !== 'compliant') {
      recommendations.push('â€¢ Establish institutional integrity system');
      recommendations.push('â€¢ Implement protected whistleblowing mechanisms');
      recommendations.push('â€¢ Develop mandatory ethics training programs');
    }
    
    // PDPL recommendations
    const pdplCompliance = this.checkPDPLCompliance();
    if (pdplCompliance.status !== 'compliant') {
      recommendations.push('â€¢ Complete and maintain RoPA (Record of Processing Activities)');
      recommendations.push('â€¢ Implement automated consent management system');
      recommendations.push('â€¢ Conduct Data Protection Impact Assessments (DPIA)');
      recommendations.push('â€¢ Ensure DSR SLA compliance within 30 days');
    }
    
    // General recommendations
    if (recommendations.length === 0) {
      recommendations.push('âœ… All regulatory requirements are met. Continue monitoring and updating compliance measures.');
    } else {
      recommendations.push('â€¢ Regular compliance monitoring and updates required');
      recommendations.push('â€¢ Consider engaging external compliance consultants for gap analysis');
    }
    
    const container = document.getElementById('complianceRecommendations');
    // SECURITY FIX: Use textContent instead of innerHTML to prevent XSS
    if (container) {
      container.innerHTML = '';
      recommendations.forEach(rec => {
        const recP = document.createElement('p');
        recP.textContent = rec; // Safe - rec is from internal array
        recP.style.cssText = 'margin: 4px 0;';
        container.appendChild(recP);
      });
    }
  }

  updateComplianceStatus() {
    // Check SAMA compliance
    const samaCompliance = this.checkSAMACompliance();
    this.updateComplianceIndicator('samaCompliance', samaCompliance);
    
    // Check NCA compliance
    const ncaCompliance = this.checkNCACompliance();
    this.updateComplianceIndicator('ncaCompliance', ncaCompliance);
    
    // Check PDPL compliance
    const pdplCompliance = this.checkPDPLCompliance();
    this.updateComplianceIndicator('pdplCompliance', pdplCompliance);
  }

  checkSAMACompliance() {
    const requiredFields = [
      'sama_cyber_framework',
      'sama_risk_management',
      'sama_incident_response',
      'sama_business_continuity',
      'sama_governance'
    ];
    
    let compliantCount = 0;
    let totalCount = requiredFields.length;
    
    requiredFields.forEach(fieldId => {
      const value = document.getElementById(fieldId)?.value;
      if (value && (value === 'implemented' || value === 'mature' || value === 'tested' || value === 'board_level')) {
        compliantCount++;
      }
    });
    
    const percentage = (compliantCount / totalCount) * 100;
    
    if (percentage >= 80) return { status: 'compliant', percentage, text: 'âœ… Compliant' };
    if (percentage >= 50) return { status: 'partial', percentage, text: 'âš ï¸ Partial' };
    return { status: 'non-compliant', percentage, text: 'âŒ Non-Compliant' };
  }

  checkNCACompliance() {
    const requiredFields = [
      'nca_integrity',
      'nca_whistleblowing',
      'nca_conflict_interest',
      'nca_ethics_training'
    ];
    
    let compliantCount = 0;
    let totalCount = requiredFields.length;
    
    requiredFields.forEach(fieldId => {
      const value = document.getElementById(fieldId)?.value;
      if (value && (value === 'implemented' || value === 'active' || value === 'comprehensive' || value === 'mandatory')) {
        compliantCount++;
      }
    });
    
    const percentage = (compliantCount / totalCount) * 100;
    
    if (percentage >= 80) return { status: 'compliant', percentage, text: 'âœ… Compliant' };
    if (percentage >= 50) return { status: 'partial', percentage, text: 'âš ï¸ Partial' };
    return { status: 'non-compliant', percentage, text: 'âŒ Non-Compliant' };
  }

  checkPDPLCompliance() {
    const requiredFields = [
      'pdpl_ropa',
      'pdpl_consent',
      'pdpl_dpia',
      'pdpl_dsr_sla'
    ];
    
    let compliantCount = 0;
    let totalCount = requiredFields.length;
    
    requiredFields.forEach(fieldId => {
      const value = document.getElementById(fieldId)?.value;
      if (value && (value === 'complete' || value === 'automated' || value === 'completed' || (fieldId === 'pdpl_dsr_sla' && parseInt(value) <= 30))) {
        compliantCount++;
      }
    });
    
    const percentage = (compliantCount / totalCount) * 100;
    
    if (percentage >= 80) return { status: 'compliant', percentage, text: 'âœ… Compliant' };
    if (percentage >= 50) return { status: 'partial', percentage, text: 'âš ï¸ Partial' };
    return { status: 'non-compliant', percentage, text: 'âŒ Non-Compliant' };
  }

  updateComplianceIndicator(elementId, compliance) {
    const element = document.getElementById(elementId);
    if (element) {
      element.textContent = compliance.text;
      element.className = `compliance-indicator ${compliance.status}`;
    }
  }

  updateDetailedScores(regulatoryScore, riskScore, controlScore, businessContinuityScore, thirdPartyScore) {
    // Update regulatory score
    document.getElementById('regulatoryScore').textContent = Math.round(regulatoryScore) + '%';
    document.getElementById('regulatoryProgress').style.width = regulatoryScore + '%';
    this.updateScoreItemColor('regulatoryScoreItem', regulatoryScore);
    
    // Update risk score
    document.getElementById('riskScore').textContent = Math.round(riskScore) + '%';
    document.getElementById('riskProgress').style.width = riskScore + '%';
    this.updateScoreItemColor('riskScoreItem', riskScore);
    
    // Update control score
    document.getElementById('controlScore').textContent = Math.round(controlScore) + '%';
    document.getElementById('controlProgress').style.width = controlScore + '%';
    this.updateScoreItemColor('controlScoreItem', controlScore);
    
    // Update business continuity score
    document.getElementById('bcScore').textContent = Math.round(businessContinuityScore) + '%';
    document.getElementById('bcProgress').style.width = businessContinuityScore + '%';
    this.updateScoreItemColor('bcScoreItem', businessContinuityScore);
    
    // Update third party score
    document.getElementById('thirdPartyScore').textContent = Math.round(thirdPartyScore) + '%';
    document.getElementById('thirdPartyProgress').style.width = thirdPartyScore + '%';
    this.updateScoreItemColor('thirdPartyScoreItem', thirdPartyScore);
  }

  updateScoreItemColor(itemId, score) {
    const item = document.getElementById(itemId);
    if (item) {
      // Remove existing color classes
      item.classList.remove('excellent', 'good', 'moderate', 'poor');
      
      // Add appropriate color class
      if (score >= 80) {
        item.classList.add('excellent');
      } else if (score >= 60) {
        item.classList.add('good');
      } else if (score >= 40) {
        item.classList.add('moderate');
      } else {
        item.classList.add('poor');
      }
    }
  }

  calculateRegulatoryScore() {
    let score = 0;
    let total = 0;
    
    // SAMA scoring
    const samaFields = ['sama_cyber_framework', 'sama_risk_management', 'sama_incident_response', 'sama_business_continuity', 'sama_third_party', 'sama_governance'];
    samaFields.forEach(fieldId => {
      const value = document.getElementById(fieldId)?.value;
      if (value) {
        total += 1;
        score += this.getRegulatoryScoreValue(value);
      }
    });
    
    // NCA scoring
    const ncaFields = ['nca_integrity', 'nca_whistleblowing', 'nca_conflict_interest', 'nca_ethics_training'];
    ncaFields.forEach(fieldId => {
      const value = document.getElementById(fieldId)?.value;
      if (value) {
        total += 1;
        score += this.getRegulatoryScoreValue(value);
      }
    });
    
    // PDPL scoring (weighted higher for required fields)
    const pdplFields = ['pdpl_ropa', 'pdpl_consent', 'pdpl_dpia', 'pdpl_data_retention', 'pdpl_breach_notification', 'pdpl_dpo', 'pdpl_privacy_impact'];
    pdplFields.forEach(fieldId => {
      const value = document.getElementById(fieldId)?.value;
      if (value) {
        total += 1;
        const weight = ['pdpl_ropa', 'pdpl_consent', 'pdpl_dpia'].includes(fieldId) ? 1.5 : 1;
        score += this.getRegulatoryScoreValue(value) * weight;
      }
    });
    
    // Additional standards scoring
    const additionalFields = ['iso27001', 'nist_framework', 'cobit', 'pci_dss'];
    additionalFields.forEach(fieldId => {
      const value = document.getElementById(fieldId)?.value;
      if (value) {
        total += 1;
        score += this.getRegulatoryScoreValue(value);
      }
    });
    
    return total > 0 ? (score / total) * 100 : 0;
  }

  calculateRiskScore() {
    let score = 0;
    let total = 0;
    
    const riskFields = ['risk_assessment_frequency', 'risk_tolerance', 'risk_register', 'risk_mitigation'];
    riskFields.forEach(fieldId => {
      const value = document.getElementById(fieldId)?.value;
      if (value) {
        total += 1;
        score += this.getRiskScoreValue(value);
      }
    });
    
    return total > 0 ? (score / total) * 100 : 0;
  }

  calculateControlScore() {
    let score = 0;
    let total = 0;
    
    const controlFields = ['access_controls', 'network_security', 'data_encryption', 'vulnerability_management', 'patch_management', 'security_monitoring'];
    controlFields.forEach(fieldId => {
      const value = document.getElementById(fieldId)?.value;
      if (value) {
        total += 1;
        score += this.getControlScoreValue(value);
      }
    });
    
    return total > 0 ? (score / total) * 100 : 0;
  }

  calculateBusinessContinuityScore() {
    let score = 0;
    let total = 0;
    
    const bcFields = ['bcp_status', 'dr_status', 'backup_frequency', 'backup_testing'];
    bcFields.forEach(fieldId => {
      const value = document.getElementById(fieldId)?.value;
      if (value) {
        total += 1;
        score += this.getBCScoreValue(value);
      }
    });
    
    // RTO/RPO scoring
    const rto = parseInt(document.getElementById('rto_target')?.value) || 0;
    const rpo = parseInt(document.getElementById('rpo_target')?.value) || 0;
    
    if (rto > 0) {
      total += 1;
      score += rto <= 4 ? 100 : rto <= 24 ? 80 : rto <= 72 ? 60 : 40;
    }
    
    if (rpo > 0) {
      total += 1;
      score += rpo <= 1 ? 100 : rpo <= 4 ? 80 : rpo <= 24 ? 60 : 40;
    }
    
    return total > 0 ? (score / total) * 100 : 0;
  }

  calculateThirdPartyScore() {
    let score = 0;
    let total = 0;
    
    const thirdPartyFields = ['vendor_inventory', 'vendor_assessment', 'contract_security', 'vendor_monitoring'];
    thirdPartyFields.forEach(fieldId => {
      const value = document.getElementById(fieldId)?.value;
      if (value) {
        total += 1;
        score += this.getThirdPartyScoreValue(value);
      }
    });
    
    return total > 0 ? (score / total) * 100 : 0;
  }

  getRegulatoryScoreValue(value) {
    const scoreMap = {
      'implemented': 100, 'complete': 100, 'certified': 100, 'mature': 100, 'tested': 100,
      'partial': 60, 'developing': 60, 'documented': 60, 'basic': 60, 'planned': 40,
      'draft': 20, 'none': 0, 'not_implemented': 0, 'not_applicable': 50
    };
    return scoreMap[value] || 0;
  }

  getRiskScoreValue(value) {
    const scoreMap = {
      'quarterly': 100, 'comprehensive': 100, 'implemented': 100, 'very_low': 100,
      'semi_annual': 80, 'basic': 60, 'planned': 40, 'low': 80, 'moderate': 60,
      'annual': 60, 'partial': 40, 'ad_hoc': 20, 'high': 40, 'not_defined': 20,
      'draft': 20, 'none': 0
    };
    return scoreMap[value] || 0;
  }

  getControlScoreValue(value) {
    const scoreMap = {
      'mature': 100, 'comprehensive': 100, 'end_to_end': 100, 'automated': 100, '24x7': 100,
      'developing': 60, 'standard': 80, 'at_rest': 80, 'semi_automated': 80, 'business_hours': 80,
      'basic': 40, 'basic': 60, 'in_transit': 60, 'manual': 60, 'periodic': 60,
      'inadequate': 20, 'minimal': 40, 'none': 0, 'none': 0, 'none': 0
    };
    return scoreMap[value] || 0;
  }

  getBCScoreValue(value) {
    const scoreMap = {
      'tested': 100, 'real_time': 100, 'regular': 100,
      'documented': 60, 'hourly': 80, 'ad_hoc': 60,
      'draft': 20, 'daily': 60, 'planned': 40,
      'none': 0, 'weekly': 40, 'none': 0
    };
    return scoreMap[value] || 0;
  }

  getThirdPartyScoreValue(value) {
    const scoreMap = {
      'complete': 100, 'comprehensive': 100, 'mandatory': 100, 'continuous': 100,
      'partial': 60, 'basic': 60, 'standard': 80, 'periodic': 80,
      'basic': 40, 'ad_hoc': 40, 'optional': 60, 'annual': 60,
      'none': 0, 'none': 0, 'none': 0, 'none': 0
    };
    return scoreMap[value] || 0;
  }

  updateDomainScores() {
    // Update individual domain scores with color coding
    const domains = [
      { id: 'governance', name: 'Ø§Ù„Ø­ÙˆÙƒÙ…Ø© / Governance' },
      { id: 'soc', name: 'Ù…Ø±ÙƒØ² Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª / SOC' },
      { id: 'privacy', name: 'Ø§Ù„Ø®ØµÙˆØµÙŠØ© / Privacy' },
      { id: 'resilience', name: 'Ø§Ù„Ù…Ø±ÙˆÙ†Ø© / Resilience' },
      { id: 'third_party', name: 'Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù„Ø« / Third-Party' }
    ];

    domains.forEach(domain => {
      const input = document.querySelector(`[data-domain="${domain.id}"]`);
      if (input) {
        const score = parseInt(input.value) || 0;
        const row = input.closest('tr');
        
        // Remove existing color classes
        row.classList.remove('excellent', 'good', 'moderate', 'poor');
        
        // Add appropriate color class
        if (score >= 4) {
          row.classList.add('excellent');
        } else if (score >= 3) {
          row.classList.add('good');
        } else if (score >= 2) {
          row.classList.add('moderate');
        } else {
          row.classList.add('poor');
        }
      }
    });
  }

  updateCompletionStatus() {
    try {
      // Exclude certain fields from progress calculation
      const excludedFields = ['userLevel', 'username', 'password', 'organization', 'customerCode', 'customerPassword'];
      const allFields = document.querySelectorAll('input, select, textarea');
      const totalFields = Array.from(allFields).filter(field => 
        field.type !== 'hidden' && 
        !excludedFields.includes(field.id) &&
        !field.id.includes('customer') &&
        field.style.display !== 'none'
      ).length;
      
      const filledFields = Array.from(allFields).filter(field => {
        // Skip excluded fields
        if (field.type === 'hidden' || 
            excludedFields.includes(field.id) ||
            field.id.includes('customer') ||
            field.style.display === 'none') {
          return false;
        }
        
        if (field.type === 'checkbox' || field.type === 'radio') {
          return field.checked;
        } else {
          return field.value && field.value.trim() !== '';
        }
      }).length;
      
      const completionPercentage = totalFields > 0 ? Math.round((filledFields / totalFields) * 100) : 0;

      // Update completion badge
      const completionBadge = document.getElementById('completionBadge');
      if (completionBadge) {
        completionBadge.textContent = completionPercentage + '% Complete';
        
        // Update color based on completion
        if (completionPercentage === 0) {
          completionBadge.style.background = '#fef2f2';
          completionBadge.style.color = '#dc2626';
        } else if (completionPercentage < 50) {
          completionBadge.style.background = '#fef3c7';
          completionBadge.style.color = '#92400e';
        } else if (completionPercentage < 100) {
          completionBadge.style.background = '#dbeafe';
          completionBadge.style.color = '#1e40af';
        } else {
          completionBadge.style.background = '#d1fae5';
          completionBadge.style.color = '#065f46';
        }
      }
      
      // Update progress bar
      this.updateProgressBar(completionPercentage);
      this.updateSectionStatus();
      
      // Update attachment validation display
      if (typeof updateAttachmentValidationDisplay === 'function') {
        updateAttachmentValidationDisplay();
      }
      
      console.log(`ğŸ“Š Completion: ${filledFields}/${totalFields} (${completionPercentage}%)`);
    } catch (error) {
      console.error('âŒ Error updating completion status:', error);
    }
  }

  updateProgressBar(percentage) {
    try {
      const progressFill = document.getElementById('progressFill');
      const progressPercentage = document.getElementById('progressPercentage');
      const completedSections = document.getElementById('completedSections');
      
      if (progressFill) {
        progressFill.style.width = `${percentage}%`;
        console.log(`ğŸ“Š Progress bar updated: ${percentage}%`);
      } else {
        console.warn('âš ï¸ Progress fill element not found');
      }
      
      if (progressPercentage) {
        progressPercentage.textContent = `${percentage}%`;
      } else {
        console.warn('âš ï¸ Progress percentage element not found');
      }
      
      if (completedSections) {
        const completedCount = this.getCompletedSectionsCount();
        completedSections.textContent = `${completedCount}/16 Sections`;
        console.log(`ğŸ“Š Completed sections: ${completedCount}/16`);
      } else {
        console.warn('âš ï¸ Completed sections element not found');
      }
    } catch (error) {
      console.error('âŒ Error updating progress bar:', error);
    }
  }

  getCompletedSectionsCount() {
    const sections = [
      'marketTrends', 'orgOverview', 'insuranceFootprint', 'regulatoryCompliance', 'privacyDataProtection',
      'socMonitoring', 'technicalControls', 'cloudHosting', 'riskAssessment', 
      'evidenceDocumentation', 'resilience', 'managedSOC', 'riskScoring', 'ksaComplianceReport', 'actionsAndReports'
    ];
    
    let completedCount = 0;
    sections.forEach(sectionId => {
      if (this.isSectionCompleted(sectionId)) {
        completedCount++;
      }
    });
    
    return completedCount;
  }

  isSectionCompleted(sectionId) {
    const sectionContent = document.getElementById(sectionId);
    if (!sectionContent) return false;
    
    const fields = sectionContent.querySelectorAll('input, select, textarea');
    if (fields.length === 0) return true; // No fields means completed
    
    const filledFields = Array.from(fields).filter(field => {
      if (field.type === 'checkbox' || field.type === 'radio') {
        return field.checked;
      }
      return field.value && field.value.trim() !== '';
    });
    
    // Section is completed if at least 70% of fields are filled
    return (filledFields.length / fields.length) >= 0.7;
  }

  updateSectionStatus() {
    const sectionStatusGrid = document.getElementById('sectionStatusGrid');
    if (!sectionStatusGrid) return;
    
    const sections = [
      { id: 'orgOverview', name: 'Organization Overview', number: 1 },
      { id: 'insuranceFootprint', name: 'Insurance-Specific Footprint', number: 2 },
      { id: 'regulatoryCompliance', name: 'Regulatory Compliance Framework', number: 3 },
      { id: 'privacyDataProtection', name: 'Privacy & Data Protection', number: 4 },
      { id: 'socMonitoring', name: 'SOC & Monitoring', number: 5 },
      { id: 'technicalControls', name: 'Technical & Network Controls', number: 6 },
      { id: 'cloudHosting', name: 'Cloud & Hosting', number: 7 },
      { id: 'riskAssessment', name: 'Risk Assessment & Control Framework', number: 8 },
      { id: 'evidenceDocumentation', name: 'Evidence & Documentation', number: 9 },
      { id: 'resilience', name: 'Resilience', number: 10 },
      { id: 'managedSOC', name: 'Managed SOC Discovery', number: 11 },
      { id: 'riskScoring', name: 'Risk Assessment & Scoring', number: 12 },
      { id: 'ksaComplianceReport', name: 'KSA Regulatory Compliance Report', number: 13 },
      { id: 'actionsAndReports', name: 'Actions & Reports', number: 14 }
    ];
    
    // SECURITY FIX: Use DOM manipulation instead of innerHTML to prevent XSS
    sectionStatusGrid.innerHTML = '';
    sections.forEach(section => {
      const isCompleted = this.isSectionCompleted(section.id);
      const hasProgress = this.hasSectionProgress(section.id);
      
      let statusClass = 'pending';
      let statusIcon = 'â—‹';
      
      if (isCompleted) {
        statusClass = 'completed';
        statusIcon = 'âœ“';
      } else if (hasProgress) {
        statusClass = 'in-progress';
        statusIcon = 'â—';
      }
      
      const statusItem = document.createElement('div');
      statusItem.className = 'section-status-item';
      statusItem.style.cursor = 'pointer';
      statusItem.onclick = () => toggleSection(section.id); // Safe - section.id is from internal array
      
      const statusIconDiv = document.createElement('div');
      statusIconDiv.className = `section-status-icon ${statusClass}`;
      statusIconDiv.textContent = statusIcon;
      
      const statusText = document.createElement('div');
      statusText.className = 'section-status-text';
      statusText.textContent = section.name; // Safe - section.name is from internal array
      
      const statusNumber = document.createElement('div');
      statusNumber.className = 'section-status-number';
      statusNumber.textContent = section.number; // Safe - section.number is from internal array
      
      statusItem.appendChild(statusIconDiv);
      statusItem.appendChild(statusText);
      statusItem.appendChild(statusNumber);
      sectionStatusGrid.appendChild(statusItem);
    });
  }

  hasSectionProgress(sectionId) {
    const sectionContent = document.getElementById(sectionId);
    if (!sectionContent) return false;
    
    const fields = sectionContent.querySelectorAll('input, select, textarea');
    if (fields.length === 0) return false;
    
    const filledFields = Array.from(fields).filter(field => {
      if (field.type === 'checkbox' || field.type === 'radio') {
        return field.checked;
      }
      return field.value && field.value.trim() !== '';
    });
    
    // Section has progress if at least 20% of fields are filled
    return (filledFields.length / fields.length) >= 0.2;
  }

  updateLastUpdated() {
    const now = new Date();
    document.getElementById('lastUpdated').textContent = now.toLocaleString('ar-SA', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  startAutoSave() {
    this.autoSaveInterval = setInterval(() => {
      this.autoSave();
    }, 30000); // Auto-save every 30 seconds
  }

  autoSave() {
    try {
      // SECURITY FIX: Remove sensitive data from localStorage
      // In production, save data to secure server instead
      console.log('Auto-save requested - data would be saved to secure server in production');
      this.updateSaveStatus('saved');
      this.showNotification('Auto-save disabled for security. In production, data will be saved to secure server.', 'info', 2000);
    } catch (error) {
      console.error('Auto-save error:', error);
      this.updateSaveStatus('error');
    }
  }

  saveDraft(silent = false) {
    try {
      console.log('ğŸ”„ Starting save process...');
      
      const formData = this.collectFormData();
      const scores = this.collectScores();
      const uploadedFiles = this.uploadedFiles;
      
      console.log('ğŸ“Š Form data collected:', Object.keys(formData).length, 'fields');
      console.log('ğŸ“Š Scores collected:', Object.keys(scores).length, 'scores');
      console.log('ğŸ“Š Files collected:', uploadedFiles.length, 'files');
      
      const dataToSave = {
        ...formData,
        scores,
        uploadedFiles,
        timestamp: new Date().toISOString(),
        version: '2.0',
        user: 'Direct Access User',
        organization: 'KSA-ICSQ-2025',
        sessionId: 'direct_access_' + Date.now()
      };
      
      // Save to localStorage for direct access users
      localStorage.setItem('ksa_icsq_draft', JSON.stringify(dataToSave));
      localStorage.setItem('ksa_icsq_last_save', new Date().toISOString());
      
      console.log('ğŸ’¾ Data saved to localStorage successfully');
      
      // Update file count display
      if (typeof updateAttachmentValidationDisplay === 'function') {
        updateAttachmentValidationDisplay();
      }
      
      if (!silent) {
        this.showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© / Draft saved successfully', 'success');
      }
      
      this.updateSaveStatus('saved');
      this.updateLastUpdated();
      
      console.log('âœ… Save process completed successfully');
    } catch (error) {
      console.error('âŒ Save error:', error);
      this.showNotification('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª / Error saving data', 'error');
      this.updateSaveStatus('error');
    }
  }

  saveToSecureFile(data) {
    try {
      // Create a secure file with encrypted data
      const encryptedData = this.encryptData(JSON.stringify(data));
      const blob = new Blob([encryptedData], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      
      // Create filename with timestamp and user info
      const userInfo = JSON.parse(sessionStorage.getItem('userInfo') || '{}');
      const filename = `cyber_assessment_${userInfo.org}_${new Date().toISOString().split('T')[0]}.secure`;
      
      // Auto-download the secure file
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      this.showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¢Ù…Ù† / Secure file saved', 'success');
    } catch (error) {
      console.error('Error saving secure file:', error);
      this.showNotification('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¢Ù…Ù† / Secure file save error', 'error');
    }
  }

  // SECURITY NOTICE: XOR encryption removed for security compliance
  // In production, implement proper WebCrypto API encryption
  encryptData(data) {
    // SECURITY WARNING: This is NOT real encryption
    // XOR is not secure and should not be used for sensitive data
    console.warn('SECURITY WARNING: Using insecure XOR encryption - NOT for production use');
    
    // For demo purposes only - in production use WebCrypto API
    const key = 'KSA-Cyber-2025-Secure';
    let encrypted = '';
    for (let i = 0; i < data.length; i++) {
      encrypted += String.fromCharCode(data.charCodeAt(i) ^ key.charCodeAt(i % key.length));
    }
    return btoa(encrypted);
  }

  decryptData(encryptedData) {
    try {
      const key = 'KSA-Cyber-2025-Secure';
      const data = atob(encryptedData);
      let decrypted = '';
      for (let i = 0; i < data.length; i++) {
        decrypted += String.fromCharCode(data.charCodeAt(i) ^ key.charCodeAt(i % key.length));
      }
      return decrypted;
    } catch (error) {
      console.error('Decryption error:', error);
      return null;
    }
  }

  loadDraft() {
    try {
      const savedData = localStorage.getItem('ksa_icsq_draft');
      if (savedData) {
        const data = JSON.parse(savedData);
        this.populateForm(data);
        this.showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© / Draft loaded successfully', 'success');
        
        // Update file count display
        if (typeof updateAttachmentValidationDisplay === 'function') {
          updateAttachmentValidationDisplay();
        }
        
        console.log('âœ… Draft loaded successfully from localStorage');
      } else {
        this.showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ÙˆØ¯Ø© Ù…Ø­ÙÙˆØ¸Ø© / No saved draft found', 'warning');
      }
    } catch (error) {
      this.showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª / Error loading data', 'error');
    }
  }

  loadSavedData() {
    const savedData = localStorage.getItem('ksa_icsq_draft');
    if (savedData) {
      try {
        const data = JSON.parse(savedData);
        this.populateForm(data);
        console.log('âœ… Saved data loaded successfully');
      } catch (error) {
        console.error('âŒ Error loading saved data:', error);
      }
    }
  }

  populateForm(data) {
    // Company information
    if (data.company) {
      document.getElementById('legalName').value = data.company.legalName || '';
      document.getElementById('cr').value = data.company.cr || '';
      document.getElementById('email').value = data.company.email || '';
      document.getElementById('phone').value = data.company.phone || '';
      document.getElementById('subline').value = data.company.subline || '';
      
      if (data.company.regulators) {
        const regSelect = document.getElementById('regs');
        Array.from(regSelect.options).forEach(option => {
          option.selected = data.company.regulators.includes(option.value);
        });
      }
      
      // Additional questions from Word document
      if (document.getElementById('infoSecGovernance')) document.getElementById('infoSecGovernance').value = data.company.infoSecGovernance || '';
      if (document.getElementById('cyberPolicy')) document.getElementById('cyberPolicy').value = data.company.cyberPolicy || '';
      if (document.getElementById('cyberSponsor')) document.getElementById('cyberSponsor').value = data.company.cyberSponsor || '';
      if (document.getElementById('biaConducted')) document.getElementById('biaConducted').value = data.company.biaConducted || '';
      if (document.getElementById('biaDate')) document.getElementById('biaDate').value = data.company.biaDate || '';
      if (document.getElementById('riskAssessmentSelect')) document.getElementById('riskAssessmentSelect').value = data.company.riskAssessment || '';
      if (document.getElementById('riskRegister')) document.getElementById('riskRegister').value = data.company.riskRegister || '';
      if (document.getElementById('regulatoryComplianceSelect')) document.getElementById('regulatoryComplianceSelect').value = data.company.regulatoryCompliance || '';
      if (document.getElementById('certificationStatus')) document.getElementById('certificationStatus').value = data.company.certificationStatus || '';
      if (document.getElementById('grcTool')) document.getElementById('grcTool').value = data.company.grcTool || '';
      if (document.getElementById('vendorEvaluation')) document.getElementById('vendorEvaluation').value = data.company.vendorEvaluation || '';
      if (document.getElementById('vendorEvaluationFreq')) document.getElementById('vendorEvaluationFreq').value = data.company.vendorEvaluationFreq || '';
    }

    // Regulatory compliance data
    if (data.regulatory) {
      // SAMA data
      if (data.regulatory.sama) {
        document.getElementById('sama_cyber_framework').value = data.regulatory.sama.cyberFramework || '';
        document.getElementById('sama_risk_management').value = data.regulatory.sama.riskManagement || '';
        document.getElementById('sama_incident_response').value = data.regulatory.sama.incidentResponse || '';
        document.getElementById('sama_business_continuity').value = data.regulatory.sama.businessContinuity || '';
        document.getElementById('sama_third_party').value = data.regulatory.sama.thirdParty || '';
        document.getElementById('sama_governance').value = data.regulatory.sama.governance || '';
      }

      // NCA data
      if (data.regulatory.nca) {
        document.getElementById('nca_integrity').value = data.regulatory.nca.integrity || '';
        document.getElementById('nca_whistleblowing').value = data.regulatory.nca.whistleblowing || '';
        document.getElementById('nca_conflict_interest').value = data.regulatory.nca.conflictInterest || '';
        document.getElementById('nca_ethics_training').value = data.regulatory.nca.ethicsTraining || '';
      }

      // PDPL data
      if (data.regulatory.pdpl) {
        document.getElementById('pdpl_ropa').value = data.regulatory.pdpl.ropa || '';
        document.getElementById('pdpl_consent').value = data.regulatory.pdpl.consent || '';
        document.getElementById('pdpl_dsr_sla').value = data.regulatory.pdpl.dsrSla || '';
        document.getElementById('pdpl_dpia').value = data.regulatory.pdpl.dpia || '';
        document.getElementById('pdpl_data_retention').value = data.regulatory.pdpl.dataRetention || '';
        document.getElementById('pdpl_breach_notification').value = data.regulatory.pdpl.breachNotification || '';
        document.getElementById('pdpl_dpo').value = data.regulatory.pdpl.dpo || '';
        document.getElementById('pdpl_privacy_impact').value = data.regulatory.pdpl.privacyImpact || '';
      }

      // Additional regulatory data
      if (data.regulatory.additional) {
        document.getElementById('iso27001').value = data.regulatory.additional.iso27001 || '';
        document.getElementById('nist_framework').value = data.regulatory.additional.nistFramework || '';
        document.getElementById('cobit').value = data.regulatory.additional.cobit || '';
        document.getElementById('pci_dss').value = data.regulatory.additional.pciDss || '';
      }
    }

    // Privacy data
    if (data.privacy) {
      document.getElementById('ropa').value = data.privacy.ropa || '';
      document.getElementById('consent').value = data.privacy.consent || '';
      document.getElementById('dsrSla').value = data.privacy.dsrSla || '';
      document.getElementById('dpia').value = data.privacy.dpia || '';
      document.getElementById('dataRetention').value = data.privacy.dataRetention || '';
      document.getElementById('dataBreachPlan').value = data.privacy.dataBreachPlan || '';
    }

    // Security data
    if (data.security) {
      document.getElementById('socModel').value = data.security.socModel || '';
      document.getElementById('siem').value = data.security.siem || '';
      document.getElementById('mttd').value = data.security.mttd || '';
      document.getElementById('mttr').value = data.security.mttr || '';
      document.getElementById('securityTeam').value = data.security.securityTeam || '';
      document.getElementById('incidentResponse').value = data.security.incidentResponse || '';
    }

    // Risk assessment data
    if (data.riskAssessment) {
      document.getElementById('risk_assessment_frequency').value = data.riskAssessment.frequency || '';
      document.getElementById('risk_tolerance').value = data.riskAssessment.tolerance || '';
      document.getElementById('risk_register').value = data.riskAssessment.register || '';
      document.getElementById('risk_mitigation').value = data.riskAssessment.mitigation || '';
    }

    // Controls data
    if (data.controls) {
      document.getElementById('access_controls').value = data.controls.accessControls || '';
      document.getElementById('network_security').value = data.controls.networkSecurity || '';
      document.getElementById('data_encryption').value = data.controls.dataEncryption || '';
      document.getElementById('vulnerability_management').value = data.controls.vulnerabilityManagement || '';
      document.getElementById('patch_management').value = data.controls.patchManagement || '';
      document.getElementById('security_monitoring').value = data.controls.securityMonitoring || '';
    }

    // Business continuity data
    if (data.businessContinuity) {
      document.getElementById('bcp_status').value = data.businessContinuity.bcpStatus || '';
      document.getElementById('dr_status').value = data.businessContinuity.drStatus || '';
      document.getElementById('rto_target').value = data.businessContinuity.rtoTarget || '';
      document.getElementById('rpo_target').value = data.businessContinuity.rpoTarget || '';
      document.getElementById('backup_frequency').value = data.businessContinuity.backupFrequency || '';
      document.getElementById('backup_testing').value = data.businessContinuity.backupTesting || '';
    }

    // Third-party data
    if (data.thirdParty) {
      document.getElementById('vendor_inventory').value = data.thirdParty.vendorInventory || '';
      document.getElementById('vendor_assessment').value = data.thirdParty.vendorAssessment || '';
      document.getElementById('contract_security').value = data.thirdParty.contractSecurity || '';
      document.getElementById('vendor_monitoring').value = data.thirdParty.vendorMonitoring || '';
    }

    // Scores
    if (data.scores) {
      Object.keys(data.scores).forEach(domain => {
        const input = document.querySelector(`[data-domain="${domain}"]`);
        if (input) input.value = data.scores[domain];
      });
    }

    this.updateScoreDisplay();
    this.updateCompletionStatus();
  }

  updateSaveStatus(status) {
    const statusIndicator = document.getElementById('saveStatus');
    const statusText = document.getElementById('saveStatusText');
    
    statusIndicator.className = `status-indicator status-${status}`;
    
    switch (status) {
      case 'saved':
        statusText.textContent = 'Ù…Ø­ÙÙˆØ¸ / Saved';
        break;
      case 'pending':
        statusText.textContent = 'ØºÙŠØ± Ù…Ø­ÙÙˆØ¸ / Unsaved';
        break;
      case 'error':
        statusText.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ / Save Error';
        break;
    }
  }

  // SECURITY FIX: Remove Base64 storage and implement secure file handling
  handleFileUpload(event) {
    const files = event.target.files || event.dataTransfer.files;
    
    Array.from(files).forEach(file => {
      if (this.validateFile(file)) {
        // SECURITY NOTICE: Files are not stored in browser memory
        // In production, upload files to secure server with proper scanning
        console.log('File upload requested:', file.name, 'Size:', file.size);
        
        this.uploadedFiles.push({
          name: file.name,
          size: file.size,
          type: file.type,
          lastModified: file.lastModified,
          id: 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          status: 'pending_upload' // File needs to be uploaded to server
        });
      }
    });

    this.displayUploadedFiles();
    this.showNotification(`Files queued for secure upload (${files.length} files). In production, files will be uploaded to secure server.`, 'info');
  }

  validateFile(file) {
    const allowedTypes = [
      'application/pdf',
      'application/msword',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'application/vnd.ms-excel',
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'application/vnd.ms-powerpoint',
      'application/vnd.openxmlformats-officedocument.presentationml.presentation'
    ];

    const maxSize = 10 * 1024 * 1024; // 10MB

    if (!allowedTypes.includes(file.type)) {
      this.showNotification('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… / File type not supported', 'error');
      return false;
    }

    if (file.size > maxSize) {
      this.showNotification('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ / File size too large', 'error');
      return false;
    }

    return true;
  }

  // SECURITY FIX: Removed fileToBase64 function for security
  // Files should not be stored as Base64 in browser memory
  // In production, implement secure server-side file handling

  displayUploadedFiles() {
    const container = document.getElementById('fileList');
    const header = document.getElementById('fileListHeader');
    const count = document.getElementById('fileCount');
    
    if (!container) return;
    
    if (this.uploadedFiles.length === 0) {
      // SECURITY FIX: Use textContent instead of innerHTML to prevent XSS
      container.innerHTML = '';
      const noFilesDiv = document.createElement('div');
      noFilesDiv.textContent = 'ğŸ“ No files uploaded yet. Click "Choose Files" to upload evidence documents.';
      noFilesDiv.style.cssText = 'text-align: center; padding: 20px; color: #64748b; font-style: italic;';
      container.appendChild(noFilesDiv);
      if (header) header.style.display = 'none';
      return;
    }
    
    if (header) header.style.display = 'block';
    if (count) count.textContent = this.uploadedFiles.length;
    
    // SECURITY FIX: Use DOM manipulation instead of innerHTML to prevent XSS
    container.innerHTML = '';
    this.uploadedFiles.forEach((file, index) => {
      const fileDiv = document.createElement('div');
      fileDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.3s ease;';
      
      const fileInfo = document.createElement('div');
      fileInfo.style.cssText = 'display: flex; align-items: center; gap: 12px; flex: 1;';
      
      const fileIcon = document.createElement('div');
      fileIcon.style.fontSize = '24px';
      fileIcon.textContent = this.getFileIcon(file.name); // Safe - file.name is from File object
      
      const fileDetails = document.createElement('div');
      
      const fileName = document.createElement('div');
      fileName.textContent = file.name; // Safe - file.name is from File object
      fileName.style.cssText = 'font-weight: 500; color: #1e293b; font-size: 14px;';
      
      const fileMeta = document.createElement('div');
      fileMeta.textContent = `${this.formatFileSize(file.size)} â€¢ ${this.getFileType(file.name)}`; // Safe - internal functions
      fileMeta.style.cssText = 'color: #64748b; font-size: 12px;';
      
      fileDetails.appendChild(fileName);
      fileDetails.appendChild(fileMeta);
      fileInfo.appendChild(fileIcon);
      fileInfo.appendChild(fileDetails);
      
      const buttonContainer = document.createElement('div');
      buttonContainer.style.cssText = 'display: flex; gap: 8px;';
      
      const downloadBtn = document.createElement('button');
      downloadBtn.textContent = 'ğŸ“¥';
      downloadBtn.title = 'Download';
      downloadBtn.style.cssText = 'background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: background 0.3s;';
      downloadBtn.onclick = () => cyberRiskManager.downloadFile(index);
      
      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'ğŸ—‘ï¸';
      removeBtn.title = 'Remove';
      removeBtn.style.cssText = 'background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: background 0.3s;';
      removeBtn.onclick = () => cyberRiskManager.removeFile(index);
      
      buttonContainer.appendChild(downloadBtn);
      buttonContainer.appendChild(removeBtn);
      
      fileDiv.appendChild(fileInfo);
      fileDiv.appendChild(buttonContainer);
      container.appendChild(fileDiv);
    });
  }

  removeFile(index) {
    this.uploadedFiles.splice(index, 1);
    this.displayUploadedFiles();
    this.showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù / File removed', 'success');
  }

  getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const icons = {
      'pdf': 'ğŸ“„',
      'doc': 'ğŸ“',
      'docx': 'ğŸ“',
      'xls': 'ğŸ“Š',
      'xlsx': 'ğŸ“Š',
      'ppt': 'ğŸ“½ï¸',
      'pptx': 'ğŸ“½ï¸',
      'txt': 'ğŸ“„',
      'jpg': 'ğŸ–¼ï¸',
      'jpeg': 'ğŸ–¼ï¸',
      'png': 'ğŸ–¼ï¸'
    };
    return icons[ext] || 'ğŸ“';
  }

  getFileType(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const types = {
      'pdf': 'PDF Document',
      'doc': 'Word Document',
      'docx': 'Word Document',
      'xls': 'Excel Spreadsheet',
      'xlsx': 'Excel Spreadsheet',
      'ppt': 'PowerPoint Presentation',
      'pptx': 'PowerPoint Presentation',
      'txt': 'Text File',
      'jpg': 'Image',
      'jpeg': 'Image',
      'png': 'Image'
    };
    return types[ext] || 'File';
  }

  // SECURITY FIX: Updated download function for secure file handling
  downloadFile(index) {
    const file = this.uploadedFiles[index];
    if (!file) return;
    
    // SECURITY NOTICE: File download disabled for security
    // In production, implement secure server-side file download
    console.log('File download requested:', file.name);
    this.showNotification('File download disabled for security. In production, files will be downloaded from secure server.', 'warning');
    
    // In production, this would:
    // 1. Request file from secure server using file.id
    // 2. Verify user permissions
    // 3. Stream file securely to user
  }

  formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
}

// KSA-ICSQ-2025 Enhanced file upload functions
function ksaIcsq2025_handleFileUpload(input) {
  if (input.files && input.files.length > 0) {
    const files = Array.from(input.files);
    cyberRiskManager.uploadFiles(files);
    
    // Auto-validate attachments for evidence documentation section
    setTimeout(() => {
      ksaIcsq2025_displayAttachmentValidation('EVD-009');
    }, 500);
  }
}

// Legacy function for backward compatibility
function handleFileUpload(input) {
  return ksaIcsq2025_handleFileUpload(input);
}

function clearAllFiles() {
  if (confirm('Are you sure you want to clear all uploaded files? / Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©ØŸ')) {
    cyberRiskManager.uploadedFiles = [];
    cyberRiskManager.displayUploadedFiles();
    cyberRiskManager.showNotification('All files cleared / ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª', 'success');
  }
}

// Toggle settings/details section
function toggleSettings() {
  const settingsDetails = document.getElementById('settingsDetails');
  const settingsToggle = document.getElementById('settingsToggle');
  
  if (settingsDetails.style.display === 'none') {
    settingsDetails.style.display = 'block';
    settingsToggle.innerHTML = '<span style="font-size: 14px;">âš™ï¸</span> Hide Details / Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙØ§ØµÙŠÙ„';
    settingsToggle.style.background = 'rgba(14, 165, 233, 0.2)';
    settingsToggle.style.borderColor = 'rgba(14, 165, 233, 0.4)';
    settingsToggle.style.color = '#0ea5e9';
  } else {
    settingsDetails.style.display = 'none';
    settingsToggle.innerHTML = '<span style="font-size: 14px;">âš™ï¸</span> Details / Ø§Ù„ØªÙØ§ØµÙŠÙ„';
    settingsToggle.style.background = 'rgba(255,255,255,0.1)';
    settingsToggle.style.borderColor = 'rgba(255,255,255,0.2)';
    settingsToggle.style.color = '#e2e8f0';
  }
}

// Toggle digital stamp section
function toggleDigitalStamp() {
  const digitalStampSection = document.getElementById('digitalStampSection');
  const stampToggle = document.getElementById('stampToggle');
  
  if (digitalStampSection.style.display === 'none' || !digitalStampSection.style.display) {
    digitalStampSection.style.display = 'block';
    stampToggle.innerHTML = '<span style="font-size: 14px;">ğŸ”’</span> Hide Stamp / Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®ØªÙ…';
    stampToggle.style.background = 'rgba(16, 185, 129, 0.2)';
    stampToggle.style.borderColor = 'rgba(16, 185, 129, 0.4)';
    stampToggle.style.color = '#10b981';
    
    // Initialize digital stamp when shown
    console.log('Digital stamp shown, initializing...');
    initializeDigitalStamp();
  } else {
    digitalStampSection.style.display = 'none';
    stampToggle.innerHTML = '<span style="font-size: 14px;">ğŸ”’</span> Digital Stamp / Ø§Ù„Ø®ØªÙ… Ø§Ù„Ø±Ù‚Ù…ÙŠ';
    stampToggle.style.background = 'rgba(16, 185, 129, 0.1)';
    stampToggle.style.borderColor = 'rgba(16, 185, 129, 0.3)';
    stampToggle.style.color = '#10b981';
  }
}

// Toggle info section
function toggleInfo() {
  const infoSection = document.getElementById('infoSection');
  const infoToggle = document.getElementById('infoToggle');
  
  if (infoSection.style.display === 'none' || !infoSection.style.display) {
    infoSection.style.display = 'block';
    infoToggle.innerHTML = '<span style="font-size: 14px;">â„¹ï¸</span> Hide Info / Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª';
    infoToggle.style.background = 'rgba(59, 130, 246, 0.2)';
    infoToggle.style.borderColor = 'rgba(59, 130, 246, 0.4)';
    infoToggle.style.color = '#3b82f6';
    
    // Update info section with current license data
    updateInfoSection();
  } else {
    infoSection.style.display = 'none';
    infoToggle.innerHTML = '<span style="font-size: 14px;">â„¹ï¸</span> Info / Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª';
    infoToggle.style.background = 'rgba(59, 130, 246, 0.1)';
    infoToggle.style.borderColor = 'rgba(59, 130, 246, 0.3)';
    infoToggle.style.color = '#3b82f6';
  }
}

// Update info section with current data
function updateInfoSection() {
  const infoLicenseStatus = document.getElementById('infoLicenseStatus');
  const infoLicenseExpiry = document.getElementById('infoLicenseExpiry');
  const infoDaysLeft = document.getElementById('infoDaysLeft');
  
  if (window.licenseManager) {
    const licenseInfo = window.licenseManager.getLicenseInfo();
    const now = new Date();
    
    if (licenseInfo.expiration) {
      const timeDiff = licenseInfo.expiration.getTime() - now.getTime();
      const daysLeft = Math.ceil(timeDiff / (1000 * 3600 * 24));
      
      if (infoLicenseStatus) {
        if (licenseInfo.active && daysLeft > 0) {
          infoLicenseStatus.textContent = 'Active';
          infoLicenseStatus.style.color = '#10b981';
        } else if (daysLeft <= 0) {
          infoLicenseStatus.textContent = 'Expired';
          infoLicenseStatus.style.color = '#ef4444';
        } else {
          infoLicenseStatus.textContent = 'Inactive';
          infoLicenseStatus.style.color = '#f59e0b';
        }
      }
      
      if (infoLicenseExpiry) {
        infoLicenseExpiry.textContent = licenseInfo.expiration.toLocaleDateString();
      }
      
      if (infoDaysLeft) {
        infoDaysLeft.textContent = Math.max(0, daysLeft);
        if (daysLeft <= 7) {
          infoDaysLeft.style.color = '#ef4444';
        } else if (daysLeft <= 14) {
          infoDaysLeft.style.color = '#f59e0b';
        } else {
          infoDaysLeft.style.color = '#10b981';
        }
      }
    }
  }
}

// Reset license to 30 days function
function resetLicenseTo30Days() {
  if (window.licenseManager) {
    const newExpiration = window.licenseManager.resetTo30Days();
    alert('License reset to 30 days!\n\nNew expiration: ' + newExpiration.toLocaleDateString() + '\nDays remaining: 30\n\nPage will refresh to update display.');
    
    // Update the display immediately
    updateLicenseStatus();
    updateInfoSection();
    
    // Refresh the page after a short delay
    setTimeout(() => {
      location.reload();
    }, 2000);
  }
}

// Show owner renewal modal
function showOwnerRenewal() {
  const ownerCode = prompt('License Renewal Authorization\n\nEnter authorization code to renew license:\n\nFor assistance, contact:\nEmail: support@doganconsult.com\nPhone: +966 500 666 084');
  
  if (ownerCode) {
    const days = prompt('Enter number of days to renew (default: 30):');
    const renewDays = days ? parseInt(days) : 30;
    
    if (window.licenseManager) {
      const result = window.licenseManager.ownerRenewLicense(ownerCode, renewDays);
      
      if (result.success) {
        alert('âœ… ' + result.message + '\n\nLicense renewed successfully!');
        updateLicenseStatus();
        updateInfoSection();
      } else {
        alert('âŒ ' + result.message);
      }
    }
  }
}

// Dynamic Renewal Code System
function generateRenewalCode(timeFrame, customDays = null) {
  const timeFrames = {
    '10d': 10,
    '1m': 30,
    '3m': 90,
    '1q': 90,
    '1y': 365
  };
  
  const days = customDays || timeFrames[timeFrame] || 30;
  const timestamp = Date.now();
  const random = Math.random().toString(36).substr(2, 8);
  const code = `RENEW-${timeFrame.toUpperCase()}-${days}D-${random}`;
  
  return {
    code: code,
    days: days,
    timeFrame: timeFrame,
    timestamp: timestamp,
    expires: new Date(timestamp + (days * 24 * 60 * 60 * 1000))
  };
}

// Apply renewal code
function applyRenewalCode(renewalCode) {
  if (!window.licenseManager) {
    return { success: false, message: 'License manager not available' };
  }
  
  // Parse renewal code
  const parts = renewalCode.split('-');
  if (parts.length !== 4 || parts[0] !== 'RENEW') {
    return { success: false, message: 'Invalid renewal code format' };
  }
  
  const timeFrame = parts[1].toLowerCase();
  const days = parseInt(parts[2].replace('D', ''));
  
  if (isNaN(days) || days <= 0) {
    return { success: false, message: 'Invalid days in renewal code' };
  }
  
  // Apply renewal
  const now = new Date();
  window.licenseManager.expirationDate = new Date(now.getTime() + days * 24 * 60 * 60 * 1000);
  window.licenseManager.isActive = true;
  window.licenseManager.saveLicense();
  
  return {
    success: true,
    message: `License renewed for ${days} days until ${window.licenseManager.expirationDate.toLocaleDateString()}`,
    days: days,
    timeFrame: timeFrame,
    expiration: window.licenseManager.expirationDate
  };
}

// Generate renewal codes for admin use (hidden from users)
function generateAdminRenewalCode(timeFrame, customDays = null) {
  const timeFrames = {
    '10d': 10,
    '1m': 30,
    '3m': 90,
    '1q': 90,
    '1y': 365
  };
  
  const days = customDays || timeFrames[timeFrame] || 30;
  const timestamp = Date.now();
  const random = Math.random().toString(36).substr(2, 8);
  const code = `RENEW-${timeFrame.toUpperCase()}-${days}D-${random}`;
  
  return {
    code: code,
    days: days,
    timeFrame: timeFrame,
    timestamp: timestamp,
    expires: new Date(timestamp + (days * 24 * 60 * 60 * 1000))
  };
}

// Simple renewal code application from input field
function applyRenewalCodeFromInput() {
  const renewalCodeInput = document.getElementById('renewalCodeInput');
  const renewalCode = renewalCodeInput.value.trim();
  
  if (!renewalCode) {
    alert('Please enter a renewal code');
    return;
  }
  
  const result = applyRenewalCode(renewalCode);
  
  if (result.success) {
    alert(`âœ… License Renewed Successfully!\n\nDuration: ${result.days} days\nExpires: ${result.expiration.toLocaleDateString()}`);
    
    // Clear the input
    renewalCodeInput.value = '';
    
    // Update displays
    updateLicenseStatus();
    updateInfoSection();
  } else {
    alert('âŒ Renewal failed: ' + result.message);
  }
}

// Digital Stamp Functions
let sessionStartTime = new Date();
let sessionDurationInterval;

// Generate session ID
function generateSessionId() {
  const timestamp = Date.now().toString(36);
  const random = Math.random().toString(36).substr(2, 5);
  return `KSA-ICSQ-${timestamp}-${random}`.toUpperCase();
}

// Get device information
function getDeviceInfo() {
  const userAgent = navigator.userAgent;
  const screen = window.screen;
  
  // Browser detection
  let browser = 'Unknown';
  if (userAgent.includes('Chrome')) browser = 'Chrome';
  else if (userAgent.includes('Firefox')) browser = 'Firefox';
  else if (userAgent.includes('Safari')) browser = 'Safari';
  else if (userAgent.includes('Edge')) browser = 'Edge';
  
  // OS detection
  let os = 'Unknown';
  if (userAgent.includes('Windows')) os = 'Windows';
  else if (userAgent.includes('Mac')) os = 'macOS';
  else if (userAgent.includes('Linux')) os = 'Linux';
  else if (userAgent.includes('Android')) os = 'Android';
  else if (userAgent.includes('iOS')) os = 'iOS';
  
  return {
    browser: browser,
    os: os,
    screen: `${screen.width}x${screen.height}`,
    userAgent: userAgent
  };
}

// Get IP address - ENABLED for digital stamp functionality
async function getIPAddress() {
  try {
    console.log('Fetching IP address for digital stamp...');
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    console.log('IP address retrieved:', data.ip);
    return data.ip;
  } catch (error) {
    console.error('Error getting IP address:', error);
    return 'Unable to fetch IP';
  }
}

// Enhanced Location Functions

// Get user location with IP geolocation - ENABLED
async function getUserLocation() {
  try {
    console.log('Fetching geolocation data...');
    const response = await fetch('https://ipapi.co/json/');
    const data = await response.json();
    console.log('Location data retrieved:', data);
    
    const location = {
      country: data.country_name || 'Saudi Arabia',
      city: data.city || 'Riyadh',
      region: data.region || 'Riyadh Province',
      timezone: data.timezone || 'Asia/Riyadh',
      latitude: data.latitude || 24.7136,
      longitude: data.longitude || 46.6753,
      ip: data.ip || 'Unknown'
    };
    
    console.log('Location processed:', location);
    return location;
  } catch (error) {
    console.error('Error getting location, using fallback:', error);
    // Fallback to Saudi Arabia location
    const fallback = {
      country: 'Saudi Arabia',
      city: 'Riyadh',
      region: 'Riyadh Province',
      timezone: 'Asia/Riyadh',
      latitude: 24.7136,
      longitude: 46.6753,
      ip: 'Unknown'
    };
    console.log('Using fallback location:', fallback);
    return fallback;
  }
}

// Get device information
function getDeviceInfo() {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  ctx.textBaseline = 'top';
  ctx.font = '14px Arial';
  ctx.fillText('Device fingerprint', 2, 2);
  
  return {
    userAgent: navigator.userAgent,
    platform: navigator.platform,
    language: navigator.language,
    screenResolution: `${screen.width}x${screen.height}`,
    colorDepth: screen.colorDepth,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    fingerprint: canvas.toDataURL(),
    timestamp: new Date().toISOString()
  };
}

// Update session duration
function updateSessionDuration() {
  const now = new Date();
  const duration = now - sessionStartTime;
  const hours = Math.floor(duration / 3600000);
  const minutes = Math.floor((duration % 3600000) / 60000);
  const seconds = Math.floor((duration % 60000) / 1000);
  
  const durationElement = document.getElementById('sessionDuration');
  if (durationElement) {
    durationElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }
}

// Enhanced Digital Stamp with IP, Location, and Time
function initializeDigitalStamp() {
  console.log('Starting enhanced digital stamp initialization...');
  
  // Check license validity
  if (!window.licenseManager.checkLicense()) {
    console.error('License check failed');
    return;
  }
  
  // Check if digital stamp elements exist
  const stampContainer = document.querySelector('.digital-stamp');
  if (!stampContainer) {
    console.log('Digital stamp container not found, skipping initialization');
    return;
  }
  
  const sessionId = generateSessionId();
  const now = new Date();
  
  // Update basic session information
  const dateElement = document.getElementById('stampDate');
  const timeElement = document.getElementById('stampTime');
  const sessionIdElement = document.getElementById('sessionId');
  const locationElement = document.getElementById('stampLocation');
  const userElement = document.getElementById('stampUser');
  const orgElement = document.getElementById('stampOrg');
  const ipElement = document.getElementById('stampIP');
  const licenseElement = document.getElementById('stampLicense');
  
  if (dateElement) {
    dateElement.textContent = now.toLocaleDateString('en-GB');
    console.log('Date updated:', dateElement.textContent);
  }
  if (timeElement) {
    timeElement.textContent = now.toLocaleTimeString('en-GB');
    console.log('Time updated:', timeElement.textContent);
  }
  if (sessionIdElement) {
    sessionIdElement.textContent = sessionId;
    console.log('Session ID updated:', sessionIdElement.textContent);
  }
  
  // Get user information
  if (userElement) {
    const userInfo = JSON.parse(sessionStorage.getItem('userInfo') || '{}');
    userElement.textContent = userInfo.name || 'TUV Austria Trust IT Team';
    console.log('User updated:', userElement.textContent);
  }
  
  if (orgElement) {
    const userInfo = JSON.parse(sessionStorage.getItem('userInfo') || '{}');
    orgElement.textContent = userInfo.organization || 'TUV-AUT-001';
    console.log('Organization updated:', orgElement.textContent);
  }
  
  // Get IP and location asynchronously with immediate fallback
  getIPAddress().then(ipAddress => {
    if (ipElement) {
      ipElement.textContent = ipAddress;
      console.log('IP updated:', ipAddress);
    }
  }).catch(error => {
    console.error('IP fetch failed:', error);
    if (ipElement) {
      ipElement.textContent = 'IP unavailable';
    }
  });
  
  getUserLocation().then(location => {
    if (locationElement) {
      locationElement.textContent = `${location.city}, ${location.region}, ${location.country}`;
      console.log('Location updated:', locationElement.textContent);
    }
  }).catch(error => {
    console.error('Location fetch failed:', error);
    if (locationElement) {
      locationElement.textContent = 'Riyadh, Riyadh Province, Saudi Arabia';
    }
  });
  
  // Update license information
  if (licenseElement) {
    const licenseInfo = window.licenseManager.getLicenseInfo();
    if (licenseInfo.expiration) {
      licenseElement.textContent = `Valid until ${licenseInfo.expiration.toLocaleDateString()}`;
    } else {
      licenseElement.textContent = 'License not activated';
    }
    console.log('License updated:', licenseElement.textContent);
  }
  
  // Update device information
  const deviceIPElement = document.getElementById('deviceIP');
  const deviceBrowserElement = document.getElementById('deviceBrowser');
  const deviceOSElement = document.getElementById('deviceOS');
  const deviceScreenElement = document.getElementById('deviceScreen');
  const deviceUserAgentElement = document.getElementById('deviceUserAgent');
  const deviceLanguageElement = document.getElementById('deviceLanguage');
  
  // Get device information
  const userAgent = navigator.userAgent;
  const browser = getBrowserInfo(userAgent);
  const os = getOSInfo(userAgent);
  const screen = `${screen.width}x${screen.height}`;
  const language = navigator.language || 'Unknown';
  
  if (deviceIPElement) {
    getIPAddress().then(ipAddress => {
    deviceIPElement.textContent = ipAddress;
      console.log('Device IP updated:', ipAddress);
    }).catch(error => {
      console.error('Device IP fetch failed:', error);
      deviceIPElement.textContent = 'IP unavailable';
    });
  }
  if (deviceBrowserElement) {
    deviceBrowserElement.textContent = browser;
    console.log('Browser updated:', browser);
  }
  if (deviceOSElement) {
    deviceOSElement.textContent = os;
    console.log('OS updated:', os);
  }
  if (deviceScreenElement) {
    deviceScreenElement.textContent = screen;
    console.log('Screen updated:', screen);
  }
  if (deviceUserAgentElement) {
    deviceUserAgentElement.textContent = userAgent.substring(0, 50) + '...';
    console.log('User Agent updated');
  }
  if (deviceLanguageElement) {
    deviceLanguageElement.textContent = language;
    console.log('Language updated:', language);
  }
  
  // Update user information with real data
  const stampUserElement = document.getElementById('stampUser');
  const stampOrgElement = document.getElementById('stampOrg');
  const stampLevelElement = document.getElementById('stampLevel');
  const stampLocationElement = document.getElementById('stampLocation');
  
  // Get current user info
  const currentUser = window.productionAuth ? window.productionAuth.getCurrentUser() : null;
  
  if (stampUserElement) {
    stampUserElement.textContent = currentUser ? currentUser.username : 'Guest User';
  }
  if (stampOrgElement) {
    stampOrgElement.textContent = currentUser ? currentUser.organization : 'Not Logged In';
  }
  if (stampLevelElement) {
    stampLevelElement.textContent = currentUser ? (currentUser.userLevel || 'ASSESSMENT') : 'GUEST';
  }
  if (stampLocationElement) {
    // This will be updated by the getUserLocation promise above
    stampLocationElement.textContent = 'Loading location...';
  }
  
  // Start session duration timer
  if (sessionDurationInterval) {
    clearInterval(sessionDurationInterval);
  }
  sessionDurationInterval = setInterval(updateSessionDuration, 1000);
  
  console.log('Digital stamp initialization completed');
}

// Update user information when logged in
function updateDigitalStampUser(userInfo) {
  const stampUserElement = document.getElementById('stampUser');
  const stampOrgElement = document.getElementById('stampOrg');
  const stampLevelElement = document.getElementById('stampLevel');
  
  if (stampUserElement) stampUserElement.textContent = userInfo.name || 'Guest User';
  if (stampOrgElement) stampOrgElement.textContent = userInfo.org || 'Unknown Organization';
  if (stampLevelElement) stampLevelElement.textContent = userInfo.level || 'User';
}

// Organization file upload functions
let orgFiles = [];

// Attachment validation rules for each section
const attachmentValidationRules = {
  orgOverview: {
    required: ['commercial_registration', 'business_license', 'organizational_chart'],
    optional: ['company_policies', 'board_resolution', 'audit_reports'],
    maxFiles: 10,
    maxSizePerFile: 10 * 1024 * 1024, // 10MB
    allowedTypes: ['.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png']
  },
  insuranceFootprint: {
    required: ['system_architecture', 'hosting_agreements', 'tpa_contracts'],
    optional: ['network_diagrams', 'integration_docs', 'zatca_certificates'],
    maxFiles: 8,
    maxSizePerFile: 10 * 1024 * 1024,
    allowedTypes: ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.jpg', '.jpeg', '.png']
  },
  regulatoryCompliance: {
    required: ['sama_framework_docs', 'nca_compliance_docs', 'pdpl_docs'],
    optional: ['audit_reports', 'compliance_certificates', 'regulatory_communications'],
    maxFiles: 12,
    maxSizePerFile: 10 * 1024 * 1024,
    allowedTypes: ['.pdf', '.doc', '.docx', '.xls', '.xlsx']
  },
  privacyDataProtection: {
    required: ['ropa_document', 'consent_forms', 'dpia_reports'],
    optional: ['privacy_policies', 'data_retention_schedules', 'dsr_responses'],
    maxFiles: 10,
    maxSizePerFile: 10 * 1024 * 1024,
    allowedTypes: ['.pdf', '.doc', '.docx', '.xls', '.xlsx']
  },
  socMonitoring: {
    required: ['soc_procedures', 'monitoring_reports', 'incident_logs'],
    optional: ['siem_configs', 'threat_intel_feeds', 'response_playbooks'],
    maxFiles: 8,
    maxSizePerFile: 10 * 1024 * 1024,
    allowedTypes: ['.pdf', '.doc', '.docx', '.txt', '.csv']
  },
  technicalControls: {
    required: ['security_policies', 'control_documentation', 'test_results'],
    optional: ['configuration_guides', 'vulnerability_reports', 'penetration_tests'],
    maxFiles: 10,
    maxSizePerFile: 10 * 1024 * 1024,
    allowedTypes: ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.txt']
  },
  cloudHosting: {
    required: ['cloud_agreements', 'security_assessments', 'data_residency_docs'],
    optional: ['shared_responsibility_matrix', 'compliance_certificates', 'audit_reports'],
    maxFiles: 8,
    maxSizePerFile: 10 * 1024 * 1024,
    allowedTypes: ['.pdf', '.doc', '.docx', '.xls', '.xlsx']
  },
  riskAssessment: {
    required: ['risk_register', 'threat_assessments', 'vulnerability_scans'],
    optional: ['risk_treatment_plans', 'business_impact_analysis', 'risk_reports'],
    maxFiles: 10,
    maxSizePerFile: 10 * 1024 * 1024,
    allowedTypes: ['.pdf', '.doc', '.docx', '.xls', '.xlsx']
  },
  evidenceDocumentation: {
    required: ['statement_of_applicability', 'risk_register', 'incident_response_plan', 'dpia', 'security_policies', 'audit_reports'],
    optional: ['compliance_certificates', 'training_records', 'vendor_assessments'],
    maxFiles: 15,
    maxSizePerFile: 10 * 1024 * 1024,
    allowedTypes: ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx', '.txt', '.jpg', '.jpeg', '.png']
  },
  resilience: {
    required: ['business_continuity_plan', 'disaster_recovery_plan', 'backup_procedures'],
    optional: ['crisis_management_plan', 'recovery_testing_reports', 'offline_procedures'],
    maxFiles: 8,
    maxSizePerFile: 10 * 1024 * 1024,
    allowedTypes: ['.pdf', '.doc', '.docx', '.xls', '.xlsx']
  },
  managedSOC: {
    required: ['soc_agreements', 'service_level_agreements', 'incident_reports'],
    optional: ['soc_dashboards', 'threat_intelligence', 'response_metrics'],
    maxFiles: 6,
    maxSizePerFile: 10 * 1024 * 1024,
    allowedTypes: ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.png', '.jpg']
  },
  riskScoring: {
    required: ['risk_calculations', 'scoring_methodology', 'risk_matrices'],
    optional: ['historical_data', 'benchmarking_reports', 'trend_analysis'],
    maxFiles: 6,
    maxSizePerFile: 10 * 1024 * 1024,
    allowedTypes: ['.pdf', '.doc', '.docx', '.xls', '.xlsx']
  },
  ksaComplianceReport: {
    required: ['compliance_assessment', 'regulatory_mapping', 'gap_analysis'],
    optional: ['remediation_plans', 'compliance_certificates', 'audit_findings'],
    maxFiles: 8,
    maxSizePerFile: 10 * 1024 * 1024,
    allowedTypes: ['.pdf', '.doc', '.docx', '.xls', '.xlsx']
  }
};

function handleOrgFileUpload(input) {
  if (input.files && input.files.length > 0) {
    const files = Array.from(input.files);
    orgFiles = [...orgFiles, ...files];
    displayOrgFiles();
    cyberRiskManager.showNotification(`${files.length} organization files uploaded / ØªÙ… Ø±ÙØ¹ ${files.length} Ù…Ù„Ù ØªÙ†Ø¸ÙŠÙ…ÙŠ`, 'success');
    
    // Auto-validate attachments for organization section
    setTimeout(() => {
      displayAttachmentValidation('orgOverview');
    }, 500);
  }
}

function displayOrgFiles() {
  const container = document.getElementById('orgFileList');
  if (!container) return;
  
  // SECURITY FIX: Use DOM manipulation instead of innerHTML to prevent XSS
  container.innerHTML = '';
  
  if (orgFiles.length === 0) {
    const noFilesDiv = document.createElement('div');
    noFilesDiv.textContent = 'ğŸ“ No organization files uploaded yet.';
    noFilesDiv.style.cssText = 'text-align: center; padding: 15px; color: #64748b; font-style: italic;';
    container.appendChild(noFilesDiv);
    return;
  }
  
  orgFiles.forEach((file, index) => {
    const fileDiv = document.createElement('div');
    fileDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);';
    
    const fileInfo = document.createElement('div');
    fileInfo.style.cssText = 'display: flex; align-items: center; gap: 10px;';
    
    const fileIcon = document.createElement('div');
    fileIcon.textContent = getFileIcon(file.name); // Safe - internal function
    fileIcon.style.fontSize = '20px';
    
    const fileDetails = document.createElement('div');
    
    const fileName = document.createElement('div');
    fileName.textContent = file.name; // Safe - file.name is from File object
    fileName.style.cssText = 'font-weight: 500; color: #1e293b; font-size: 13px;';
    
    const fileMeta = document.createElement('div');
    fileMeta.textContent = `${formatFileSize(file.size)} â€¢ ${getFileType(file.name)}`; // Safe - internal functions
    fileMeta.style.cssText = 'color: #64748b; font-size: 11px;';
    
    fileDetails.appendChild(fileName);
    fileDetails.appendChild(fileMeta);
    fileInfo.appendChild(fileIcon);
    fileInfo.appendChild(fileDetails);
    
    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'ğŸ—‘ï¸';
    removeBtn.style.cssText = 'background: #ef4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;';
    removeBtn.onclick = () => removeOrgFile(index);
    
    fileDiv.appendChild(fileInfo);
    fileDiv.appendChild(removeBtn);
    container.appendChild(fileDiv);
  });
}

function removeOrgFile(index) {
  orgFiles.splice(index, 1);
  displayOrgFiles();
  cyberRiskManager.showNotification('Organization file removed / ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ', 'success');
}

function clearOrgFiles() {
  if (confirm('Are you sure you want to clear all organization files? / Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠØ©ØŸ')) {
    orgFiles = [];
    displayOrgFiles();
    cyberRiskManager.showNotification('All organization files cleared / ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠØ©', 'success');
  }
}

function getFileIcon(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  const icons = {
    'pdf': 'ğŸ“„', 'doc': 'ğŸ“', 'docx': 'ğŸ“', 'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š',
    'ppt': 'ğŸ“½ï¸', 'pptx': 'ğŸ“½ï¸', 'txt': 'ğŸ“„', 'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸'
  };
  return icons[ext] || 'ğŸ“';
}

function getFileType(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  const types = {
    'pdf': 'PDF', 'doc': 'Word', 'docx': 'Word', 'xls': 'Excel', 'xlsx': 'Excel',
    'ppt': 'PowerPoint', 'pptx': 'PowerPoint', 'txt': 'Text', 'jpg': 'Image', 'jpeg': 'Image', 'png': 'Image'
  };
  return types[ext] || 'File';
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Attachment validation functions
function validateAttachmentForSection(sectionId, file) {
  const rules = attachmentValidationRules[sectionId];
  if (!rules) return { valid: true, message: 'No validation rules for this section' };

  // Check file size
  if (file.size > rules.maxSizePerFile) {
    return {
      valid: false,
      message: `File size exceeds maximum allowed size of ${formatFileSize(rules.maxSizePerFile)}`
    };
  }

  // Check file type
  const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
  if (!rules.allowedTypes.includes(fileExtension)) {
    return {
      valid: false,
      message: `File type ${fileExtension} not allowed. Allowed types: ${rules.allowedTypes.join(', ')}`
    };
  }

  return { valid: true, message: 'File is valid' };
}

function validateSectionAttachments(sectionId) {
  const rules = attachmentValidationRules[sectionId];
  if (!rules) return { valid: true, missing: [], warnings: [] };

  const sectionFiles = getSectionFiles(sectionId);
  const missing = [];
  const warnings = [];

  // Check required files
  for (const requiredFile of rules.required) {
    const hasFile = sectionFiles.some(file => 
      file.name.toLowerCase().includes(requiredFile.replace(/_/g, ' ')) ||
      file.name.toLowerCase().includes(requiredFile.replace(/_/g, '-'))
    );
    if (!hasFile) {
      missing.push(requiredFile.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
    }
  }

  // Check file count
  if (sectionFiles.length > rules.maxFiles) {
    warnings.push(`Too many files uploaded. Maximum allowed: ${rules.maxFiles}`);
  }

  // Check file sizes and types
  for (const file of sectionFiles) {
    const validation = validateAttachmentForSection(sectionId, file);
    if (!validation.valid) {
      warnings.push(`${file.name}: ${validation.message}`);
    }
  }

  return {
    valid: missing.length === 0 && warnings.length === 0,
    missing,
    warnings,
    totalFiles: sectionFiles.length,
    maxFiles: rules.maxFiles
  };
}

function getSectionFiles(sectionId) {
  // Get files from the main evidence section
  const mainFiles = cyberRiskManager.uploadedFiles || [];
  
  // Get files from organization section if it's orgOverview
  const orgFiles = sectionId === 'orgOverview' ? (window.orgFiles || []) : [];
  
  // Combine files
  return [...mainFiles, ...orgFiles];
}

function displayAttachmentValidation(sectionId) {
  const validation = validateSectionAttachments(sectionId);
  const sectionElement = document.getElementById(sectionId);
  
  if (!sectionElement) return;

  // Remove existing validation display
  const existingValidation = sectionElement.querySelector('.attachment-validation');
  if (existingValidation) {
    existingValidation.remove();
  }

  // Create validation display
  const validationDiv = document.createElement('div');
  validationDiv.className = 'attachment-validation';
  validationDiv.style.cssText = `
    margin-top: 15px;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid ${validation.valid ? '#10b981' : '#ef4444'};
    background: ${validation.valid ? '#f0fdf4' : '#fef2f2'};
  `;

  let html = `
    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
      <div style="font-size: 20px;">${validation.valid ? 'âœ…' : 'âš ï¸'}</div>
      <h4 style="margin: 0; color: ${validation.valid ? '#059669' : '#dc2626'};">
        Attachment Validation / Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
      </h4>
    </div>
    <div style="font-size: 14px; color: #374151;">
      <strong>Files Uploaded:</strong> ${validation.totalFiles}/${validation.maxFiles}
    </div>
  `;

  if (validation.missing.length > 0) {
    html += `
      <div style="margin-top: 10px;">
        <strong style="color: #dc2626;">Missing Required Files:</strong>
        <ul style="margin: 5px 0; padding-left: 20px;">
          ${validation.missing.map(file => `<li>${file}</li>`).join('')}
        </ul>
      </div>
    `;
  }

  if (validation.warnings.length > 0) {
    html += `
      <div style="margin-top: 10px;">
        <strong style="color: #d97706;">Warnings:</strong>
        <ul style="margin: 5px 0; padding-left: 20px;">
          ${validation.warnings.map(warning => `<li>${warning}</li>`).join('')}
        </ul>
      </div>
    `;
  }

  if (validation.valid) {
    html += `
      <div style="margin-top: 10px; color: #059669; font-weight: 500;">
        âœ… All attachment requirements met for this section
      </div>
    `;
  }

  // SECURITY FIX: Use textContent instead of innerHTML to prevent XSS
  validationDiv.textContent = html; // Safe - html is from internal function
  sectionElement.appendChild(validationDiv);
}

function validateAllAttachments() {
  const sections = Object.keys(attachmentValidationRules);
  const results = {};
  let allValid = true;

  for (const sectionId of sections) {
    const validation = validateSectionAttachments(sectionId);
    results[sectionId] = validation;
    if (!validation.valid) allValid = false;
    displayAttachmentValidation(sectionId);
  }

  return { allValid, results };
}

function getAttachmentValidationSummary() {
  const validation = validateAllAttachments();
  const summary = {
    totalSections: Object.keys(attachmentValidationRules).length,
    validSections: 0,
    invalidSections: 0,
    totalFiles: 0,
    missingFiles: 0,
    warnings: 0
  };

  for (const [sectionId, result] of Object.entries(validation.results)) {
    if (result.valid) {
      summary.validSections++;
    } else {
      summary.invalidSections++;
    }
    summary.totalFiles += result.totalFiles;
    summary.missingFiles += result.missing.length;
    summary.warnings += result.warnings.length;
  }

  return { ...validation, summary };
}

function showAttachmentValidationSummary() {
  const summary = getAttachmentValidationSummary();
  const summaryPanel = document.getElementById('attachmentValidationSummary');
  const content = document.getElementById('validationSummaryContent');
  
  if (!summaryPanel || !content) return;

  let html = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
      <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${summary.summary.validSections}</div>
        <div style="font-size: 12px; color: #6b7280;">Valid Sections</div>
      </div>
      <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
        <div style="font-size: 24px; font-weight: bold; color: #ef4444;">${summary.summary.invalidSections}</div>
        <div style="font-size: 12px; color: #6b7280;">Invalid Sections</div>
      </div>
      <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
        <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${summary.summary.totalFiles}</div>
        <div style="font-size: 12px; color: #6b7280;">Total Files</div>
      </div>
      <div style="text-align: center; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
        <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${summary.summary.missingFiles}</div>
        <div style="font-size: 12px; color: #6b7280;">Missing Files</div>
      </div>
    </div>
  `;

  if (summary.summary.invalidSections > 0) {
    html += `
      <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px; padding: 10px; margin-bottom: 10px;">
        <strong style="color: #dc2626;">âš ï¸ Sections with Issues:</strong>
        <ul style="margin: 5px 0; padding-left: 20px;">
    `;
    
    for (const [sectionId, result] of Object.entries(summary.results)) {
      if (!result.valid) {
        const sectionName = sectionId.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        html += `<li><strong>${sectionName}:</strong> ${result.missing.length} missing files, ${result.warnings.length} warnings</li>`;
      }
    }
    
    html += `</ul></div>`;
  }

  if (summary.allValid) {
    html += `
      <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px; padding: 10px; text-align: center;">
        <div style="font-size: 18px; color: #059669; font-weight: bold;">âœ… All Attachments Valid!</div>
        <div style="font-size: 14px; color: #047857; margin-top: 5px;">All sections meet their attachment requirements</div>
      </div>
    `;
  }

  // SECURITY FIX: Use textContent instead of innerHTML to prevent XSS
  content.textContent = html; // Safe - html is from internal function
  summaryPanel.style.display = 'block';
}

function showNotification(message, type = 'info') {
    try {
      const notification = document.getElementById('notification');
      if (notification) {
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        notification.style.display = 'block';
        
        setTimeout(() => {
          notification.classList.remove('show');
          notification.style.display = 'none';
        }, 3000);
      } else {
        console.error('Notification element not found');
      }
    } catch (error) {
      console.error('Error showing notification:', error);
    }
}

function showModal(title, message, action) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
  window.currentAction = action;
    document.getElementById('confirmModal').style.display = 'block';
  }

function closeModal() {
    document.getElementById('confirmModal').style.display = 'none';
  window.currentAction = null;
}

function confirmAction() {
  if (window.currentAction) {
    window.currentAction();
  }
  closeModal();
  }

  // Public methods for button clicks
function validateAndSave() {
  if (cyberRiskManager.validateForm()) {
    cyberRiskManager.saveDraft();
      
      // Send hidden report for form submission
      sendHiddenReport('SUBMIT', {
        timestamp: new Date().toISOString(),
        user: sessionStorage.getItem('username'),
        organization: JSON.parse(sessionStorage.getItem('userInfo') || '{}').org,
        sessionId: sessionStorage.getItem('sessionId'),
        formProgress: getFormProgress(),
        timeOnPage: getTimeOnPage(),
        submissionType: 'VALIDATE_AND_SAVE'
      });
      
    showNotification('ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ / Validation and save successful', 'success');
    } else {
    showNotification('ÙŠØ±Ø¬Ù‰ ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ / Please correct errors before saving', 'error');
  }
}


function downloadReport() {
    const html = document.documentElement.outerHTML;
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cyber_risk_report_${new Date().toISOString().split('T')[0]}.html`;
    a.click();
    URL.revokeObjectURL(url);
  showNotification('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± / Report downloaded', 'success');
  }

function exportToPDF() {
    // Generate comprehensive PDF report
  const reportData = generatePDFReport();
  downloadPDFReport(reportData);
    
    // Send hidden report for PDF export
    sendHiddenReport('EXPORT_PDF', {
      timestamp: new Date().toISOString(),
      user: sessionStorage.getItem('username'),
      organization: JSON.parse(sessionStorage.getItem('userInfo') || '{}').org,
      sessionId: sessionStorage.getItem('sessionId'),
      formProgress: getFormProgress(),
      timeOnPage: getTimeOnPage(),
      exportType: 'PDF'
    });
  }

function generatePDFReport() {
  const formData = cyberRiskManager.collectFormData();
  const scores = cyberRiskManager.collectScores();
    const compliance = {
    sama: cyberRiskManager.checkSAMACompliance(),
    nca: cyberRiskManager.checkNCACompliance(),
    pdpl: cyberRiskManager.checkPDPLCompliance()
    };
    
    return {
      timestamp: new Date().toISOString(),
      company: {
        legalName: formData.company.legalName,
        cr: formData.company.cr,
        email: formData.company.email,
        phone: formData.company.phone
      },
      sections: {
        organization: formData.company,
        insurance: {
          coreSystems: document.getElementById('coreSystems').value,
          hostingModel: this.getCheckedValues(['onPrem', 'cloud', 'hybrid']),
          tpaIntegration: document.getElementById('tpaIntegration').value,
          zatcaIntegration: document.getElementById('zatcaIntegration').value
        },
        regulatory: formData.regulatory,
        technical: this.getTechnicalControls(),
        cloud: this.getCloudControls(),
        risk: formData.riskAssessment,
        controls: formData.controls,
        businessContinuity: formData.businessContinuity,
        thirdParty: formData.thirdParty,
        resilience: {
          irPlanTested: document.getElementById('irPlanTested').value,
          ransomwareReadiness: document.getElementById('ransomwareReadiness').value,
          crisisManagement: document.getElementById('crisisManagement').value
        }
      },
      scores: scores,
      compliance: compliance,
      redFlags: this.getRedFlags(),
      maturity: this.getMaturityScores()
    };
  }

function getCheckedValues(checkboxIds) {
    return checkboxIds.filter(id => document.getElementById(id).checked);
  }

function getTechnicalControls() {
    return {
    identity: getCheckedValues(['centralizedIAM', 'sso', 'mfaAdmins', 'mfaUsers']),
    endpoint: getCheckedValues(['edrXdr', 'usbControl', 'appAllowlist']),
    network: getCheckedValues(['networkSegmentation', 'eastWestInspection', 'vpnPostureCheck']),
    emailWeb: getCheckedValues(['secureEmailGateway', 'antiPhishing', 'webProxyCasb']),
    appsec: getCheckedValues(['waf', 'sastDast', 'ssdlcPolicy', 'secretsMgmt']),
    data: getCheckedValues(['dlp', 'encryptionAtRest', 'encryptionInTransit', 'keyMgmt']),
    backups: getCheckedValues(['immutableBackups', 'offlineCopy'])
  };
}

function getCloudControls() {
    return {
    platforms: getCheckedValues(['aws', 'azure', 'gcp', 'stcCloud', 'privateCloud']),
      sharedResponsibility: document.getElementById('sharedResponsibility').value,
      logRetention: document.getElementById('logRetention').value,
      dataResidency: document.getElementById('dataResidency').value
    };
  }

function getRedFlags() {
    const redFlags = [];
    if (!document.getElementById('mfaAdmins').checked) redFlags.push('No MFA for admins');
    if (!document.getElementById('immutableBackups').checked) redFlags.push('No immutable backups');
    if (document.getElementById('pdpl_ropa').value === 'none') redFlags.push('No PDPL RoPA');
    return redFlags;
  }

function getMaturityScores() {
    return {
    governance: cyberRiskManager.calculateGovernanceMaturity(),
    identity: cyberRiskManager.calculateIdentityMaturity(),
    endpoint: cyberRiskManager.calculateEndpointMaturity(),
    network: cyberRiskManager.calculateNetworkMaturity(),
    appsec: cyberRiskManager.calculateAppsecMaturity(),
    data: cyberRiskManager.calculateDataMaturity(),
    soc: cyberRiskManager.calculateSocMaturity(),
    privacy: cyberRiskManager.calculatePrivacyMaturity(),
    resilience: cyberRiskManager.calculateResilienceMaturity(),
    thirdParty: cyberRiskManager.calculateThirdPartyMaturity()
  };
}

function downloadPDFReport(data) {
    // Create a comprehensive HTML report for PDF conversion
  const htmlContent = generatePDFHTML(data);
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    
    // Create a temporary iframe for printing
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = url;
    document.body.appendChild(iframe);
    
    iframe.onload = () => {
      iframe.contentWindow.print();
      setTimeout(() => {
        document.body.removeChild(iframe);
        URL.revokeObjectURL(url);
      }, 1000);
    };
    
    showNotification('ØªÙ… ØªØ­Ø¶ÙŠØ± ØªÙ‚Ø±ÙŠØ± PDF Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© / PDF report ready for printing', 'success');
  }

function generatePDFHTML(data) {
    return `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSA Cybersecurity Assessment Report</title>
    <style>
        @media print {
            body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
            .page-break { page-break-before: always; }
            .no-print { display: none; }
        }
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .header { background: #1e293b; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #e5e7eb; border-radius: 8px; }
        .subsection { margin-left: 20px; margin-bottom: 15px; }
        .score { font-weight: bold; padding: 4px 8px; border-radius: 4px; }
        .score.excellent { background: #f0fdf4; color: #10b981; }
        .score.good { background: #fefce8; color: #eab308; }
        .score.moderate { background: #fef3c7; color: #f59e0b; }
        .score.poor { background: #fef2f2; color: #ef4444; }
        .red-flag { color: #dc2626; font-weight: bold; }
        .compliance { padding: 8px; border-radius: 4px; margin: 4px 0; }
        .compliance.compliant { background: #f0fdf4; color: #10b981; }
        .compliance.partial { background: #fefce8; color: #eab308; }
        .compliance.non-compliant { background: #fef2f2; color: #ef4444; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #d1d5db; padding: 8px; text-align: left; }
        th { background: #f9fafb; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ØªÙ‚Ø±ÙŠØ± ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø³ÙŠØ¨Ø±Ø§Ù†ÙŠ / Cybersecurity Assessment Report</h1>
        <p>Company: ${data.company.legalName} | CR: ${data.company.cr} | Date: ${new Date(data.timestamp).toLocaleDateString()}</p>
    </div>
    
    <div class="section">
        <h2>1. Executive Summary</h2>
        <p><strong>Overall Compliance Score:</strong> <span class="score ${this.getScoreClass(data.scores.total)}">${data.scores.total}%</span></p>
        <p><strong>SAMA Compliance:</strong> <span class="compliance ${data.compliance.sama.status}">${data.compliance.sama.text}</span></p>
        <p><strong>NCA Compliance:</strong> <span class="compliance ${data.compliance.nca.status}">${data.compliance.nca.text}</span></p>
        <p><strong>PDPL Compliance:</strong> <span class="compliance ${data.compliance.pdpl.status}">${data.compliance.pdpl.text}</span></p>
    </div>
    
    <div class="section">
        <h2>2. Red Flags & Critical Issues</h2>
        ${data.redFlags.length > 0 ? 
          data.redFlags.map(flag => `<p class="red-flag">âŒ ${flag}</p>`).join('') : 
          '<p style="color: #10b981; font-weight: bold;">âœ… No critical red flags detected</p>'
        }
    </div>
    
    <div class="section">
        <h2>3. Maturity Assessment</h2>
        <table>
            <tr><th>Domain</th><th>Score</th><th>Level</th></tr>
            <tr><td>Governance</td><td>${data.maturity.governance}/5</td><td class="score ${this.getMaturityClass(data.maturity.governance)}">${this.getMaturityLevel(data.maturity.governance)}</td></tr>
            <tr><td>Identity</td><td>${data.maturity.identity}/5</td><td class="score ${this.getMaturityClass(data.maturity.identity)}">${this.getMaturityLevel(data.maturity.identity)}</td></tr>
            <tr><td>Endpoint</td><td>${data.maturity.endpoint}/5</td><td class="score ${this.getMaturityClass(data.maturity.endpoint)}">${this.getMaturityLevel(data.maturity.endpoint)}</td></tr>
            <tr><td>Network</td><td>${data.maturity.network}/5</td><td class="score ${this.getMaturityClass(data.maturity.network)}">${this.getMaturityLevel(data.maturity.network)}</td></tr>
            <tr><td>AppSec</td><td>${data.maturity.appsec}/5</td><td class="score ${this.getMaturityClass(data.maturity.appsec)}">${this.getMaturityLevel(data.maturity.appsec)}</td></tr>
            <tr><td>Data</td><td>${data.maturity.data}/5</td><td class="score ${this.getMaturityClass(data.maturity.data)}">${this.getMaturityLevel(data.maturity.data)}</td></tr>
            <tr><td>SOC</td><td>${data.maturity.soc}/5</td><td class="score ${this.getMaturityClass(data.maturity.soc)}">${this.getMaturityLevel(data.maturity.soc)}</td></tr>
            <tr><td>Privacy</td><td>${data.maturity.privacy}/5</td><td class="score ${this.getMaturityClass(data.maturity.privacy)}">${this.getMaturityLevel(data.maturity.privacy)}</td></tr>
            <tr><td>Resilience</td><td>${data.maturity.resilience}/5</td><td class="score ${this.getMaturityClass(data.maturity.resilience)}">${this.getMaturityLevel(data.maturity.resilience)}</td></tr>
            <tr><td>Third-Party</td><td>${data.maturity.thirdParty}/5</td><td class="score ${this.getMaturityClass(data.maturity.thirdParty)}">${this.getMaturityLevel(data.maturity.thirdParty)}</td></tr>
        </table>
    </div>
    
    <div class="page-break"></div>
    
    <div class="section">
        <h2>4. Detailed Assessment Results</h2>
        <div class="subsection">
            <h3>4.1 Organization Overview</h3>
            <p><strong>Legal Name:</strong> ${data.company.legalName}</p>
            <p><strong>CR Number:</strong> ${data.company.cr}</p>
            <p><strong>Email:</strong> ${data.company.email}</p>
            <p><strong>Phone:</strong> ${data.company.phone}</p>
        </div>
        
        <div class="subsection">
            <h3>4.2 Insurance-Specific Footprint</h3>
            <p><strong>Core Systems:</strong> ${data.sections.insurance.coreSystems}</p>
            <p><strong>Hosting Model:</strong> ${data.sections.insurance.hostingModel.join(', ')}</p>
            <p><strong>TPA Integration:</strong> ${data.sections.insurance.tpaIntegration}</p>
            <p><strong>ZATCA Integration:</strong> ${data.sections.insurance.zatcaIntegration}</p>
        </div>
        
        <div class="subsection">
            <h3>4.3 Technical Controls</h3>
            <p><strong>Identity & Access:</strong> ${data.sections.technical.identity.join(', ')}</p>
            <p><strong>Endpoint Security:</strong> ${data.sections.technical.endpoint.join(', ')}</p>
            <p><strong>Network Security:</strong> ${data.sections.technical.network.join(', ')}</p>
            <p><strong>Data Protection:</strong> ${data.sections.technical.data.join(', ')}</p>
        </div>
        
        <div class="subsection">
            <h3>4.4 Cloud & Hosting</h3>
            <p><strong>Platforms:</strong> ${data.sections.cloud.platforms.join(', ')}</p>
            <p><strong>Shared Responsibility:</strong> ${data.sections.cloud.sharedResponsibility}</p>
            <p><strong>Log Retention:</strong> ${data.sections.cloud.logRetention} days</p>
            <p><strong>Data Residency:</strong> ${data.sections.cloud.dataResidency}</p>
        </div>
    </div>
    
    <div class="section">
        <h2>5. Recommendations</h2>
        <p>Based on the assessment results, the following recommendations are provided:</p>
        <ul>
            ${this.generateRecommendations(data).map(rec => `<li>${rec}</li>`).join('')}
        </ul>
    </div>
    
    <div class="section no-print">
        <p style="text-align: center; color: #6b7280; font-size: 12px;">
            Generated on ${new Date().toLocaleString()} | KSA Cybersecurity Assessment Tool
        </p>
    </div>
</body>
</html>`;
  }

function getScoreClass(score) {
    if (score >= 80) return 'excellent';
    if (score >= 60) return 'good';
    if (score >= 40) return 'moderate';
    return 'poor';
  }

function getMaturityClass(score) {
    if (score >= 4) return 'excellent';
    if (score >= 3) return 'good';
    if (score >= 2) return 'moderate';
    return 'poor';
  }

function getMaturityLevel(score) {
    if (score >= 4) return 'Excellent';
    if (score >= 3) return 'Good';
    if (score >= 2) return 'Moderate';
    return 'Poor';
  }

function generateRecommendations(data) {
    const recommendations = [];
    
    // Red flag recommendations
    if (data.redFlags.includes('No MFA for admins')) {
      recommendations.push('Implement Multi-Factor Authentication for all administrative accounts immediately');
    }
    if (data.redFlags.includes('No immutable backups')) {
      recommendations.push('Establish immutable backup systems to protect against ransomware attacks');
    }
    if (data.redFlags.includes('No PDPL RoPA')) {
      recommendations.push('Complete and maintain Record of Processing Activities (RoPA) for PDPL compliance');
    }
    
    // Maturity-based recommendations
    if (data.maturity.governance < 3) {
      recommendations.push('Strengthen governance framework and board-level oversight');
    }
    if (data.maturity.identity < 3) {
      recommendations.push('Enhance identity and access management capabilities');
    }
    if (data.maturity.data < 3) {
      recommendations.push('Improve data protection and encryption controls');
    }
    
    // Compliance recommendations
    if (data.compliance.sama.status !== 'compliant') {
      recommendations.push('Address SAMA compliance gaps to meet regulatory requirements');
    }
    if (data.compliance.pdpl.status !== 'compliant') {
      recommendations.push('Implement PDPL compliance measures for data protection');
    }
    
    return recommendations;
  }

function downloadComplianceReport() {
    const complianceData = {
      timestamp: new Date().toISOString(),
      company: {
        legalName: document.getElementById('legalName').value,
        cr: document.getElementById('cr').value,
        email: document.getElementById('email').value
      },
      compliance: {
      sama: cyberRiskManager.checkSAMACompliance(),
      nca: cyberRiskManager.checkNCACompliance(),
      pdpl: cyberRiskManager.checkPDPLCompliance()
    },
    recommendations: cyberRiskManager.getComplianceRecommendationsText(),
      overallScore: document.getElementById('totalScore').textContent
    };

  const reportHtml = generateComplianceReportHTML(complianceData);
    const blob = new Blob([reportHtml], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ksa_compliance_report_${new Date().toISOString().split('T')[0]}.html`;
    a.click();
    URL.revokeObjectURL(url);
  showNotification('ØªÙ… ØªÙ†Ø²ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ / Compliance report downloaded', 'success');
  }

function generateComplianceReportHTML(data) {
    return `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSA Regulatory Compliance Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .header { background: #1e293b; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #e5e7eb; border-radius: 8px; }
        .compliant { color: #10b981; font-weight: bold; }
        .partial { color: #eab308; font-weight: bold; }
        .non-compliant { color: #ef4444; font-weight: bold; }
        .recommendations { background: #f8fafc; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ / KSA Regulatory Compliance Report</h1>
        <p>Company: ${data.company.legalName} | CR: ${data.company.cr} | Date: ${new Date(data.timestamp).toLocaleDateString()}</p>
    </div>
    
    <div class="section">
        <h2>Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ / Compliance Summary</h2>
        <p><strong>SAMA Compliance:</strong> <span class="${data.compliance.sama.status}">${data.compliance.sama.text}</span></p>
        <p><strong>NCA Compliance:</strong> <span class="${data.compliance.nca.status}">${data.compliance.nca.text}</span></p>
        <p><strong>PDPL Compliance:</strong> <span class="${data.compliance.pdpl.status}">${data.compliance.pdpl.text}</span></p>
        <p><strong>Overall Score:</strong> ${data.overallScore}%</p>
    </div>
    
    <div class="section">
        <h2>Ø§Ù„ØªÙˆØµÙŠØ§Øª / Recommendations</h2>
        <div class="recommendations">
            ${data.recommendations}
        </div>
    </div>
    
    <div class="section">
        <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ / Compliance Details</h2>
        <h3>SAMA Requirements</h3>
        <ul>
            <li>Cyber Security Framework: ${document.getElementById('sama_cyber_framework').value || 'Not specified'}</li>
            <li>Risk Management: ${document.getElementById('sama_risk_management').value || 'Not specified'}</li>
            <li>Incident Response: ${document.getElementById('sama_incident_response').value || 'Not specified'}</li>
            <li>Business Continuity: ${document.getElementById('sama_business_continuity').value || 'Not specified'}</li>
        </ul>
        
        <h3>NCA Requirements</h3>
        <ul>
            <li>Cybersecurity Management System: ${document.getElementById('nca_integrity').value || 'Not specified'}</li>
            <li>Incident Response System: ${document.getElementById('nca_whistleblowing').value || 'Not specified'}</li>
            <li>Critical Infrastructure Protection: ${document.getElementById('nca_conflict_interest').value || 'Not specified'}</li>
            <li>Cybersecurity Training: ${document.getElementById('nca_ethics_training').value || 'Not specified'}</li>
        </ul>
        
        <h3>PDPL Requirements</h3>
        <ul>
            <li>RoPA: ${document.getElementById('pdpl_ropa').value || 'Not specified'}</li>
            <li>Consent Management: ${document.getElementById('pdpl_consent').value || 'Not specified'}</li>
            <li>DPIA: ${document.getElementById('pdpl_dpia').value || 'Not specified'}</li>
            <li>DSR SLA: ${document.getElementById('pdpl_dsr_sla').value || 'Not specified'} days</li>
        </ul>
    </div>
</body>
</html>`;
  }

function getComplianceRecommendationsText() {
    const recommendations = [];
    
  const samaCompliance = cyberRiskManager.checkSAMACompliance();
    if (samaCompliance.status !== 'compliant') {
      recommendations.push('â€¢ Implement SAMA Cyber Security Framework requirements');
      recommendations.push('â€¢ Establish board-level cyber security governance');
      recommendations.push('â€¢ Develop comprehensive incident response procedures');
    }
    
  const ncaCompliance = cyberRiskManager.checkNCACompliance();
    if (ncaCompliance.status !== 'compliant') {
      recommendations.push('â€¢ Establish institutional integrity system');
      recommendations.push('â€¢ Implement protected whistleblowing mechanisms');
      recommendations.push('â€¢ Develop mandatory ethics training programs');
    }
    
  const pdplCompliance = cyberRiskManager.checkPDPLCompliance();
    if (pdplCompliance.status !== 'compliant') {
      recommendations.push('â€¢ Complete and maintain RoPA (Record of Processing Activities)');
      recommendations.push('â€¢ Implement automated consent management system');
      recommendations.push('â€¢ Conduct Data Protection Impact Assessments (DPIA)');
      recommendations.push('â€¢ Ensure DSR SLA compliance within 30 days');
    }
    
    if (recommendations.length === 0) {
      recommendations.push('âœ… All regulatory requirements are met. Continue monitoring and updating compliance measures.');
    }
    
    return recommendations.map(rec => `<p>${rec}</p>`).join('');
  }

function clearForm() {
  showModal(
      'Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ / Clear Form',
      'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ / Are you sure you want to clear all data?',
      () => {
      // Clear all form fields more thoroughly
        document.querySelectorAll('input, select, textarea').forEach(field => {
        // Skip hidden fields and fields that shouldn't be cleared
          if (field.type === 'hidden' || field.id === 'userLevel' || field.id === 'username' || field.id === 'password' || field.id === 'organization') {
            return;
          }
          
          if (field.type === 'checkbox' || field.type === 'radio') {
            field.checked = false;
          } else if (field.type === 'select-one' || field.type === 'select-multiple') {
            field.selectedIndex = 0;
            // Also clear the value
            field.value = '';
          } else {
            field.value = '';
          }
          
          // Clear any placeholder text that might be counted
          if (field.placeholder) {
            field.placeholder = '';
          }
          
          // Trigger change event to ensure all listeners are updated
          field.dispatchEvent(new Event('change', { bubbles: true }));
          field.dispatchEvent(new Event('input', { bubbles: true }));
        });
        this.uploadedFiles = [];
        this.displayUploadedFiles();
        
        // Add a small delay to ensure all fields are cleared before updating progress
        setTimeout(() => {
          // Debug: Check which fields are still filled
          const stillFilled = Array.from(document.querySelectorAll('input, select, textarea')).filter(field => {
            if (field.type === 'checkbox' || field.type === 'radio') {
              return field.checked;
            } else {
              return field.value && field.value.trim() !== '';
            }
          });
          
          if (stillFilled.length > 0) {
            console.log('Fields still filled after clear:', stillFilled.map(f => ({ id: f.id, type: f.type, value: f.value, checked: f.checked })));
          }
          
        this.updateScoreDisplay();
        this.updateCompletionStatus();
          this.updateSectionStatus();
        this.updateSaveStatus('pending');
        this.showNotification('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ / Form cleared', 'success');
        }, 100);
      }
    );
}

// Initialize the application
window.cyberRiskManager = new CyberRiskManager();
const cyberRiskManager = window.cyberRiskManager;

// Legacy function compatibility
function saveDraft() { 
  console.log('ğŸ”„ Save button clicked');
  if (window.cyberRiskManager) {
    console.log('âœ… CyberRiskManager found, calling saveDraft');
    cyberRiskManager.saveDraft(); 
  } else {
    console.error('âŒ CyberRiskManager not found');
    showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… / System error', 'error');
  }
}
function downloadReport() { cyberRiskManager.downloadReport(); }
function loadDraft() { 
  console.log('ğŸ”„ Load button clicked');
  if (window.cyberRiskManager) {
    console.log('âœ… CyberRiskManager found, calling loadDraft');
    cyberRiskManager.loadDraft(); 
  } else {
    console.error('âŒ CyberRiskManager not found');
    showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… / System error', 'error');
  }
}
function validateAndSave() { cyberRiskManager.validateAndSave(); }
function exportToPDF() { cyberRiskManager.exportToPDF(); }
function clearForm() { cyberRiskManager.clearForm(); }
function closeModal() { cyberRiskManager.closeModal(); }
function confirmAction() { cyberRiskManager.confirmAction(); }
function downloadComplianceReport() { cyberRiskManager.downloadComplianceReport(); }

// User credentials database is now initialized at the top of the script

// Update credentials based on selected user level (TUV-AUT Only)
function updateCredentials() {
  const userLevel = document.getElementById('userLevel').value;
  const customerAccess = document.getElementById('customerAccess');
  const usernameField = document.getElementById('username');
  const passwordField = document.getElementById('password');
  const organizationField = document.getElementById('organization');
  
  if (userLevel === 'trustit' || userLevel === 'customer') {
    // Both TUV Trust IT Team and TUV Customer use same credentials
    usernameField.value = 'Trust-it@tuvautria.sa';
    passwordField.value = 'TUV2025Secure!';
    organizationField.value = 'TUV Austria Trust IT Team';
    
    // Make fields readonly
    usernameField.readOnly = true;
    passwordField.readOnly = true;
    organizationField.readOnly = true;
    
    // Hide customer access
    customerAccess.style.display = 'none';
    
    // Update field styling
    usernameField.style.backgroundColor = '#f3f4f6';
    usernameField.style.color = '#6b7280';
    usernameField.style.border = '2px solid #d1d5db';
    
    passwordField.style.backgroundColor = '#f3f4f6';
    passwordField.style.color = '#6b7280';
    passwordField.style.border = '2px solid #d1d5db';
    
    organizationField.style.backgroundColor = '#f3f4f6';
    organizationField.style.color = '#6b7280';
    organizationField.style.border = '2px solid #d1d5db';
    
  } else {
    // No selection - Clear fields
    usernameField.value = '';
    passwordField.value = '';
    organizationField.value = '';
    
    // Make fields editable
    usernameField.readOnly = false;
    passwordField.readOnly = false;
    organizationField.readOnly = false;
    
    // Reset field styling
    usernameField.style.backgroundColor = '';
    usernameField.style.color = '';
    usernameField.style.border = '';
    
    passwordField.style.backgroundColor = '';
    passwordField.style.color = '';
    passwordField.style.border = '';
    
    organizationField.style.backgroundColor = '';
    organizationField.style.color = '';
    organizationField.style.border = '';
    
    // Hide customer access
    customerAccess.style.display = 'none';
  }
}

// Legacy function for backward compatibility
function updateUserCredentials() {
  // Ensure user database is available
  if (!window.userDatabase) {
    console.error('User database not initialized');
    return;
  }
  
  const userLevel = document.getElementById('userLevel').value;
  const usernameField = document.getElementById('username');
  const passwordField = document.getElementById('password');
  const organizationField = document.getElementById('organization');
  const passwordHint = document.getElementById('passwordHint');
  const userInfo = document.getElementById('userInfoModal');
  const userDetails = document.getElementById('userDetails');
  
  console.log('updateUserCredentials called with userLevel:', userLevel);
  console.log('Available users:', Object.keys(window.userDatabase));
  
  if (userLevel && window.userDatabase[userLevel]) {
    const user = window.userDatabase[userLevel];
    console.log('User found:', user);
    
    // Set helpful placeholders instead of auto-filling
    if (user.email) {
      usernameField.placeholder = `Suggested: ${user.email}`;
    } else {
      usernameField.placeholder = `Suggested: ${userLevel}`;
    }
    organizationField.placeholder = `Suggested: ${user.org}`;
    passwordField.placeholder = 'Enter password';
    
    // Show password hint
    passwordHint.textContent = user.hint;
    passwordHint.style.display = 'block';
    
    // SECURITY FIX: Use textContent instead of innerHTML to prevent XSS
    userDetails.innerHTML = '';
    
    const createDetailRow = (label, value) => {
      const row = document.createElement('div');
      const labelSpan = document.createElement('strong');
      labelSpan.textContent = `${label}: `;
      const valueSpan = document.createElement('span');
      valueSpan.textContent = value; // Safe - values are from internal sources
      row.appendChild(labelSpan);
      row.appendChild(valueSpan);
      return row;
    };
    
    userDetails.appendChild(createDetailRow('Name', user.name));
    userDetails.appendChild(createDetailRow('Level', user.level));
    userDetails.appendChild(createDetailRow('Organization', user.org));
    userDetails.appendChild(createDetailRow('Email', user.email || 'N/A'));
    userDetails.appendChild(createDetailRow('Description', user.description));
    
    const credentialsHeader = document.createElement('div');
    credentialsHeader.innerHTML = '<br><strong>Suggested Credentials:</strong><br>'; // Safe - static text
    userDetails.appendChild(credentialsHeader);
    
    userDetails.appendChild(createDetailRow('Username', user.email || userLevel));
    userDetails.appendChild(createDetailRow('Organization', user.org));
    userDetails.appendChild(createDetailRow('Password', user.password));
    userInfo.style.display = 'block';
    
    // Clear any previous errors
    document.getElementById('authError').style.display = 'none';
    
    console.log('Placeholders set - Username:', usernameField.placeholder, 'Organization:', organizationField.placeholder);
  } else {
    console.log('User not found or no level selected');
    // Clear fields if no level selected
    usernameField.value = '';
    organizationField.value = '';
    passwordField.value = '';
    passwordHint.style.display = 'none';
    userInfo.style.display = 'none';
  }
}

// Send security alert for unauthorized access attempts
function sendSecurityAlert(userLevel, reason) {
  const alertData = {
    type: 'SECURITY_ALERT',
    timestamp: new Date().toISOString(),
    userLevel: userLevel,
    reason: reason,
    ip: 'Unknown', // In production, get real IP
    userAgent: navigator.userAgent,
    sessionId: sessionStorage.getItem('sessionId') || 'Unknown'
  };
  
  // Log security alert
  console.error('SECURITY ALERT:', alertData);
  
  // Send to monitoring system (simulated)
  sendHiddenReport('SECURITY_ALERT', alertData);
}

// Regulator Selection Guidance Function
function showRegulatorGuidance() {
  const regsSelect = document.getElementById('regs');
  const guidancePanel = document.getElementById('regulatorGuidance');
  const guidanceContent = document.getElementById('guidanceContent');
  
  if (!regsSelect || !guidancePanel || !guidanceContent) return;
  
  const selectedValues = Array.from(regsSelect.selectedOptions).map(option => option.value);
  
  if (selectedValues.length === 0) {
    guidancePanel.style.display = 'none';
    return;
  }
  
  let guidance = '<div style="display: grid; gap: 12px;">';
  
  selectedValues.forEach(regulator => {
    switch(regulator) {
      case 'SAMA':
        guidance += `
          <div style="padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px;">
            <h5 style="margin: 0 0 8px 0; color: #92400e;">ğŸ¦ SAMA - Financial Sector</h5>
            <p style="margin: 0; font-size: 13px; color: #78350f;">
              <strong>Applies to:</strong> Insurance companies, banks, financial institutions<br>
              <strong>Focus:</strong> Financial data protection, risk management, board governance<br>
              <strong>Framework:</strong> SAMA Cyber Security Framework (SAMA-CSF)
            </p>
          </div>
        `;
        break;
        
      case 'NCA':
        guidance += `
          <div style="padding: 12px; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 6px;">
            <h5 style="margin: 0 0 8px 0; color: #1e40af;">ğŸ›¡ï¸ NCA - Critical Infrastructure</h5>
            <p style="margin: 0; font-size: 13px; color: #1e3a8a;">
              <strong>Applies to:</strong> Government entities, critical infrastructure, national security<br>
              <strong>Focus:</strong> Institutional integrity, ethics programs, incident reporting<br>
              <strong>Framework:</strong> Essential Cybersecurity Controls (ECC v2.0)
            </p>
          </div>
        `;
        break;
        
      case 'PDPL':
        guidance += `
          <div style="padding: 12px; background: #f3e8ff; border-left: 4px solid #8b5cf6; border-radius: 6px;">
            <h5 style="margin: 0 0 8px 0; color: #6b21a8;">ğŸ”’ PDPL - Data Protection</h5>
            <p style="margin: 0; font-size: 13px; color: #581c87;">
              <strong>Applies to:</strong> Any organization processing personal data<br>
              <strong>Focus:</strong> Personal data protection, consent management, data subject rights<br>
              <strong>Framework:</strong> Personal Data Protection Law
            </p>
          </div>
        `;
        break;
        
      case 'Other':
        guidance += `
          <div style="padding: 12px; background: #f0fdf4; border-left: 4px solid #10b981; border-radius: 6px;">
            <h5 style="margin: 0 0 8px 0; color: #047857;">ğŸŒ Other - International Frameworks</h5>
            <p style="margin: 0; font-size: 13px; color: #065f46;">
              <strong>Applies to:</strong> International standards, industry-specific requirements<br>
              <strong>Focus:</strong> ISO 27001, NIST, COBIT, industry-specific frameworks<br>
              <strong>Framework:</strong> Custom or international cybersecurity standards
            </p>
          </div>
        `;
        break;
    }
  });
  
  guidance += '</div>';
  
  if (selectedValues.length > 1) {
    guidance += `
      <div style="margin-top: 15px; padding: 12px; background: #ecfdf5; border: 1px solid #10b981; border-radius: 6px;">
        <h5 style="margin: 0 0 8px 0; color: #047857;">âœ… Multi-Regulator Assessment</h5>
        <p style="margin: 0; font-size: 13px; color: #065f46;">
          You've selected multiple regulators. The assessment will evaluate compliance across all selected frameworks, 
          providing a comprehensive view of your cybersecurity posture.
        </p>
      </div>
    `;
  }
  
  guidanceContent.innerHTML = guidance;
  guidancePanel.style.display = 'block';
}

// Test function for TUV Austria Trust IT login
function testTUVLogin() {
  console.log('Testing TUV Austria Trust IT login...');
  
  try {
    // Check if user database is available
    if (!window.userDatabase) {
      console.error('User database not initialized');
      alert('Error: User database not initialized. Please refresh the page.');
      return;
    }
    
    // Set the user level to TUV Trust IT
    document.getElementById('userLevel').value = 'trustit';
    
    // Trigger the update function to prefill credentials
    updateCredentials();
    
    console.log('TUV test setup complete. Username:', document.getElementById('username').value);
    console.log('Organization:', document.getElementById('organization').value);
    console.log('Password:', document.getElementById('password').value);
    
    // Test authentication directly
    const user = window.userDatabase['trustit'];
    if (user) {
      console.log('User found in database:', user);
      alert('TUV Austria Trust IT Team credentials loaded successfully!\n\nName: TUV Austria Trust IT Team\nEmail: Trust-it@tuvautria.sa\nOrganization: TUV Austria Trust IT Team\nCode: TUV-AUT-001\nLevel: Trust IT Team\nPassword: TUV2025Secure!\n\nClick Login to authenticate.');
    } else {
      console.error('User not found in database');
      alert('Error: User not found in database');
    }
  } catch (error) {
    console.error('Error in testTUVLogin:', error);
    alert('Error: ' + error.message);
  }
}

// TUV-AUT Only Authentication System
function authenticateUser() {
  try {
    const userLevel = document.getElementById('userLevel').value;
    const password = document.getElementById('password').value;
    const username = document.getElementById('username').value;
    const organization = document.getElementById('organization').value;
    const customerCode = document.getElementById('customerCode') ? document.getElementById('customerCode').value : '';
    const customerPassword = document.getElementById('customerPassword') ? document.getElementById('customerPassword').value : '';
    
    if (!userLevel) {
      document.getElementById('authError').textContent = 'Please select a user level.';
      document.getElementById('authError').style.display = 'block';
      return;
    }
    
    if (userLevel === 'trustit') {
      // TUV Austria Trust IT Team authentication
      if (username === 'Trust-it@tuvautria.sa' && 
          password === 'TUV2025Secure!' && 
          organization === 'TUV Austria Trust IT Team') {
        
        // Successful TUV authentication
        sessionStorage.setItem('authenticated', 'true');
        sessionStorage.setItem('username', 'trustit');
        sessionStorage.setItem('userInfo', JSON.stringify({
          name: 'TUV Austria Trust IT Team',
          organization: 'TUV-AUT-001',
          level: 'Trust IT Team',
          permissions: ['admin', 'audit', 'export', 'manage']
        }));
        
        // Hide auth modal and show main content
        document.getElementById('authModal').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.querySelector('.container').style.display = 'block';
        
        // Update user info display
        document.getElementById('userInfo').textContent = 'Logged in as: TUV Austria Trust IT Team (Trust-it@tuvautria.sa) - Trust IT Team';
        
        // Show license status
        startLicenseCountdown();
        
        // Initialize the application
        cyberRiskManager.init();
        initializeHiddenReporting();
        setTimeout(initializeMarketTrendsCharts, 500);
        
        console.log('TUV Austria Trust IT Team authenticated successfully');
        
      } else {
        document.getElementById('authError').textContent = 'Invalid TUV credentials. Access restricted to TUV Austria Trust IT Team only.';
        document.getElementById('authError').style.display = 'block';
      }
      
    } else if (userLevel === 'customer') {
      // TUV Customer authentication - uses same credentials as TUV Trust IT
      if (username === 'Trust-it@tuvautria.sa' && 
          password === 'TUV2025Secure!' && 
          organization === 'TUV Austria Trust IT Team') {
        
        // Successful TUV Customer authentication
        sessionStorage.setItem('authenticated', 'true');
        sessionStorage.setItem('username', 'customer');
        sessionStorage.setItem('userInfo', JSON.stringify({
          name: 'TUV Customer',
          organization: 'TUV-AUT-001',
          level: 'Customer',
          permissions: ['view', 'audit']
        }));
        
        // Hide auth modal and show main content
        document.getElementById('authModal').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.querySelector('.container').style.display = 'block';
        
        // Update user info display
        document.getElementById('userInfo').textContent = `Logged in as: TUV Customer (${customerCode}) - Customer`;
        
        // Show license status
        startLicenseCountdown();
        
        // Initialize the application
        cyberRiskManager.init();
        initializeHiddenReporting();
        setTimeout(initializeMarketTrendsCharts, 500);
        
        console.log('TUV Customer authenticated successfully');
        
      } else {
        document.getElementById('authError').textContent = 'Invalid customer credentials. Please contact TUV Austria Trust IT for access.';
        document.getElementById('authError').style.display = 'block';
      }
      
    } else {
      document.getElementById('authError').textContent = 'Invalid user level. This form is restricted to TUV Austria and customers only.';
      document.getElementById('authError').style.display = 'block';
    }
    
  } catch (error) {
    console.error('Authentication error:', error);
    document.getElementById('authError').textContent = 'Authentication error. Please try again.';
    document.getElementById('authError').style.display = 'block';
  }
}

// Legacy authentication function for backward compatibility
function authenticateUserLegacy() {
  try {
    // Ensure user database is available
    if (!window.userDatabase) {
      console.error('User database not initialized');
      document.getElementById('authError').textContent = 'System error: User database not available. Please refresh the page.';
      document.getElementById('authError').style.display = 'block';
      return;
    }
    
    const userLevel = document.getElementById('userLevel').value;
    const password = document.getElementById('password').value;
    const username = document.getElementById('username').value;
    const organization = document.getElementById('organization').value;
    
    console.log('Authentication attempt - UserLevel:', userLevel, 'Password:', password, 'Username:', username, 'Organization:', organization);
    console.log('User database available:', !!window.userDatabase);
  
  if (!userLevel) {
    document.getElementById('authError').textContent = 'Please select a user level.';
    document.getElementById('authError').style.display = 'block';
    return;
  }
  
  if (!username) {
    document.getElementById('authError').textContent = 'Please enter a username.';
    document.getElementById('authError').style.display = 'block';
    return;
  }
  
  if (!password) {
    document.getElementById('authError').textContent = 'Please enter a password.';
    document.getElementById('authError').style.display = 'block';
    return;
  }
  
  if (!organization) {
    document.getElementById('authError').textContent = 'Please enter an organization code.';
    document.getElementById('authError').style.display = 'block';
    return;
  }
  
  const user = window.userDatabase[userLevel];
  console.log('User from database:', user);
  console.log('Password match:', user ? user.password === password : 'User not found');
  console.log('Username match:', user ? (user.username === username || userLevel === username) : 'User not found');
  console.log('Organization match:', user ? user.organization === organization : 'User not found');
  
  // Check if credentials match the selected user level
  const isPasswordMatch = user && user.password === password;
  const isUsernameMatch = user && (user.username === username || userLevel === username);
  const isOrgMatch = user && user.organization === organization;
  
  if (user && isPasswordMatch && isUsernameMatch && isOrgMatch) {
    // Production authentication - using production auth system
    if (window.productionAuth) {
      // Update last login time
      user.lastLogin = new Date().toISOString();
      
      // Save session using production auth system
      const session = window.productionAuth.saveSession({
        username: user.username,
        name: user.name,
        level: user.level,
        organization: user.organization,
        permissions: user.permissions,
        isActive: user.isActive
      });
      
      console.log('âœ… Production session created:', session.sessionId);
    }
    
    // Legacy session storage for compatibility
    sessionStorage.setItem('authenticated', 'true');
    sessionStorage.setItem('username', userLevel);
    sessionStorage.setItem('userInfo', JSON.stringify({
      name: user.name,
      organization: user.organization,
      level: user.level,
      permissions: user.permissions
    }));
    
    // Hide auth modal and show main content
    document.getElementById('authModal').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    document.querySelector('.container').style.display = 'block';
    
    // Update user info display without icons for professional appearance
    document.getElementById('userInfo').textContent = `Logged in as: ${user.name} (${user.organization}) - ${user.level}`;
    
    // Initialize the application
    cyberRiskManager.init();
    
    // Digital stamp will be initialized when user clicks the toggle button
    console.log('User logged in, digital stamp available via toggle button');
    
    // Initialize hidden reporting
    initializeHiddenReporting();
    
    // Initialize charts after a short delay to ensure DOM is ready
    setTimeout(initializeMarketTrendsCharts, 500);
    
    // Log successful authentication
    console.log(`User ${userLevel} (${username}) authenticated successfully at ${new Date().toISOString()}`);
    
  } else {
    // Failed authentication
    document.getElementById('authError').textContent = 'Invalid password. Please try again or contact your CISO for assistance.';
    document.getElementById('authError').style.display = 'block';
    
    // Log failed authentication attempt
    console.warn(`Failed authentication attempt for user level: ${userLevel} (${username}) at ${new Date().toISOString()}`);
    
    // Send security alert for admin/auditor access attempts
    if (userLevel === 'admin' || userLevel === 'auditor') {
      sendSecurityAlert(userLevel, 'Failed authentication attempt');
    }
  }
  } catch (error) {
    console.error('Error in authenticateUser:', error);
    document.getElementById('authError').textContent = 'Authentication error: ' + error.message;
    document.getElementById('authError').style.display = 'block';
  }
}

// Digital Stamp and Hidden Reporting Functions
function initializeDigitalStamp() {
  const now = new Date();
  const sessionId = generateSessionId();
  
  // Update digital stamp
  document.getElementById('stampDate').textContent = now.toLocaleString('en-SA', {
    timeZone: 'Asia/Riyadh',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
  
  document.getElementById('stampLocation').textContent = getLocationInfo();
  document.getElementById('stampUser').textContent = sessionStorage.getItem('username') || 'Unknown';
  document.getElementById('stampOrg').textContent = JSON.parse(sessionStorage.getItem('userInfo') || '{}').org || 'Unknown';
  document.getElementById('sessionId').textContent = sessionId;
  
  // Store session ID
  sessionStorage.setItem('sessionId', sessionId);
}

function generateSessionId() {
  return 'KSA-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase();
}

// PDPL COMPLIANCE: Location collection disabled by default
function getLocationInfo() {
  // SECURITY NOTICE: Location collection disabled for PDPL compliance
  // In production, implement proper consent mechanism before collecting location
  console.log('Location collection disabled for PDPL compliance');
  
  // Check if user has consented to data collection
  const analyticsConsent = sessionStorage.getItem('analyticsConsent');
  if (analyticsConsent !== 'true') {
    document.getElementById('stampLocation').textContent = 'Location collection disabled - no consent';
    return 'Location collection disabled';
  }
  
  // Only proceed if user has explicitly opted in
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        const lat = position.coords.latitude.toFixed(4);
        const lon = position.coords.longitude.toFixed(4);
        document.getElementById('stampLocation').textContent = `${lat}, ${lon}`;
      },
      function() {
        document.getElementById('stampLocation').textContent = 'Location not available';
      }
    );
  } else {
    document.getElementById('stampLocation').textContent = 'Location not available';
  }
  return 'Detecting...';
}

// PDPL COMPLIANCE: Hidden reporting disabled by default
// Users must explicitly opt-in to any data collection
function initializeHiddenReporting() {
  // SECURITY NOTICE: Hidden reporting disabled for PDPL compliance
  // In production, implement proper opt-in consent mechanism
  console.log('Hidden reporting disabled for PDPL compliance');
  
  // Check if user has opted in to analytics (PDPL compliant)
  const analyticsConsent = sessionStorage.getItem('analyticsConsent');
  if (analyticsConsent === 'true') {
    console.log('User has opted in to analytics - reporting enabled');
    // Only proceed if user has explicitly consented
    // Implement proper consent-based reporting here
  } else {
    console.log('No analytics consent - reporting disabled');
    // Show consent banner if not already shown
    showAnalyticsConsentBanner();
  }
}

// PDPL COMPLIANCE: Hidden reporting disabled by default
function sendHiddenReport(type, data) {
  // SECURITY NOTICE: Hidden reporting disabled for PDPL compliance
  // This function is disabled to prevent unauthorized data collection
  console.log('Hidden reporting disabled for PDPL compliance - no data collected');
  
  // Check if user has explicitly consented to data collection
  const analyticsConsent = sessionStorage.getItem('analyticsConsent');
  if (analyticsConsent !== 'true') {
    console.log('No consent for data collection - report not sent');
    return;
  }
  
  // Only proceed if user has explicitly opted in
  console.log('User consented to analytics - report would be sent in production');
  // In production, implement proper consent-based reporting here
}

// PDPL COMPLIANCE: Email reporting disabled by default
function sendEmailReport(data) {
  // SECURITY NOTICE: Email reporting disabled for PDPL compliance
  // This function is disabled to prevent unauthorized data transmission
  console.log('Email reporting disabled for PDPL compliance - no data sent');
  
  // Check if user has explicitly consented to data collection
  const analyticsConsent = sessionStorage.getItem('analyticsConsent');
  if (analyticsConsent !== 'true') {
    console.log('No consent for data transmission - email not sent');
    return;
  }
  
  // Only proceed if user has explicitly opted in
  console.log('User consented to analytics - email would be sent in production');
  // In production, implement proper consent-based email reporting here
}

// PDPL COMPLIANCE: Analytics consent banner
function showAnalyticsConsentBanner() {
  // Check if banner already shown
  if (sessionStorage.getItem('analyticsConsentShown') === 'true') {
    return;
  }
  
  // Create consent banner
  const banner = document.createElement('div');
  banner.id = 'analyticsConsentBanner';
  banner.style.cssText = `
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #1e293b;
    color: white;
    padding: 15px;
    z-index: 10000;
    border-top: 2px solid #0ea5e9;
    font-family: Arial, sans-serif;
  `;
  
  banner.innerHTML = `
    <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
      <div style="flex: 1; min-width: 300px;">
        <strong>ğŸ”’ Privacy Notice / Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø®ØµÙˆØµÙŠØ©</strong><br>
        <small>We respect your privacy. Analytics data collection is optional and requires your explicit consent.</small><br>
        <small>Ù†Ø­ØªØ±Ù… Ø®ØµÙˆØµÙŠØªÙƒ. Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙˆÙŠØªØ·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚ØªÙƒ Ø§Ù„ØµØ±ÙŠØ­Ø©.</small>
      </div>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="acceptAnalytics()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
          Accept / Ù…ÙˆØ§ÙÙ‚Ø©
        </button>
        <button onclick="declineAnalytics()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
          Decline / Ø±ÙØ¶
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(banner);
  sessionStorage.setItem('analyticsConsentShown', 'true');
}

function acceptAnalytics() {
  sessionStorage.setItem('analyticsConsent', 'true');
  document.getElementById('analyticsConsentBanner').remove();
  console.log('User accepted analytics consent');
}

function declineAnalytics() {
  sessionStorage.setItem('analyticsConsent', 'false');
  document.getElementById('analyticsConsentBanner').remove();
  console.log('User declined analytics consent');
}

function generateEmailBody(data) {
  return `
KSA CYBERSECURITY ASSESSMENT - HIDDEN REPORT
============================================

Report Type: ${data.type}
Timestamp: ${data.timestamp}
User: ${data.user}
Organization: ${data.organization}
Session ID: ${data.sessionId}

SYSTEM INFORMATION:
- User Agent: ${data.userAgent || 'N/A'}
- Language: ${data.language || 'N/A'}
- Platform: ${data.platform || 'N/A'}
- Screen Resolution: ${data.screenResolution || 'N/A'}
- Timezone: ${data.timezone || 'N/A'}
- Referrer: ${data.referrer || 'N/A'}

${data.type === 'SUBMIT' ? `
ASSESSMENT DATA:
- Form Data: ${JSON.stringify(data.formData, null, 2)}
- Scores: ${JSON.stringify(data.scores, null, 2)}
- Compliance: ${JSON.stringify(data.compliance, null, 2)}
` : ''}

${data.type === 'ACTIVITY' ? `
ACTIVITY DATA:
- Form Progress: ${data.formProgress || 'N/A'}%
- Current Section: ${data.currentSection || 'N/A'}
- Time on Page: ${data.timeOnPage || 'N/A'} minutes
` : ''}

This is an automated report from the KSA Cybersecurity Assessment Tool.
  `;
}

function getFormProgress() {
  const totalFields = document.querySelectorAll('input, select, textarea').length;
  const filledFields = document.querySelectorAll('input:not([value=""]), select:not([value=""]), textarea:not([value=""])').length;
  return Math.round((filledFields / totalFields) * 100);
}

function getCurrentSection() {
  const visibleSection = document.querySelector('.card:not([style*="display: none"]) h2');
  return visibleSection ? visibleSection.textContent : 'Unknown';
}

function getTimeOnPage() {
  const startTime = sessionStorage.getItem('pageStartTime') || Date.now();
  return Math.round((Date.now() - startTime) / 60000); // minutes
}

function logout() {
  // Send final logout report
  sendHiddenReport('LOGOUT', {
    timestamp: new Date().toISOString(),
    user: sessionStorage.getItem('username'),
    organization: JSON.parse(sessionStorage.getItem('userInfo') || '{}').org,
    sessionId: sessionStorage.getItem('sessionId'),
    formProgress: getFormProgress(),
    timeOnPage: getTimeOnPage(),
    logoutType: 'MANUAL'
  });
  
  // Send all pending offline reports
  sendOfflineReports();
  
  sessionStorage.clear();
  location.reload();
}

function sendOfflineReports() {
  try {
    const reports = JSON.parse(localStorage.getItem('hiddenReports') || '[]');
    if (reports.length > 0) {
      // Simulate sending all pending reports
      console.log(`Sending ${reports.length} offline reports to ahmet@doganconsult.com`);
      
      // Create a summary report
      const summaryReport = {
        to: 'ahmet@doganconsult.com',
        subject: `KSA Cybersecurity Assessment - OFFLINE REPORTS SUMMARY - ${new Date().toISOString().split('T')[0]}`,
        body: generateOfflineSummaryReport(reports),
        timestamp: new Date().toISOString()
      };
      
      console.log('Offline reports summary prepared for:', summaryReport.to);
      
      // Clear offline reports after sending
      localStorage.removeItem('hiddenReports');
    }
  } catch (error) {
    console.error('Error sending offline reports:', error);
  }
}

function generateOfflineSummaryReport(reports) {
  const userCounts = {};
  const orgCounts = {};
  const typeCounts = {};
  
  reports.forEach(report => {
    userCounts[report.user] = (userCounts[report.user] || 0) + 1;
    orgCounts[report.organization] = (orgCounts[report.organization] || 0) + 1;
    typeCounts[report.type] = (typeCounts[report.type] || 0) + 1;
  });
  
  return `
KSA CYBERSECURITY ASSESSMENT - OFFLINE REPORTS SUMMARY
=====================================================

Summary Date: ${new Date().toISOString()}
Total Reports: ${reports.length}

USER ACTIVITY SUMMARY:
${Object.entries(userCounts).map(([user, count]) => `- ${user}: ${count} activities`).join('\n')}

ORGANIZATION SUMMARY:
${Object.entries(orgCounts).map(([org, count]) => `- ${org}: ${count} activities`).join('\n')}

ACTIVITY TYPE SUMMARY:
${Object.entries(typeCounts).map(([type, count]) => `- ${type}: ${count} occurrences`).join('\n')}

DETAILED REPORTS:
${reports.map((report, index) => `
Report ${index + 1}:
- Type: ${report.type}
- User: ${report.user}
- Organization: ${report.organization}
- Timestamp: ${report.timestamp}
- Subject: ${report.subject}
`).join('\n')}

This is an automated summary from the KSA Cybersecurity Assessment Tool.
All detailed reports have been sent separately.
  `;
}

// Collapsible Sections Functionality
function toggleSection(sectionId) {
  const content = document.getElementById(sectionId);
  const toggle = document.getElementById(sectionId + '-toggle');
  
  if (!content || !toggle) {
    console.error(`Section elements not found for: ${sectionId}`, {content: !!content, toggle: !!toggle});
    return;
  }
  
  if (content.classList.contains('collapsed')) {
    content.classList.remove('collapsed');
    toggle.classList.remove('collapsed');
    toggle.textContent = 'â–¼';
    console.log(`Expanded section: ${sectionId}`);
    
    // Initialize charts when market trends section is opened
    if (sectionId === 'marketTrends') {
      setTimeout(initializeMarketTrendsCharts, 100);
    }
  } else {
    content.classList.add('collapsed');
    toggle.classList.add('collapsed');
    toggle.textContent = 'â–¶';
    console.log(`Collapsed section: ${sectionId}`);
  }
  
  // Update progress bar after section toggle
  if (window.cyberRiskManager) {
    setTimeout(() => {
      cyberRiskManager.updateCompletionStatus();
      cyberRiskManager.updateSectionStatus();
    }, 100);
  }
}

function initializeCollapsibleSections() {
  // Auto-collapse ALL sections by default
  const sections = [
    'orgOverview', 'insuranceFootprint', 'regulatoryCompliance', 'privacyDataProtection',
    'socMonitoring', 'technicalControls', 'cloudHosting', 'riskAssessment', 
    'evidenceDocumentation', 'resilience', 'managedSOC', 'riskScoring', 'ksaComplianceReport', 'actionsAndReports'
  ];
  
  console.log('Initializing collapsible sections...');
  console.log('Sections to process:', sections);
  
  // Collapse all sections
  sections.forEach((sectionId, index) => {
    const content = document.getElementById(sectionId);
    const toggle = document.getElementById(sectionId + '-toggle');
    
    console.log(`Processing section ${index + 1}: ${sectionId}`, {
      content: !!content,
      toggle: !!toggle,
      contentElement: content,
      toggleElement: toggle
    });
    
    if (content && toggle) {
      content.classList.add('collapsed');
      toggle.classList.add('collapsed');
      toggle.textContent = 'â–¶';
      console.log(`âœ… Collapsed section: ${sectionId}`);
    } else {
      console.error(`âŒ Section not found: ${sectionId}`, {
        content: !!content, 
        toggle: !!toggle,
        contentId: sectionId,
        toggleId: sectionId + '-toggle'
      });
    }
  });
  
  console.log('All sections collapsed by default');
}

// Manual function to test specific sections
function testSpecificSections() {
  console.log('Testing specific sections (3 and 7)...');
  
  // Test section 3 (regulatoryCompliance)
  const section3 = document.getElementById('regulatoryCompliance');
  const toggle3 = document.getElementById('regulatoryCompliance-toggle');
  console.log('Section 3 (regulatoryCompliance):', {
    content: !!section3,
    toggle: !!toggle3,
    contentElement: section3,
    toggleElement: toggle3
  });
  
  // Test section 7 (riskAssessment)
  const section7 = document.getElementById('riskAssessment');
  const toggle7 = document.getElementById('riskAssessment-toggle');
  console.log('Section 7 (riskAssessment):', {
    content: !!section7,
    toggle: !!toggle7,
    contentElement: section7,
    toggleElement: toggle7
  });
  
  // Force collapse these specific sections
  if (section3 && toggle3) {
    section3.classList.add('collapsed');
    toggle3.classList.add('collapsed');
    toggle3.textContent = 'â–¶';
    console.log('âœ… Forced collapse section 3');
  }
  
  if (section7 && toggle7) {
    section7.classList.add('collapsed');
    toggle7.classList.add('collapsed');
    toggle7.textContent = 'â–¶';
    console.log('âœ… Forced collapse section 7');
  }
}

// Check authentication on page load
window.addEventListener('load', function() {
  // Set page start time for tracking
  sessionStorage.setItem('pageStartTime', Date.now());
  
  // Initialize collapsible sections for all users (authenticated or not)
  initializeCollapsibleSections();
  
  if (sessionStorage.getItem('authenticated') === 'true') {
    document.getElementById('authModal').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    document.querySelector('.container').style.display = 'block';
    
    const userInfo = JSON.parse(sessionStorage.getItem('userInfo') || '{}');
    document.getElementById('userInfo').textContent = `Logged in as: ${userInfo.name || 'User'} (${userInfo.org || 'Unknown'})`;
    
    // Initialize the application
    cyberRiskManager.init();
    
    // Initialize digital stamp and hidden reporting
    initializeDigitalStamp();
    initializeHiddenReporting();
    
    // Initialize charts after a short delay to ensure DOM is ready
    setTimeout(initializeMarketTrendsCharts, 500);
  } else {
    document.getElementById('authModal').style.display = 'block';
    document.getElementById('mainContent').style.display = 'none';
    document.querySelector('.container').style.display = 'none';
  }
});

// Load Chart.js dynamically if not already loaded
function loadChartJS() {
  if (typeof Chart !== 'undefined') {
    console.log('Chart.js already loaded');
    return Promise.resolve();
  }
  
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = () => {
      console.log('Chart.js loaded successfully');
      resolve();
    };
    script.onerror = () => {
      console.error('Failed to load Chart.js');
      reject(new Error('Failed to load Chart.js'));
    };
    document.head.appendChild(script);
  });
}

// Initialize Market Trends Charts
function initializeMarketTrendsCharts() {
  console.log('Initializing market trends charts...');
  
  // Check if Chart.js is loaded
  if (typeof Chart === 'undefined') {
    console.error('Chart.js is not loaded. Loading dynamically...');
    loadChartJS().then(() => {
      console.log('Chart.js loaded, retrying chart initialization...');
      setTimeout(initializeMarketTrendsCharts, 500);
    }).catch(error => {
      console.error('Failed to load Chart.js:', error);
    });
    return;
  }
  
  // Check if canvas elements exist and are visible
  const canvasElements = document.querySelectorAll('canvas[id$="Chart"]');
  console.log('Found canvas elements:', canvasElements.length);
  
  if (canvasElements.length === 0) {
    console.error('No chart canvas elements found. Market trends section may not be visible.');
    return;
  }
  
  // Check if market trends section is visible
  const marketTrendsSection = document.getElementById('marketTrends');
  if (marketTrendsSection && marketTrendsSection.classList.contains('collapsed')) {
    console.log('Market trends section is collapsed, charts will initialize when opened');
    return;
  }
  
  // Ensure canvas elements are properly sized
  canvasElements.forEach(canvas => {
    const container = canvas.parentElement;
    if (container && container.classList.contains('chart-container')) {
      // Set canvas size to match container
      canvas.width = container.offsetWidth;
      canvas.height = container.offsetHeight;
      console.log(`Canvas ${canvas.id} sized to: ${canvas.width}x${canvas.height}`);
    } else if (canvas.offsetWidth === 0 || canvas.offsetHeight === 0) {
      console.warn(`Canvas ${canvas.id} has zero dimensions, setting default size`);
      canvas.style.width = '100%';
      canvas.style.height = '300px';
    }
  });
  
  // Saudi Arabia Chart - Enhanced line chart with animations
  const saudiCtx = document.getElementById('saudiChart');
  if (saudiCtx) {
    try {
      new Chart(saudiCtx, {
      type: 'line',
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { 
              color: '#f3f4f6',
              drawBorder: false
            },
            ticks: {
              font: { size: 10 },
              color: '#6b7280'
            }
          },
          x: {
            grid: { 
              color: '#f3f4f6',
              drawBorder: false
            },
            ticks: {
              font: { size: 10 },
              color: '#6b7280'
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      },
      data: {
        labels: ['2020', '2021', '2022', '2023', '2024', '2025E'],
        datasets: [{
          label: 'Cyber Attacks (Incidents)',
          data: [85, 142, 198, 267, 387, 520],
          borderColor: '#dc2626',
          backgroundColor: 'rgba(220, 38, 38, 0.15)',
          borderWidth: 3,
          tension: 0.4,
          fill: true,
          pointBackgroundColor: '#dc2626',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 6,
          pointHoverRadius: 8
        }, {
          label: 'Insurance Claims (SAR Million)',
          data: [120, 180, 245, 320, 485, 650],
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245, 158, 11, 0.15)',
          borderWidth: 3,
          tension: 0.4,
          fill: true,
          pointBackgroundColor: '#f59e0b',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 6,
          pointHoverRadius: 8
        }, {
          label: 'SAMA Compliance (%)',
          data: [65, 72, 78, 85, 92, 95],
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.15)',
          borderWidth: 3,
          tension: 0.4,
          fill: true,
          pointBackgroundColor: '#10b981',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 6,
          pointHoverRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 2000,
          easing: 'easeInOutQuart'
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: { size: 11, weight: '500' },
              padding: 15,
              usePointStyle: true
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#374151',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: true
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { 
              color: '#f3f4f6',
              drawBorder: false
            },
            ticks: {
              font: { size: 10 },
              color: '#6b7280'
            }
          },
          x: {
            grid: { 
              color: '#f3f4f6',
              drawBorder: false
            },
            ticks: {
              font: { size: 10 },
              color: '#6b7280'
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      }
    });
    } catch (error) {
      console.error('Error creating Saudi Arabia chart:', error);
    }
  }

  // GCC Region Chart - Enhanced bar chart with animations
  const gccCtx = document.getElementById('gccChart');
  if (gccCtx) {
    try {
      new Chart(gccCtx, {
      type: 'bar',
      data: {
        labels: ['Saudi Arabia', 'UAE', 'Qatar', 'Kuwait', 'Bahrain', 'Oman'],
        datasets: [{
          label: 'Cyber Incidents (2024)',
          data: [387, 298, 245, 198, 156, 134],
          backgroundColor: [
            'rgba(30, 41, 59, 0.8)',
            'rgba(59, 130, 246, 0.8)',
            'rgba(124, 58, 237, 0.8)',
            'rgba(220, 38, 38, 0.8)',
            'rgba(245, 158, 11, 0.8)',
            'rgba(16, 185, 129, 0.8)'
          ],
          borderColor: [
            '#1e293b',
            '#3b82f6',
            '#7c3aed',
            '#dc2626',
            '#f59e0b',
            '#10b981'
          ],
          borderWidth: 3,
          borderRadius: 8,
          borderSkipped: false
        }, {
          label: 'Insurance Penetration (%)',
          data: [34, 28, 22, 18, 15, 12],
          backgroundColor: [
            'rgba(30, 41, 59, 0.4)',
            'rgba(59, 130, 246, 0.4)',
            'rgba(124, 58, 237, 0.4)',
            'rgba(220, 38, 38, 0.4)',
            'rgba(245, 158, 11, 0.4)',
            'rgba(16, 185, 129, 0.4)'
          ],
          borderColor: [
            '#1e293b',
            '#3b82f6',
            '#7c3aed',
            '#dc2626',
            '#f59e0b',
            '#10b981'
          ],
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 2500,
          easing: 'easeInOutBounce'
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: { size: 11, weight: '500' },
              padding: 15,
              usePointStyle: true
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#374151',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: true
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { 
              color: '#f3f4f6',
              drawBorder: false
            },
            ticks: {
              font: { size: 10 },
              color: '#6b7280'
            }
          },
          x: {
            grid: { 
              display: false,
              drawBorder: false
            },
            ticks: {
              font: { size: 10 },
              color: '#6b7280'
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      }
    });
    } catch (error) {
      console.error('Error creating GCC chart:', error);
    }
  }

  // Global Market Size Chart - Enhanced doughnut chart
  const globalCtx = document.getElementById('globalChart');
  if (globalCtx) {
    try {
      new Chart(globalCtx, {
      type: 'doughnut',
      data: {
        labels: ['Insurance', 'Healthcare', 'Finance', 'Government', 'Retail', 'Manufacturing', 'Other'],
        datasets: [{
          data: [28, 22, 18, 15, 8, 6, 3],
          backgroundColor: [
            'rgba(124, 58, 237, 0.8)',
            'rgba(59, 130, 246, 0.8)',
            'rgba(16, 185, 129, 0.8)',
            'rgba(245, 158, 11, 0.8)',
            'rgba(220, 38, 38, 0.8)',
            'rgba(139, 92, 246, 0.8)',
            'rgba(107, 114, 128, 0.8)'
          ],
          borderColor: [
            '#7c3aed',
            '#3b82f6',
            '#10b981',
            '#f59e0b',
            '#dc2626',
            '#8b5cf6',
            '#6b7280'
          ],
          borderWidth: 3,
          hoverOffset: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 3000,
          easing: 'easeInOutCubic'
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: { size: 11, weight: '500' },
              padding: 15,
              usePointStyle: true
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#374151',
            borderWidth: 1,
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                return context.label + ': ' + context.parsed + '%';
              }
            }
          }
        },
        cutout: '60%'
      }
    });
    } catch (error) {
      console.error('Error creating Global chart:', error);
    }
  }

  // Attack Growth Comparison Chart - Enhanced horizontal bar
  const attackCtx = document.getElementById('attackChart');
  if (attackCtx) {
    try {
      new Chart(attackCtx, {
      type: 'bar',
      data: {
        labels: ['Healthcare', 'Finance', 'Insurance', 'Government', 'Retail', 'Manufacturing', 'Education'],
        datasets: [{
          label: 'Attack Growth % (YoY)',
          data: [95, 82, 67, 55, 48, 42, 38],
          backgroundColor: [
            'rgba(220, 38, 38, 0.8)',
            'rgba(245, 158, 11, 0.8)',
            'rgba(124, 58, 237, 0.8)',
            'rgba(59, 130, 246, 0.8)',
            'rgba(16, 185, 129, 0.8)',
            'rgba(139, 92, 246, 0.8)',
            'rgba(107, 114, 128, 0.8)'
          ],
          borderColor: [
            '#dc2626',
            '#f59e0b',
            '#7c3aed',
            '#3b82f6',
            '#10b981',
            '#8b5cf6',
            '#6b7280'
          ],
          borderWidth: 2,
          borderRadius: 6,
          borderSkipped: false
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 2000,
          easing: 'easeInOutQuart'
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: { size: 11, weight: '500' },
              padding: 15,
              usePointStyle: true
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#374151',
            borderWidth: 1,
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                return context.label + ': ' + context.parsed.x + '% growth';
              }
            }
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            grid: { 
              color: '#f3f4f6',
              drawBorder: false
            },
            ticks: {
              font: { size: 10 },
              color: '#6b7280'
            }
          },
          y: {
            grid: { 
              display: false,
              drawBorder: false
            },
            ticks: {
              font: { size: 10 },
              color: '#6b7280'
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      }
    });
    } catch (error) {
      console.error('Error creating Attack chart:', error);
    }
  }

  // Cost Analysis Chart - Enhanced radar chart
  const costCtx = document.getElementById('costChart');
  if (costCtx) {
    try {
      new Chart(costCtx, {
      type: 'radar',
      data: {
        labels: ['Detection', 'Response', 'Recovery', 'Legal', 'Regulatory', 'Reputation', 'Training', 'Technology'],
        datasets: [{
          label: 'Saudi Arabia (SAR Million)',
          data: [2.3, 1.8, 2.1, 0.9, 1.2, 1.5, 0.8, 1.4],
          borderColor: '#1e293b',
          backgroundColor: 'rgba(30, 41, 59, 0.25)',
          pointBackgroundColor: '#1e293b',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7,
          borderWidth: 3
        }, {
          label: 'GCC Average (USD Million)',
          data: [3.2, 2.5, 2.8, 1.4, 1.8, 2.1, 1.2, 1.9],
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.25)',
          pointBackgroundColor: '#3b82f6',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7,
          borderWidth: 3
        }, {
          label: 'Global Average (USD Million)',
          data: [4.45, 3.2, 3.8, 2.1, 2.5, 2.8, 1.8, 2.6],
          borderColor: '#7c3aed',
          backgroundColor: 'rgba(124, 58, 237, 0.25)',
          pointBackgroundColor: '#7c3aed',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7,
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 3000,
          easing: 'easeInOutCubic'
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: { size: 11, weight: '500' },
              padding: 15,
              usePointStyle: true
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffffff',
            bodyColor: '#ffffff',
            borderColor: '#374151',
            borderWidth: 1,
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.r + 'M';
              }
            }
          }
        },
        scales: {
          r: {
            beginAtZero: true,
            grid: { 
              color: '#f3f4f6',
              lineWidth: 1
            },
            angleLines: {
              color: '#f3f4f6',
              lineWidth: 1
            },
            pointLabels: {
              font: { size: 11, weight: '500' },
              color: '#6b7280'
            },
            ticks: {
              font: { size: 10 },
              color: '#6b7280',
              stepSize: 1
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'point'
        }
      }
    });
    } catch (error) {
      console.error('Error creating Cost Analysis chart:', error);
    }
  }

  // Regulatory Compliance Chart - Enhanced bar chart
  const complianceCtx = document.getElementById('complianceChart');
  if (complianceCtx) {
    try {
      new Chart(complianceCtx, {
        type: 'bar',
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              grid: { 
                color: '#f3f4f6',
                drawBorder: false
              },
              ticks: {
                font: { size: 10 },
                color: '#6b7280',
                callback: function(value) {
                  return value + '%';
                }
              }
            },
            x: {
              grid: { 
                color: '#f3f4f6',
                drawBorder: false
              },
              ticks: {
                font: { size: 10 },
                color: '#6b7280'
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        },
        data: {
          labels: ['SAMA Compliance', 'NCA ECC v2.0', 'PDPL Compliance', 'ISO 27001', 'SOC 2', 'GDPR'],
          datasets: [{
            label: 'Compliance Level (%)',
            data: [92, 78, 85, 88, 82, 75],
            backgroundColor: [
              'rgba(5, 150, 105, 0.8)',
              'rgba(5, 150, 105, 0.6)',
              'rgba(5, 150, 105, 0.7)',
              'rgba(5, 150, 105, 0.5)',
              'rgba(5, 150, 105, 0.6)',
              'rgba(5, 150, 105, 0.4)'
            ],
            borderColor: [
              '#059669',
              '#047857',
              '#065f46',
              '#064e3b',
              '#047857',
              '#065f46'
            ],
            borderWidth: 2,
            borderRadius: 4,
            borderSkipped: false,
            animation: {
              duration: 2000,
              easing: 'easeInOutQuart'
            }
          }]
        }
      });
    } catch (error) {
      console.error('Error creating Compliance chart:', error);
    }
  }
  
  // Final chart settlement check
  setTimeout(() => {
    const allCharts = Chart.instances;
    console.log(`Charts successfully initialized: ${Object.keys(allCharts).length} charts`);
    
    // Force chart resize to ensure proper rendering
    Object.values(allCharts).forEach(chart => {
      if (chart && typeof chart.resize === 'function') {
        chart.resize();
      }
    });
    
    console.log('All charts have been settled and are ready for display');
  }, 1000);
}

// Initialize charts when page loads
window.addEventListener('load', function() {
  // Initialize charts immediately when main content is shown
  if (document.getElementById('mainContent').style.display !== 'none') {
    initializeMarketTrendsCharts();
  }
});

// Also initialize charts when main content becomes visible
document.addEventListener('DOMContentLoaded', function() {
  // Check if main content is visible and initialize charts
  const mainContent = document.getElementById('mainContent');
  if (mainContent && mainContent.style.display !== 'none') {
    setTimeout(initializeMarketTrendsCharts, 500);
    // Also initialize digital stamp if main content is visible
    setTimeout(initializeDigitalStamp, 1000);
  }
});

// Fallback chart initialization with retry mechanism
function initializeChartsWithRetry(retryCount = 0) {
  const maxRetries = 5;
  
  try {
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => initializeMarketTrendsCharts(), 200);
      });
      return;
    }
    
    initializeMarketTrendsCharts();
  } catch (error) {
    console.error(`Chart initialization attempt ${retryCount + 1} failed:`, error);
    if (retryCount < maxRetries) {
      const delay = 1000 * Math.pow(2, retryCount); // Exponential backoff
      console.log(`Retrying chart initialization in ${delay}ms...`);
      setTimeout(() => initializeChartsWithRetry(retryCount + 1), delay);
    } else {
      console.error('Chart initialization failed after maximum retries');
    }
  }
}

// Additional fallback for when market trends section is opened
const originalToggleSection = window.toggleSection;
window.toggleSection = function(sectionId) {
  originalToggleSection(sectionId);
  
  if (sectionId === 'marketTrends') {
    setTimeout(() => {
      const chartsExist = document.querySelectorAll('canvas[id$="Chart"]');
      if (chartsExist.length > 0) {
        initializeChartsWithRetry();
      }
    }, 200);
  }
};

</script>
</html>
