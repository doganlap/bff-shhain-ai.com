name: CRUD Operations Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      threshold:
        description: 'CRUD completion threshold (%)'
        required: false
        default: '80'
        type: string

env:
  NODE_VERSION: '18'
  CYPRESS_VERSION: '13.6.0'

jobs:
  crud-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: grc_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm install -g cypress@${{ env.CYPRESS_VERSION }}

      - name: Setup test environment
        run: |
          cp .env.example .env.test
          echo "DATABASE_URL=postgresql://test_user:test_password@localhost:5432/grc_test" >> .env.test
          echo "NODE_ENV=test" >> .env.test

      - name: Run database migrations
        run: |
          cd apps/bff
          npm run migrate:test
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/grc_test

      - name: Start BFF server
        run: |
          cd apps/bff
          npm run start:test &
          sleep 10
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/grc_test
          PORT: 3001

      - name: Start frontend server
        run: |
          cd apps/web
          npm run build
          npm run preview &
          sleep 10
        env:
          PORT: 3000

      - name: Wait for services
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3001/api/health; do sleep 2; done'
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep 2; done'

      - name: Run CRUD audit tests
        run: |
          cd apps/web
          npm run test:crud-audit
        env:
          CYPRESS_BASE_URL: http://localhost:3000
          CYPRESS_API_URL: http://localhost:3001/api
          CYPRESS_SCREENSHOT_ON_RUN_FAILURE: true
          CYPRESS_VIDEO: true

      - name: Generate CRUD audit report
        run: |
          node scripts/generate-crud-audit-report.js \
            --format markdown \
            --threshold ${{ github.event.inputs.threshold || '80' }} \
            --output crud-matrix-audit-report.md

      - name: Run mock data detection
        run: |
          node scripts/detect-mock-data.js \
            --fail-on-error \
            --format markdown \
            --output mock-data-detection-report.md

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crud-audit-artifacts
          path: |
            apps/web/cypress/screenshots/
            apps/web/cypress/videos/
            apps/web/cypress/reports/
            crud-matrix-audit-report.md
            mock-data-detection-report.md
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read CRUD audit report
            let crudReport = 'CRUD audit report not found';
            try {
              crudReport = fs.readFileSync('crud-matrix-audit-report.md', 'utf8');
            } catch (e) {
              console.log('CRUD audit report not found');
            }
            
            // Read mock data detection report
            let mockDataReport = 'Mock data detection report not found';
            try {
              mockDataReport = fs.readFileSync('mock-data-detection-report.md', 'utf8');
            } catch (e) {
              console.log('Mock data detection report not found');
            }
            
            const comment = `## ðŸš€ CRUD Operations Audit Results\n\n${crudReport}\n\n## ðŸ” Mock Data Detection Results\n\n${mockDataReport}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Check CRUD completion threshold
        run: |
          # Extract overall score from report
          SCORE=$(grep -oP 'Overall Score: \K\d+' crud-matrix-audit-report.md || echo "0")
          THRESHOLD=${{ github.event.inputs.threshold || '80' }}
          
          echo "CRUD Completion Score: ${SCORE}%"
          echo "Required Threshold: ${THRESHOLD}%"
          
          if [ "$SCORE" -ge "$THRESHOLD" ]; then
            echo "âœ… CRUD audit PASSED with ${SCORE}% completion (threshold: ${THRESHOLD}%)"
            exit 0
          else
            echo "âŒ CRUD audit FAILED with ${SCORE}% completion (threshold: ${THRESHOLD}%)"
            exit 1
          fi

      - name: Check mock data detection
        run: |
          if grep -q "âœ… No mock data patterns detected" mock-data-detection-report.md; then
            echo "âœ… Mock data detection PASSED - no mock data found"
            exit 0
          else
            echo "âŒ Mock data detection FAILED - mock data patterns detected"
            exit 1
          fi

  generate-summary:
    needs: crud-audit
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: crud-audit-artifacts

      - name: Generate summary
        run: |
          echo "## ðŸ“Š CRUD Operations Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "crud-matrix-audit-report.md" ]; then
            echo "### CRUD Matrix Report" >> $GITHUB_STEP_SUMMARY
            cat crud-matrix-audit-report.md >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "mock-data-detection-report.md" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Mock Data Detection Report" >> $GITHUB_STEP_SUMMARY
            cat mock-data-detection-report.md >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¸ Screenshots and Evidence" >> $GITHUB_STEP_SUMMARY
          echo "Screenshots and videos have been uploaded as artifacts." >> $GITHUB_STEP_SUMMARY
          echo "Download them from the [Actions artifacts section](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})." >> $GITHUB_STEP_SUMMARY